\documentclass[draft,linenumbers]{agujournal}
\draftfalse

\journalname{Water Resource Research}

\usepackage{url}
%\usepackage[]{color}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\usepackage{rotating}
\usepackage{bm}

\begin{document}
\SweaveOpts{concordance=TRUE}

\title{Empirical study of land surface effects on local rainfall}

\authors{C. Liang \affil{1}, R.W. Vervoort \affil{1}, F.F. Van Ogtrop \affil{1}}

\affiliation{1}{Sydney Institute of Agriculture, School of Life and Environmental Sciences, The University of Sydney}
\correspondingauthor{R.W. Vervoort}{willem.vervoort@sydney.edu.au}


\begin{keypoints}
\item There are few empirical studies of vegetation feedback 
\item Two sites with major step trend landuse change were analysed
\item Statistical change in precipitation detected after bushfire
\end{keypoints}


\begin{abstract}
Empirical evidence of correlations between rainfall and land cover change are scarce due to multiple environmental factors that cannot be controlled. In this study we investigated the relationship using statistical methods on data from best available sources at two sites in Australia. Gridded data of rainfall and tree cover were used as spatially corresponding local conditions. Large scale effects were represented by climatic indicators, such as SOI and IOD. Regression analysis and step trend tests were used to assess the effect of abrupt land surface intervention. At a Queensland site, dramatic tree cover change between 2002 - 2005 did not result in statistically significant precipitation change. On the other hand, results from step trend test on 1998 - 2008 rainfall data in a bushfire affected NSW/VIC region has a better match with the tree cover change map. This indicates the method works better when a abrupt change in the data can be clearly identified. The results from the step trend test implied a positive relationship between the tree cover and the rainfall at 0.1 significance level. 
\end{abstract}

\section{Comments to answer by CL FvO and RWV}

\begin{itemize}
  \item comment 2: Do we have to explain why we don't include lag 1 autocorrelation in the model, or use mixed modelling?  
  \item comment 3: should we also report p $<$ 10\%? Now included
  \item comment 5: we seem to be mixing p $<$ 5\% and $\alpha < 0.05$. Changed, Chun can you please check?
\end{itemize}

\section{Introduction}

Land use and land cover changes can lead to changes in the local climate. Both empirical and modelling studies have found cloud types and rainfall are correlated to large scale vegetation cover changes, such as deforestation in the Amazon and in the Sahel \citep{Chagnon2005,Pinto2009, Wang2009, Mei2010, kucharski_further_2013,pitman_scale_2016} and afforestation in south Israel \citep{Otterman1990, Ben-Gai1998}. Using airborne measurement in Western Australia, \citet{Junkermann2009} showed a significantly higher level of aerosols over an agricultural area compared to an adjacent natural vegetation. They suggested that a modification of aerosol concentrations due to deforestation could have contributed to a reduction of local rainfall, as more but smaller rain droplets were observed. \citet{Nair2011} reported from the Bunny Fence Experiment in Western Australia that local land use change altered the synoptic west coast trough dynamics and surface roughness, and this resulted in the observed rainfall decrease. Climate sensitivity to land cover change is also found in eastern Australia \citep{McAlpine2007}. 

Rainfall over land is generally influenced by multiple factors. Locally, there are two main sources: moisture from advective atmospheric transport; and local evapotranspiration \citep{Eltahir1996,Bosilovich2006,Dirmeyer2009,Gimeno2010}. According to \citet{Trenberth1999}, the contribution of advective moisture partially depends on the availability of external moisture and atmospheric transport. On the longer time scale, such as monthly and annually, large scale atmospheric dynamics are affected by large scale climate drivers. Many studies have reported significant relationships between rainfall in large parts of Australia and the El Ni\~{n}o-Southern Oscillation (ENSO) \citep{Verdon2004,Risbey2009,Speer2011}. ENSO can be used to represent longer term cycles in rainfall data such as drought. On the other hand, local ET is determined by local land surface characteristics. Local land surface characteristics further influence local scale atmospheric dynamics and hence the amount of rainfall, including contribution from both sources. Therefore land surface plays an important role in local rainfall. 

Conventionally, large scale climate drivers are used as predictors for seasonal rainfall forecasts. According to the Australian Bureau of Meteorology (BoM), probablistic seasonal outlooks are developed based on Australian rainfall and temperature as well as sea surface temperature records from the tropical Pacific and Indian Oceans \citep{BoM2012c}. 

Different parts of the Australian continent can be more or less influenced by different climatic drivers \citep{Mla2008}. Using both SOI and PDO in a prediction model, \citet{Kamruzzaman2011} reported that PDO was rarely significant for rainfall stations in the MDB and on the southeast coast of Australia, while SOI was at least significant at the 1\% level. In addition to SOI, \citet{Speer2011} found that the observed rainfall decrease in the southeast of NSW was linked to an increasingly positive SAM in 1976 - 1998. In southwest WA, the influence of any oceanic indices is small \citep{Smith2012}.

Although climate drivers demonstrate some capability to predict Australian rainfall, there is still a large amount of unexplained variance. \citet{Westra2010} pointed out that models based on global sea surface temperature anomalies can only predict up to 14.7\% of precipitation variance. Recent studies suggest that land surface processes are important for predicting local rainfall \citep[e.g.][]{Ma2011,Zeng2012, pitman_scale_2016, saha_investigating_2016}. However, they are mostly based on modelling experiments and little evidence was reported from observations. \citet{Pitman2004} found a good match between observations and simulated rainfall changes in southwest Western Australia ,forced by land cover change. \citet{Timbal2006} were able to reproduce the rainfall decline in south west Australia by including land cover influence. Local land use change might not be a primary, but is likely to be a secondary cause of rainfall change \citep{Nicholls2006}. Therefore, land surface modification has, at least partially, contributed to local rainfall variability.

Overall the number of empirical studies related to changes to rainfall due to land cover change is limited. This is because there are some fundamental experimental difficulties in both space (where does evaporated water reappear as rainfall?) and in time (how much time does it take for land cover change effects to appear or disappear?). Therefore, the aim of this study is to use empirical evidence at regional scales to investigate the cause and effect relationship between land cover change and local rainfall using empirical evidence. More specifically, we hypothesize that a step change on the land cover on the surface will cause a step change in the rainfall and that this can be identified statistically. To demonstrate the approach and this effect we studied step changes in rainfall at two locations in Queensland and NSW/Victoria where there are possible step changes in land cover change due to land clearing and bushfires based on tree cover data. More specifically,  step changes in rainfall were identified statistically, which were subsequently associated with land cover change through spatial comparison.

In this paper, after this section (the introduction), section 2 covers the case study areas and the observed land use changed. Section 3 describes the data used in the study in more detail. Section 4 details the statistical methods and the underlying assumptions related to the modelling approach, Section 5 gives the results, which are further discussed in section 6 and finally section 7 offers the conclusions.  

\section{Study regions and tree cover change}

In Australia, significant tree cover change has mainly occurred in the north east of the continent and on the southeast coast, as well as in the southwest of Western Australia. According to the National Dynamic Land Cover Dataset (DLCD) \citep{Lymburner2010}, most of these areas have experienced decreasing EVI between 2000 - 2008. Being a vegetation greenness index, the decreasing EVI values indicate lower biomass over time in the tree cover regions. The EVI reduction is possibly due to land clearing, bushfires or drought. 

%figure 1
\begin{figure}[ht!]
  \centerline{\includegraphics[height = 4in,scale=0.5]{map_selreg.jpg}}
  \caption{Selected study regions are highlighted by red rectangles in the main map (the red rectangle in the insert indicates the location of the main map). The types of tree cover in 2008 from the DLCD product is shown at the background. In site 1 (the QLD region), the tree cover is mostly sparse. In site 2 (the NSW/VIC region), many areas have open or close forest in which tree cover is denser.}
  \label{fig:sel_reg}
\end{figure}

Two regions were selected where significant tree cover change was present. One region is located in south central Queensland to the north of the Murray Darling Basin (MDB) (site 1 in Figure~\ref{fig:sel_reg}). High rates of land clearing have been reported in this region during the early 2000s \citep{SLATS2004}. The second study region is located at the border of New South Wales and Victoria, including the Snowy Mountains range (site 2 in Figure~\ref{fig:sel_reg}). Severe bushfires occurred in this area and the surroundings in early 2003 (see Figure~\ref{fig:bushfire}). The 2003 bushfires were the largest and the worst in this area for the last 60 years \citep{Fire2011}. Two thirds of Kosciuszko national park was heavily burned and regrowth was reported to be slow due to drought and cold conditions \citep{ABC2003} and the type of species in this region. In both study regions, significant tree cover loss has happened in the last decade, either permanently or temporarily.

%figure 2
\begin{figure}[ht!]
  \centerline{\includegraphics[height=4in, clip, scale=0.6]{bushfire_nswvic.pdf}}
  \caption{Location of bushfires occurring in January 2003, in and around the NSW/VIC study region, as shown by the red pixels. The map shows large area in the Kosciuszko national park has been burned. Some locations in the southwest of ACT have also experienced intensive bushfires.}
  \label{fig:bushfire}
\end{figure}

The two regions have different climate characteristics. The QLD region is partially grassland and partially subtropical, while the NSW/VIC region is mainly within the temperate zone, under the K\"{o}ppen classification. According to Australian Bureau of Meteorology (BoM), the NSW/VIC region receives 1000 - 2000 mm rainfall annually, which is more than double of the rainfall in the QLD region. Evapotranspiration is similar in both regions. Marine moisture and orographic effects are likely to be the main contributors to rainfall in the southeast mountain areas of the NSW/VIC region. 

The land use and land cover characteristics in the two regions are also different. In the Queensland region, the tree cover is sparse over most of the area. The MODIS satellite tree cover data (discussed in more detail in section 3) shows that tree cover in this region is generally below 20\% of total ground area. Grazing is the main activity in this region, with over 90\% of land used by the grazing industry \citep{ABARES2010}. Our starting assumption is that the main cause of the EVI  decline over large part of the region is due to land clearing. Tree cover has been cleared at a massive scale over the last decade, especially during 2002 - 2004.  

The Kosciuszko national park is within the NSW/VIC region. Here tree cover is denser with open or closed forest (the tree cover distribution is bimodal at 10 - 20\% and 60 - 70\%). The dominant species in the alpine area are Snow Gum and large stand species such as Alpine Ash and Mountain Gum in the sub-alpine area. These trees can reach a great height but they take long time to grow. For example, Alpine Ash would need about 20 years to mature. Although land clearing is not a major issue in this region, it is vulnerable to fires and drought. 

Therefore two types of land cover changes were studied. The reports from the Queensland Statewide Land Cover and Trees Study (SLATS) \citep[e.g.][]{SLATS2001,SLATS2003} were used to investigate the time and location of land clearing in the QLD region. The MODIS burned area product, MCD45A1 \citep{Roy2002,Roy2005,Roy2008}, was used to locate bushfires areas in the NSW/VIC region, with a grid resolution of 500 m. MCD45A1 provides monthly burning information on all pixels, which helps to pinpoint an abrupt event. Due to the nature of the different land cover change, the post-change vegetation status in the two regions is expected to be different (see Figure~\ref{fig:tc_simple}). 

%figure 3
\begin{figure}[ht!]
  \centerline{\includegraphics[scale=0.65]{tc_simple.pdf}}
  \caption{The expected evolution of the land surface after trees have been removed in (a) the QLD region and (b) the NSW/VIC region.}
  \label{fig:tc_simple}
\end{figure}

<<mapping,eval=F, echo = F, results = hide>>=

library(plotKML)
library(raster)
library(rgeos)
library(maptools)
library(fields)
library(RColorBrewer)
  
## define the boundary of sub-regions
  e1 <- extent(c(1324304.091,1723901.773,-222556.668,80451.265))
  # 400 km by 303 km Qld
  e2 <- extent(c(1346395.141,1534425.527,-1169402.246,-607644.171))
  # 188 km by 561 km NSW
  e11 <- extent(c(145.425, 149.025, -28.475, -25.175))
  e22 <- extent(c(146.675, 149.325, -37.075, -34.675))

  e111 <- extent(c(145.825, 148.625, -28.075, -25.575)) #as(tc_r1,"SpatialPolygons")
  # 306 km by 273.5 km
  e222 <- extent(c(147.075, 148.925, -36.675, -35.075)) #as(tc_r2,"SpatialPolygons")
  # 203 km by 175 km
## the selected regions for mapping

  aus_reg <- readShapePoly("Data\\Geo\\aus_state2011\\simplify_state11_uproj.shp",proj4string=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0"))
  aus_reg2 <- gSimplify(aus_reg,0.01,topologyPreserve=T)
  
  mdb_reg <- readShapePoly("Data\\Geo\\MDB\\mdb.shp",proj4string=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0"))
mdb_reg2 <- gSimplify(mdb_reg,0.01,topologyPreserve=TRUE)

  remove(list=c("aus_reg","mdb_reg"))

## Burned area map

fire_0301 <- raster("Data\\Other\\bushfires\\Burnt_Area\\tmpA2003001.burndate.tif")
fire_0301nsw <- crop(fire_0301,e2)
fire_loc <- crop(reproject(fire_0301nsw,CRS=CRS("+proj=longlat +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84")),e222)
remove(list=c("fire_0301","fire_0301nsw"))

  pdf("bushfire_nswvic.pdf")
#  jpg("bushfire_nswvic.jpg")
  par(mar=c(3,3,1,6),xpd=T)
  plot(e222,border="white")  
  image(fire_loc,add=T, breaks=c(0,0.99,366.5,10000),col=c("white","red","white"))
  plot(e222,add=T)
  plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
#   text(1430000,-1000000,"study region",cex=1.2)
  text(149.1, -35.3,"ACT",font=2,cex=1.2)
  text(148.4, -36,"Kosciuszko",font=2,cex=0.9)#,srt=90)
  text(147.5, -36.4,"VIC",font=2,cex=1.2)
  text(148, -35.5,"NSW",font=2,cex=1.2)
  image.plot(zlim=c(0,1),breaks=c(0,0.5,1),lab.breaks=c("","burned \narea",""),legend.only=T,horizontal=F,col=c("red","red"),legend.shrink=0.03,legend.width=1.3,legend.args=list(text="",line=0),lwd.poly=0.1)
legend(149,-36.1,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=0.9)
 dev.off()

@

<<treeCover,eval=F , echo = F, results = hide>>=

## trend of evi (MODIS product) from GA and ABARES

## tree cover data
  mod44_tc <- brick("Data\\Satellite\\MOD44\\B\\mod44_tc_aus.tif")
  tm <- seq(as.Date("2000-03-06"), as.Date("2010-03-06"), "year")
  mod44_tc <- setZ(mod44_tc, tm, "year")
  
## tree cover in sub-region
  mod_tc_r11 <- crop(mod44_tc,e1)
  mod_tc_r111 <- reproject(mod_tc_r11,CRS=CRS("+proj=longlat +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84"))
  mod_tc_r1 <- crop(mod_tc_r111,e111)

  mod_tc_r22 <- crop(mod44_tc,e2)
  mod_tc_r222 <- reproject(mod_tc_r22,CRS=CRS("+proj=longlat +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84"))
 mod_tc_r2 <- crop(mod_tc_r222,e222)

 remove(list=c("mod44_tc","mod_tc_r11","mod_tc_r111","mod_tc_r22","mod_tc_r222"))
  
## apply t-test to tree cover data
  fun <- function(x,m) {
    var_x <- sd(x)
    mu_1 <- mean(x[1:3])
    if (m==1) {y <- x[6:11]} else {y <- x[4:11]}   
    mu_2 <- mean(y)
    z <- (mu_2-mu_1)/var_x
    if (!is.na(z) & abs(z)>qt(0.1,length(z))) {return(y[1]-x[3])} else {return(NA)}
  }
  
  mod_tc_r1.z <- calc(mod_tc_r1,function(x) fun(x,1))
  mod_tc_r2.z <- calc(mod_tc_r2,function(x) fun(x,2))

  remove(list=c("mod_tc_r1","mod_tc_r2"))

  
## create plots
  plotclr <- brewer.pal(6,"PiYG")
#"#C51B7D" "#E9A3C9" "#FDE0EF" "#E6F5D0" "#A1D76A" "#4D9221"

  pdf("tc.pdf", width=10, height= 5)
  par(mar=c(3,3,1,7), mfrow=c(1,2))
  plot(e111)
  image(mod_tc_r1.z,col=plotclr,breaks=c(-70,-50,-20,0,20,50,70),legend=F,add=T)
  plot(e111,add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  image.plot(zlim=c(-3,3),breaks=c(-3,-2,-1,-0.2,0.2,1,2,3),lab.breaks=c(-70,-50,-20,"no tree","0 or",20,50,70),legend.only=T,horizontal=F,col=c("#C51B7D","#E9A3C9","#FDE0EF","white","#E6F5D0","#A1D76A","#4D9221"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text=expression(paste(Delta,"tree (% ground)",sep="")),line=0.5,cex=0.9,font=2),axis.args=list(cex.axis=0.8),graphics.reset=F)
  text(146.0, -25.6, "(a)", font=2)
  plot(e222)
  image(mod_tc_r2.z,col=plotclr,breaks=c(-70,-50,-20,0,20,50,70),legend=F,add=T)
  plot(e222,add=T)
  plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  text(147.2, -35.1, "(b)", font=2)
  dev.off()

pdf("map.pdf")
par(mar=c(1.5,1.5,1.5,1.5))
plot(mdb_reg2,border="grey",lwd=3)
plot(aus_reg2,border="grey",add=T)
legend(150.2,-36,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=0.9)
#invisible(text(getSpPPolygonsLabptSlots(aus_reg2), labels=as.character(aus_reg2$NAME), cex=0.7,adj=0.5))
box(lty=1)
plot(e111,col="red",add=T)
plot(e222,col="red",add=T)
text(147.2,-26.8,"QLD",cex=1.5)
text(148,-34.7,"NSW/VIC",cex=1.5)
dev.off()

@

Specifically, this study focused on the effect of 2003 - 2004 land clearings in the QLD region and the effect of 2003 bushfires in the NSW/VIC region. These events are expected to cause a step change in the local rainfall. The actual tree cover change at the pixel level during this time was derived from the 11-year MODIS data (discussed below). The difference of tree cover before and after the land disturbance was tested using a Student's t-test. As the length of the tree cover data is shorter than the length of the rainfall data, earlier land clearings in the QLD region cannot be identified spatially, hence they are excluded from the analysis.

\section{Data}
\label{sec:Data}

Two land surface data sets were used in this study. The main one was the MOD44B product Global Vegetation Continuous Field dataset (version 5). This dataset provides estimates of percent tree cover (percentage of ground surface covered by trees) at a grid resolution of 250 m \citep{Townshend2011}, which is finer then the earlier mentioned burned product MCD45A1. The dataset is available on an annual time interval for the period of 2000 - 2010. The National Dynamic Land Cover Dataset (DLCD) \citep{Lymburner2010} from the Australian Collaborative Land Use Mapping Program (ACLUMP) was used to verify the trend of vegetation cover change calculated from the previous dataset. This dataset, developed by Geoscience Australia and Australian Bureau of Agricultural and Resource Economics and Sciences (ABARES), is the first nationally consistent and thematically comprehensive land cover reference for Australia. The DLCD is based on the 16-day Enhanced Vegetation Index (EVI), again from the MODIS satellite, between April 2000 and April 2008. It also has a grid resolution of 250 m. The dataset provides information on the final land cover types (as in 2008) and estimated trend of EVI statistics (annual mean, maximum and minimum). 

Rainfall data for Australia \citep{Jones2009} was obtained from BoM. The data has been projected onto a national 0.05\textdegree $\times$ 0.05\textdegree grid (approximately 5 km $\times$ 5 km). This gridded dataset was generated from station observations using an optimised Barnes successive correction technique. The Barnes technique combines a weighted averaging process and defined topographical information to estimate rainfall values between spatial points \citep{BoM2009}. The resulting dataset provides additional information for data-sparse areas like central Australia but reduces information in the data-rich areas, such as southeast Australia where station density is up to 20 per 100 km$^2$. The data is available on a monthly basis from 1900 to current. Here a subset of 30 years (1979 - 2008) was used. The study was conducted on monthly data, as a land cover change effect on annual rainfall might be negligible but can often found to be significant in particular months or seasons \citep[e.g.][]{Otterman1990,Gaertner2001,Semazzi2001,Oleson2004,Deo2009}. 

Large scale climate drivers are represented by various climatic indices. The Southern Oscillation Index (SOI) is generally regarded as a good predictor for Australian rainfall \citep{Risbey2009,Chowdhury2010,Westra2010}, but its skill is weaker in some parts of Australia. For example the Southern Annular Mode (SAM) is found to be more important than ENSO in south Western Australia \citep{Meneghini2007}. The suitability of each index for the study regions is analysed in detail in section \ref{sec:reg_model}. The following climate indices were tested as predictors for local rainfall. 
\begin{itemize}
  \item Southern Oscillation Index (SOI). The Troup version of the monthly SOI series used in this study was obtained from BoM (available online at \url{http://www.bom.gov.au/climate/current/soihtm1.shtml}).
  \item Eastern, East Central and Central Tropical Pacific Sea Surface Temperatures (NINO 3, NINO 3.4 and NINO 4). Monthly SST anomalies are available from IRI/LDEO data library and the extended NINO dataset is used (available online at \url{http://iridl.ldeo.columbia.edu/SOURCES/.Indices/.nino/.EXTENDED/}).
  \item Pacific Decadal Oscillation (PDO). The Pacific Decadal Oscillation is the leading principal component of monthly SST anomaly in the North Pacific Ocean.. The monthly PDO series was provided by JISAO (Joint Institute for the Study of the Atmosphere and Ocean, University of Washington) (available online at \url{http://jisao.washington.edu/pdo/PDO.latest}).
  \item The interaction of PDO and SOI (PDO$\times$SOI) \citep{Kamruzzaman2011}.
  \item Indian Ocean Dipole (IOD). The Indian Ocean dipole is commonly measured by the difference between SST anomaly in the western (50 - 70\textdegree E and 10\textdegree S-10\textdegree N) and eastern (90 - 110\textdegree E and 0 - 10\textdegree S) equatorial India Ocean \citep{Saji1999}. Monthly IOD was obtained from JAMSTEC (the Japan Agency for Marine-Earth Science and Technology) (available online at \url{http://www.jamstec.go.jp/frcgc/research/d1/iod/DATA/dmi.monthly.txt}).
\end{itemize}


<<climaticIndex,eval=F , echo = F, results = hide>>=

library(reshape)
library(chron)
library(fields)
library(rgdal)
library(raster)
library(maptools)
library(graphics)
library(zoo)
library(RColorBrewer) # creates nice color schemes
# library(classInt)     # finds class intervals for continuous variables

library(mgcv)
library(ncdf4)
library(nnet)

## climatic indicator data

file1 <- "Data\\BoM\\SOI\\SOI.csv"
SOI <- read.csv(file1,sep=",",skip=6)
SOI <- melt(SOI,id="Year")
names(SOI) <- c("Year","Month","SOI")
SOI <- SOI[order(SOI$Year,SOI$Month),]
SOI_ts <- ts(SOI$SOI,start=c(1876,1),end=c(2014,4),frequency=12)
SOI_100a <- window(SOI_ts,start=c(1900,1),end=c(2008,12))
SOI_30a <- window(SOI_ts,start=c(1979,1),end=c(2008,12))
## deseasonalised SOI
SOI_100 <- stl(SOI_100a,"period")$time.series[,3]+stl(SOI_100a,"period")$time.series[,2]
SOI_30 <- stl(SOI_30a,"period")$time.series[,3]+stl(SOI_30a,"period")$time.series[,2]

file2 <- "Data\\BoM\\SST\\SST34.cdf"
SST34 <- nc_open(file2)
SST34 <- ncvar_get(SST34,SST34$var[[1]])
SST34_ts <- ts(SST34,start=c(1856,1),end=c(2014,4),frequency=12)
SST34_30a <- window(SST34_ts,start=c(1979,1),end=c(2008,12))
## deseasonalised SST34
SST34_30 <- stl(SST34_30a,"period")$time.series[,3]+stl(SST34_30a,"period")$time.series[,2]

file3 <- "Data\\BoM\\SST\\SST3.cdf"
SST3 <- nc_open(file3)
SST3 <- ncvar_get(SST3,SST3$var[[1]])
SST3_ts <- ts(SST3,start=c(1856,1),end=c(2014,4),frequency=12)
SST3_30a <- window(SST3_ts,start=c(1979,1),end=c(2008,12))
## deseasonalised SST34
SST3_30 <- stl(SST3_30a,"period")$time.series[,3]+stl(SST3_30a,"period")$time.series[,2]

file4 <- "Data\\BoM\\SST\\SST4.cdf"
SST4 <- nc_open(file4)
SST4 <- ncvar_get(SST4,SST4$var[[1]])
SST4_ts <- ts(SST4,start=c(1856,1),end=c(2014,5),frequency=12)
SST4_30a <- window(SST4_ts,start=c(1979,1),end=c(2008,12))
## deseasonalised SST4
SST4_30 <- stl(SST4_30a,"period")$time.series[,3]+stl(SST4_30a,"period")$time.series[,2]

file5 <- "Data\\BoM\\PDO\\PDO.latest_1900-.txt"
pdo_mth <- read.csv(file5,sep="",header=T)
pdo_mth <- melt.data.frame(pdo_mth,id="YEAR")
names(pdo_mth) <- c("Year","Month","PDO")
pdo_mth <- pdo_mth[order(pdo_mth$Year,pdo_mth$Month),]
PDO_ts <- ts(pdo_mth$PDO,start=c(1900,1),end=c(2014,4),frequency=12)
PDO_100a <- window(PDO_ts,start=c(1900,1),end=c(2008,12))
## deseasonalised PDO
PDO_100 <- stl(PDO_100a,"period")$time.series[,3]+stl(PDO_100a,"period")$time.series[,2]

file7 <- "Data\\BoM\\IOD\\iod_jamstec.txt"
IOD <- read.csv(file7,sep="",header=T)
IOD <- IOD[,4]
IOD_ts <- ts(IOD,start=c(1870,1),frequency=12)
IOD_30a <- window(IOD_ts,start=c(1979,1),end=c(2008,12))
## deseasonalised IOD
IOD_30 <- stl(IOD_30a,"period")$time.series[,3]+stl(IOD_30a,"period")$time.series[,2]
# end of read data


@


\section{Statistical method}

As shown in Figure~\ref{fig:ts_mean}, a step change is not obvious in the time series data, even though the data is deseasonalised and detrended. Hence, the step changes in the rainfall were analysed using two different statistical methods to provide a comparison. Both methods make use of a regression model to remove variability in rainfall hypothesised to be caused by factors other than vegetation cover change. In the first method, the tree cover change was implemented as a factor variable in the regression model. In the second method, a rank sum test (step trend test), was applied to the model residuals after effects of other major factors have been removed, assuming that vegetation cover change is the only factor explaining the non-random pattern in the rainfall residuals.

%figure 4
\begin{figure}[ht!]
  \centering
  \includegraphics{mean_ts.pdf}
  \caption{The deseasonalised and detrended rainfall over the 30 years period in (a) the QLD region and (b) the NSW/VIC region. The vertical red lines indicate the year of 2003, in which the studied land cover changes occurred. A change in the time series data is not obvious before and after the land cover changes.}
  \label{fig:ts_mean}
\end{figure}

\subsection{Regression model}
\label{sec:reg_model}

Rainfall is generally affected by several factors. Many studies suggest the large-scale climate drivers, which are related to the global or regional atmospheric air mass movement, are the dominant control on the overall rainfall \citep{Maynard2003,DeAngelis2010,Holper2011,Smith2012}. Long term trends are shown in Australian rainfall, and this has been linked to global climate change \citep{cai_did_2014,Delworth_regional_2014, Holper2011, karoly_climate_2014}.
The difference in available radiation and hence ET in different seasons increase the variability in rainfall. The land surface effect on rainfall can be confused by changes in these factors. Hence a regression model was used to estimate the amount of variability in rainfall that is due to these important factors, and isolate changes resulting from local vegetation cover change.
As highlighted in the introduction, the Australian climate is influenced by sea surface temperature in the tropical Pacific and Indian Oceans, as well as pressure systems in the Southern Ocean \citep{BoM2012}.  \citet{Risbey2009} compared five large-scale drivers, including ENSO (measured by SOI and the Tropical Pacific SSTs), IOD, SAM, MJO\footnote{MJO is a large scale eastward-propagating wave-like disturbance in equatorial latitudes \citep{Risbey2009}.} (Madden-Julian oscillation) and blocking, in relation to Australian rainfall variability. They identified SOI as the most important index among all indices tested for broad parts of Australia (including QLD and NSW/VIC) in almost any season. In this study, up to two important indices identified from the seven climatic indicators (see section \ref{sec:Data}) were used, for each study region, as the explanatory variables in the model .

<<rainData,eval=F , echo = F, results = hide>>=

## 100 years awap data & 30 years
qld_100 <- read.csv("Data\\BOM\\rainfall\\QLD_month_rf.csv",header=T)
qld_30 <- subset(qld_100,as.Date(qld_100[,1],"%d/%m/%Y")>="1979-01-01" & as.Date(qld_100[,1],"%d/%m/%Y")<="2008-12-01")
qld100_mean <- ts(rowMeans(qld_100[,2:2801],na.rm=T,dims=1),start=c(1900,1),frequency=12)
qld30_mean <- window(qld100_mean,start=c(1979,1),end=c(2008,12))

nsw_100 <- read.csv("Data\\BOM\\rainfall\\NSW_month_rf.csv",header=T)
nsw_30 <- subset(nsw_100,as.Date(nsw_100[,1],"%d/%m/%Y")>="1979-01-01" & as.Date(nsw_100[,1],"%d/%m/%Y")<="2008-12-01")
nsw100_mean <- ts(rowMeans(nsw_100[,2:1185],na.rm=T,dims=1),start=c(1900,1),frequency=12)
nsw30_mean <- window(nsw100_mean, start=c(1979,1),end=c(2008,12))

require(MASS)
fitdistr(qld30_mean,"gamma")  ## assume shape=1
fitdistr(nsw30_mean,"gamma")  ## assume shape =8
ks.test(qld30_mean,1,0.03)
ks.test(nsw30_mean,2.4,0.03)

pdf("hist_rain.pdf", width=8, height = 5)
par(mfrow=c(1,2))
 hist(qld30_mean,main="",xlab=expression(paste("rainfall (mm mont",h^-1,")",sep="")))
 text(200,120,"(a)", font=2)
 hist(nsw30_mean,main="",xlab=expression(paste("rainfall (mm mont",h^-1,")",sep="")))
text(200,60,"(b)", font=2)
dev.off()

  
## autocorrelation in rainfall
pdf("autocorrelation.pdf")
par(mfrow=c(2,2))
  acf(qld30_mean,lag.max=12,main="QLD")
  acf(nsw30_mean,lag.max=12,main="NSW & VIC")

  pacf(qld30_mean,lag.max=12,main="")
  pacf(nsw30_mean,lag.max=12,main="")  
dev.off()
  
## deseasonalise & detrend rainfall: assume the deseasonalised monthly zonal rainfall is normal distributed and can be used in pearson cross-correlation function
## use stl function in R
  qld30_deseason <- stl(qld30_mean,s.window=length(qld30_mean),t.window=length(qld30_mean))$time.series[,3]
  nsw30_deseason <- stl(nsw30_mean,s.window=length(nsw30_mean),t.window=length(nsw30_mean))$time.series[,3]
  qld100_deseason <- stl(qld100_mean,s.window=length(qld100_mean),t.window=length(qld100_mean))$time.series[,3]
  nsw100_deseason <- stl(nsw100_mean,s.window=length(nsw100_mean),t.window=length(nsw100_mean))$time.series[,3]

pdf("mean_ts.pdf",width=8,height=4)
par(cex.lab=1,cex.axis=1,mfrow=c(1,2))
plot(qld30_deseason,xlab="Year",ylab="monthly rainfall")
abline(v=2003,col="red",lwd=2)
text(2004.6,150,"2003",cex=1.2,col="red")
text(1980.6,200,"(a)",font=2, cex=1.2)
plot(nsw30_deseason,xlab="Year",ylab="monthly rainfall")
abline(v=2003,col="red",lwd=2)
text(2004.6,120,"2003",cex=1.2,col="red")
text(1980.6,150,"(b)", font=2,cex=1.2)
dev.off()
 
# Figure 5
pdf("cor_qld.pdf", width = 8, height = 8)
par(mfrow=c(2,3),mar=c(5,4,1,1))
ccf(as.vector(SOI_30),as.vector(qld30_deseason),lag.max=12,xlim=c(-12,0),xlab="SOI  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(SST34_30),as.vector(qld30_deseason),lag.max=12,xlim=c(-12,0),xlab="NINO3.4  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(SST4_30),as.vector(qld30_deseason),lag.max=12,xlim=c(-12,0),xlab="NINO4  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(PDO_100),as.vector(qld100_deseason),lag.max=24,xlim=c(-24,0),xlab="PDO Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(PDO_100*SOI_100),as.vector(qld100_deseason),lag.max=12,xlim=c(-12,0),xlab="PDO*SOI  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(IOD_30),as.vector(qld30_deseason),lag.max=12,xlim=c(-12,0),xlab="IOD  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
dev.off()

pdf("cor_nswvic.pdf",width = 8, height = 8)
par(mfrow=c(2,3),mar=c(5,4,1,1))
ccf(as.vector(SOI_30),as.vector(nsw30_deseason),lag.max=12,xlim=c(-12,0),xlab="SOI  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(SST34_30),as.vector(nsw30_deseason),lag.max=12,xlim=c(-12,0),xlab="NINO3.4  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(SST4_30),as.vector(nsw30_deseason),lag.max=12,xlim=c(-12,0),xlab="NINO4  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(PDO_100),as.vector(nsw100_deseason),lag.max=24,xlim=c(-24,0),xlab="PDO Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(PDO_100*SOI_100),as.vector(nsw100_deseason),lag.max=12,xlim=c(-12,0),xlab="PDO*SOI  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
ccf(as.vector(IOD_30),as.vector(nsw30_deseason),lag.max=12,xlim=c(-12,0),xlab="IOD  Lag",ylab="CCF",cex.axis=1.2,cex.lab=1.3)
dev.off()

  
@

As a preliminary step, the correlations between rainfall and each climatic index were analysed. Rainfall in each study region was first deseasonalised and detrended using the seasonal decomposition function "stl" in R \citep{Rstats2011}. Detrending is needed to remove the correllations between trends in the data as discussed in \citet{Smith2012}. 
The cross-correlations between the deseasonalised and detrended rainfall and the climatic indices were tested using the Pearson's product moment correlation method, assuming the relationships are linear. Although the optimal technique for exploring the correlation with each index could be different as described in \citet{Risbey2009}, the Pearson's method was applied to all indices for consistency. Because the PDO is a low frequency descriptor of the multi-decadal SST  \citep{MacDonald2005,Zanchettin2008,Kamruzzaman2011} a longer period (108 years, from 1900 to 2008), instead of 30-year rainfall data, was used to estimate the correlation with PDO, up to lag 24. For the other indices, the 30-year rainfall data set was used. 

%figure 5
\begin{figure}[ht!]
\centering
\includegraphics[scale=0.6]{cor_qld.pdf}
 \caption{Cross-correlation of the six indices and rainfall in QLD study region. Where the correlations with PDO are sought, 108-year rainfall data (1900 - 2008) are used. Otherwise, 30-year rainfall data are used. The correlation with NINO 3 is not shown as it is very similar to but weaker than the case of NINO 3.4. The blue dashed lines indicate the 95\% confidence interval.}
  \label{fig:cor_rain_qld}
\end{figure}

%figure 6
\begin{figure}[ht!]
\centering
\includegraphics[scale=0.6]{cor_nswvic.pdf}
 \caption{Cross-correlation of the six indices and rainfall in NSW/VIC study region.}
  \label{fig:cor_rain_nsw}
\end{figure}


Based on the correlation between the climatic indices and rainfall (as shown in Figure~\ref{fig:cor_rain_qld} and Figure~\ref{fig:cor_rain_nsw}), the following results were found:
\begin{itemize}
  \setlength{\itemsep}{0cm}
  \setlength{\parskip}{0cm}
  \item In QLD, the correlation between rainfall and SOI at zero time lags is the highest across all indices, outweighing the other ENSO indicators. 
  \item In NSW/VIC, again the SOI has the highest correlation with rainfall, closely followed by the IOD. Both occur at the zero time lags. 
\end{itemize}
The above findings are consistent with previous studies. Although some indices are serially correlated with rainfall up to several months, the lag zero events have the most significant correlation coefficients. Concurrent climatic index series were generally found most useful in rainfall prediction \citep[e.g.][]{Risbey2009,Kamruzzaman2011}. The correlations between the climatic indices and rainfall for each individual season have also been tested. SOI was used in the Qld prediction, SOI and IOD were used in the NSW/VIC prediction.   

Rainfall in Australia shows strong seasonal patterns \citep{Holper2011,ABS2012}. For example, the north part of the country is summer rainfall dominant with dry winter, while most of the southern part has a winter rainfall regime. This character is given by the movement of subtropical high pressure system which dominates the Australian climate \citep{BoM2012a}. The seasonal component of rainfall has a periodic pattern so it is better modelled as a smooth term. A spline function was applied on the months to define a smooth seasonal pattern \citep{Wood2011}. %The spline function ``s" in R was used .

Long term trends in the regional rainfall in some parts of Australia are significant \citep{Hughes2003,Gallant2007,Chowdhury2010}. In the northern and eastern parts of the continent, increasing rainfall is reported over the last century \citep{Hughes2003}. The presence of such long term trends may be confused with the outcome of a step change in rainfall. A linear trend term was implemented in the model to remove any long term trend effect. 

We assumed all the factors are additive components in determining rainfall as in \citet{Kamruzzaman2011}. Generally, monthly rainfall has a skewed distribution so the normality assumption of the residuals in a general linear model could be violated. In this case, the rainfall model is expressed as a generalised additive model (GAM) \citep{Hastie1986} with a log link function g(), assuming the residuals are gamma distributed (see Figure~\ref{fig:hist_rain}).
\vspace{0.5cm}
\begin{linenomath*}
  \begin{equation}
  g(E(\mathbf{R}_r)) = \beta_0 + s_1(D_{1,r}\mathbf{SOI}) + s_2(D_{2,r}\mathbf{IOD}) + s_3(\mathbf{Season}) + \beta_1\mathbf{Trend} + \boldsymbol{\epsilon}_r
    \label{eqn:model}
  \end{equation}
\end{linenomath*}
The bold letters represent the time series vectors. The subscript $r$ denotes the region, $r=$qld or nswvic. $\beta_u$ ($_u$=0, 1) are the fitted coefficients in the model. $s_v$ ($_v$=1, 2, 3) are the smooth functions on the climatic indices and the season. $D_{1,r}$ and $D_{2,r}$ switch on/off the corresponding climatic index in the model as discussed previously. 
\begin{linenomath*}
  \begin{equation}
    D_{1,r} = 1 
  \end{equation}
\end{linenomath*}
as SOI was used in both regions as rainfall predictor.
\begin{linenomath*}
  \begin{equation}
    D_{2,r} = \left\{ \begin{array}{ll}
     1 &\mbox{for NSW/VIC } \\
     0 &\mbox{for QLD}
    \end{array} \right.
    \label{eqn:dummyD}
  \end{equation}
\end{linenomath*}
The linear long term trend in the rainfall data is modelled by \textbf{Trend}=1,2,3...n, where n is the total number of months in the time series. \textbf{Season} is the seasonal component which is represented by applying a smooth spline function on the month values (1-12. The monthly rainfalls in both regions appear to have a lag 1 autocorrelation, being 0.26 for QLD and 0.33 for NSW/VIC. 
The SOI and IOD terms are also modelled with spline functions. As the effect of large scale drivers on Australian rainfall is more likely to be seasonal \citep{Murphy2008,Schepen2012}, the spline function can closely reproduce the high and low impacts of the climatic indices.

%figure 7
\begin{figure}[ht!]
  \centering
  \includegraphics[scale=0.6]{hist_rain.pdf}
  \caption{Distribution of monthly rainfall in (a) QLD and (b) NSW/VIC. By using a Kolmogorov-Smirnov test with shape = 1 and 2.4 respectively, rainfalls in both regions are shown to have a gamma distribution.}
  \label{fig:hist_rain}
\end{figure}

\subsection{Tree cover change as factor variable}

One of the main difficulties in empirical observation studies on the effect of land cover change on rainfall is the lack of continuous monitoring of land surface variables, or even, no specific variable can be defined to clearly represent the land surface process. Given the lack of a full picture of the land surface process, a factor variable was used in this study to represent the abrupt land surface change (see Equation~\ref{eqn:model2}). The change could be a result of either land clearing or bushfires as long as it is permanent or takes a long time to recover. Here we approached the problem with two different models.

In the first method, the tree cover change was used as a predictor in the regression model, represented by a factor variable \textbf{LC}. The significance of the coefficient of \textbf{LC}, denoted as $\beta'_2$ in Equation~\ref{eqn:model2}, can be determined by a ratio test.
\begin{linenomath*}
  \begin{equation}
    \mbox{LC} = \left\{ \begin{array}{ll}
       \mbox{Trees} \\
       \mbox{Removed}
    \end{array} \right.
    \label{eqn:dummyC}
  \end{equation}
\end{linenomath*}
Therefore in both regions, land cover is ``trees" for the period before land cover change and ``removed" for the period after the change. Here we simply assumed that vegetation cover change has occurred on every pixel. The remaining term $\epsilon_r$ is the amount of rainfall that is attributed to other unspecified factors and random errors. Hence the regression model becomes
\vspace{0.5cm}
%\begin{dmath}
\begin{linenomath*}
\begin{equation}
g(E(\mathbf{R}_r)) = \beta'_0 + s'_1(D_{1,r}\mathbf{SOI}) + s'_2(D_{2,r}\mathbf{IOD}) + s'_3\mathbf{Season} + \beta'_1\mathbf{Trend} + \beta'_2\mathbf{LC} + \boldsymbol{\epsilon'}_r
  \label{eqn:model2}
\end{equation}
\end{linenomath*}

Vegetation cover changes occurred at different times in the two regions. In the QLD region, there no exact time can be assigned to the land clearing. Clearing has occurred between 2003 - 2004 according to SLATS reports. The information on the change in type of land cover during this time period is missing. Therefore, four scenarios were tested in the analysis. In these scenarios the ``after change" period started from: (1) June 2003, (2) January 2004, (3) June 2004 and (4) January 2005. In the NSW/VIC region, severe bushfires were reported in early January 2003. Hence the ``tree" cover state was up to December 2002 then it was changed to ``removed" state from January 2003. The regression model was run from 1979 for both regions.

<<simpleMode,eval=F, echo = F, results = hide>>=

## plotting a hypothesed land cover change model
data1 <- data.frame(year=c(1,2,2,3),tc=c(2,2,1,1))
data2 <- data.frame(year=c(1,2,2,3,4),tc=c(2,2,1,1.5,2))

pdf("tc_simple.pdf", width = 9, height = 4)
par(mar=c(5,6,1,1), mfrow=c(1,2))
plot(data1$year,data1$tc,type="l",ylim=c(0.5,2.5),xlab="",ylab="",
     axes=F, frame.plot=F)
axis(1,at=c(1,2,3),labels=c("before","LCC","after"),cex.axis=1.3)
axis(2,at=c(1,2),label=c("removed","tree"),cex.axis=1.3,las=2)
lines(c(1,4),c(2,2),lty=2)
lines(c(1,4),c(1,1),lty=2)
lines(c(2,2),c(0,2.5),lty=2)
text(2.8,2.1,"(a)", font=2)
plot(data2$year,data2$tc,type="l",ylim=c(0.5,2.5),xlab="",ylab="",axes=F, frame.plot=F)
axis(1,at=c(1,2,4),labels=c("before","LCC","after"),cex.axis=1.3)
axis(2,at=c(1,2),label=c("removed","tree"),cex.axis=1.3,las=2)
lines(c(1,4),c(2,2),lty=2)
lines(c(1,4),c(1,1),lty=2)
lines(c(2,2),c(0,2.5),lty=2)
text(3.5,2.1,"(b)", font=2)
dev.off()

@

<<fullRegression,eval=F , echo = F, results = hide>>=

## predicting model: land cover is category variable
rain.trend <- function(x,y,m,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))+0.0001
  
  if (!is.na(mean(var.data$rain))) {
    if (grepl("qld",substitute(y))) {
      var.data <- na.omit(var.data)    
      rain_fit <- gam(rain ~ s(month, k=3)
                  + s(SOI, k=3)
                  + cover  
                  + trd
                  , data=var.data,family=Gamma(link=log))
    } else
     if (grepl("nsw",substitute(y))) {  
      var.data <- na.omit(var.data)    
      rain_fit <- gam(rain ~ s(month, k=3)
                  + s(SOI, k=3)
                  + s(IOD, k=3)
                  + cover  
                  + trd
                  , data=var.data,family=Gamma(link=log))
    }        
                  
  return(rain_fit)
  } else {NA}
  
}

## note: link=log generally has higher r.sq value than link=reverse

## generate variables for the model
trd <- seq(1:360)
month <-rep(1:12,times=30)
mth <- cycle(ts(month,start=c(1979,1),frequency=12))

LC <- c(rep("tree",288),rep("clear",72))
LC_qld4 <- c(rep("tree",312),rep("clear",48)) ## after- : from Jan 2005

var.data <- data.frame(month, trd, SOI = SOI_30a, IOD = IOD_30a, cover = LC)
var.qld4 <- data.frame(month, trd, SOI = SOI_30a, IOD = IOD_30a, cover = LC_qld4)

  coef.rain30.qld4 <- lapply(2:ncol(qld_30), 
                             function(x) rain.trend(x,qld_30,30,
                                                    var.qld4))
  coef.rain30.nswvic <- lapply(2:ncol(nsw_30), 
                               function(x) rain.trend(x,nsw_30,
                                                      30,var.data))

## extract sign of C
  C30_qld <- unlist(lapply(1:length(coef.rain30.qld4),
    function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                       summary(coef.rain30.qld4[[x]])$p.coeff[2],
                       NA)))
  C30_nswvic <- unlist(lapply(1:length(coef.rain30.nswvic),
    function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                       summary(coef.rain30.nswvic[[x]])$p.coeff[2],
                       NA)))
# p-value of C
Cp30_qld4 <- unlist(lapply(1:length(coef.rain30.qld4),
   function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                      summary(coef.rain30.qld4[[x]])$p.pv[2],NA)))
Cp30_nswvic <- unlist(lapply(1:length(coef.rain30.nswvic),
    function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                       summary(coef.rain30.nswvic[[x]])$p.pv[2],
                       NA)))

## p value of seasons and climate indices
p_qld <- unlist(lapply(1:length(coef.rain30.qld4),
      function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                         summary(coef.rain30.qld4[[x]])$s.pv[1],
                         NA)))
p_nsw <- unlist(lapply(1:length(coef.rain30.nswvic),
      function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                         summary(coef.rain30.nswvic[[x]])$s.pv[1],
                         NA)))

## extract r.sq of the model
rsq_qld <- unlist(lapply(1:length(coef.rain30.qld4),
     function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                        summary(coef.rain30.qld4[[x]])$r.sq,NA)))
rsq_nsw <- unlist(lapply(1:length(coef.rain30.nswvic),
     function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                        summary(coef.rain30.nswvic[[x]])$r.sq,NA)))

## frame of the two regions (100 years data)
qld_tif <- raster("Data\\BoM\\rainfall\\AWAP\\from1900_FVG\\r19000101_qld.tif")
nsw_tif <- raster("Data\\BoM\\rainfall\\AWAP\\from1900_FVG\\r19000101_nsw.tif")

  dist_Cp30_qld4 <- raster(qld_tif)
  dist_Cp30_qld4[] <- Cp30_qld4
  dist_Cp30_nsw <- raster(nsw_tif)
  dist_Cp30_nsw[] <- Cp30_nswvic
# ## range of predicted values
  predictmax_qld30 <- unlist(lapply(1:length(coef.rain30.qld4),
        function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                          max(coef.rain30.qld4[[x]]$fitted.values),
                           NA)))
  predictmin_qld30 <- unlist(lapply(1:length(coef.rain30.qld4),
        function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",                 min(coef.rain30.qld4[[x]]$fitted.values),NA)))
# 
mean_qld <- lapply(1:length(coef.rain30.qld4), 
          function(x) if(summary(coef.rain30.qld4)[x,2]=="gam") {fitted(coef.rain30.qld4[[x]])
            } else{NA})

## calculate mean residual
  cc <- 1
  qld.sum <- mean_qld[[1]]
  for (i in 2:length(mean_qld)) {
    if(!is.na(mean_qld[[i]])) {
      qld.sum <- qld.sum + mean_qld[[i]]
      cc <- cc+1
    }
  }
  qld.mean <- qld.sum/cc
  qld.mean <- ts(qld.mean,start=c(1979,1),frequency=12)

predictmax_nsw30 <- unlist(lapply(1:length(coef.rain30.nswvic),
        function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                      max(coef.rain30.nswvic[[x]]$fitted.values),
                      NA)))
# 70 - 254.7
  predictmin_nsw30 <- unlist(lapply(1:length(coef.rain30.nswvic),
        function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                      min(coef.rain30.nswvic[[x]]$fitted.values),
                      NA)))
# 18.4 - 62.2

mean_nswvic <- lapply(1:length(coef.rain30.nswvic), 
          function(x) if(summary(coef.rain30.nswvic)[x,2]=="gam") {
              fitted(coef.rain30.nswvic[[x]])} else{NA})

## calculate mean residual
  cc <- 1
  nswvic.sum <- mean_nswvic[[1]]
  for (i in 2:length(mean_nswvic)) {
    if(!is.na(mean_nswvic[[i]])) {
      nswvic.sum <- nswvic.sum + mean_nswvic[[i]]
      cc <- cc+1
    }
  }
  nswvic.mean <- nswvic.sum/cc
  nswvic.mean <- ts(nswvic.mean,start=c(1979,1),frequency=12)   

  
## plots
  pdf("Cp_30yrs.pdf", width=10, height=4.5)
  par(mar=c(3,3,1,6),xpd=T, mfrow=c(1,2))
  plot(e111,xlab="",ylab="")
  image(dist_Cp30_qld4,col=c("red","orange","yellow",
                            "light blue"),
        breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
#   plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e111,add=T)
text(146, -25.4, "(a)", font=2)
image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.7,legend.width=0.9,legend.args=list(text="p value",line=0.5,cex=1.2,font=1),axis.args=list(cex.axis=0.8))
legend(148.7,-27.9,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=1)
  plot(e222,xlab="",ylab="") #,border="white")
  image(dist_Cp30_nsw,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e222,add=T)
  text(147.1, -34.96, "(b)", font=2)
  dev.off()
# 
# 
## plot gam.check
  pdf("qld_check.pdf")
  gam.check(coef.rain30.qld4[[1]])
  dev.off()

  pdf("nswvic_check.pdf")
  gam.check(coef.rain30.nswvic[[which(values(dist_Cp30_nsw)<0.05)[6]]])
  dev.off()

@

\subsection{Step trend test}

As a second method, a step trend test was used to detect changes in rainfall after the vegetation cover change. This nonparametric statistical test was modified from the Mann-Whitney Rank-Sum test by \citet{Hirsch1985}. The test was developed to look for a step change in data which is cross correlated. As the gridded rainfall dataset is based on an interpolation method, this results in a high spatial correlation between neighbouring pixels. The step trend test is suitable for the analysis of such a dataset. The advantages of this test are: (1) it does not depend on assumptions of the data distribution; (2) it is not restricted to datasets with no missing data; (3) it is robust and not as easily influenced by outliers and negative numbers \citep{Hirsch1985}.

\subsubsection{Rainfall residuals} %% do we need this heading?

The rainfall residuals from the regression model in Equation~\ref{eqn:model} were used for this test. According to \citet{Hirsch1985}, using deseasonalised and detrended data is important in a test to detect step change. Furthermore, since rainfall is only partially attributed to local sources and conditions, noise can be introduced by large scale dynamics and changes in other climatic factors. The assumption is that the regression model should remove this noise. Hence the model residuals $\epsilon'_r$ exclude the effects due to climate drivers, seasonality and the long term trend. As a result local effects are assumed to explain at least part of the variation in the residuals. The  test, described in the following section, associates changes in rainfall with the tree cover changes. 

%chunk 5: note code has changed
<<chunk5,eval=F , echo = F, results = hide>>=

## without land cover variable for step rend test
rain.trend3 <- function(x,y,m,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))+0.0001
  
  if (!is.na(mean(var.data$rain))) {
    if (grepl("qld",substitute(y))) {
      rain_fit <- gam(rain ~ trd  # 
                  + s(month,k=3)
                  + s(SOI, k=3)
                  , data=var.data,family=Gamma(link=log))
    } else
    if (grepl("nsw",substitute(y))) {
      rain_fit <- gam(rain ~ trd
                  + s(month,k=3)
                  + s(SOI, k=3)
                  + s(IOD, k=3) 
                  , data=var.data,family=Gamma(link=log))
    }        
                  
  return(rain_fit)
  } else {NA}
  
}
# 
# 
## run model for 30 years
  coef.rain.qld <- lapply(2:ncol(qld_30), 
                function(x) rain.trend3(x,qld_30,30,var.data))
  coef.rain.nswvic <- lapply(2:ncol(nsw_30), 
                function(x) rain.trend3(x,nsw_30,30,var.data))

## explaining power of the partial model
## QLD
  rsq_qld <- unlist(lapply(1:length(coef.rain.qld), 
          function(x) ifelse(summary(coef.rain.qld)[x,2]=="gam",
                             summary(coef.rain.qld[[x]])$r.sq,
                             NA)))
# 
## extract residual
  residual_qld <- lapply(1:length(coef.rain.qld), 
            function(x) if(summary(coef.rain.qld)[x,2]=="gam") {
              coef.rain.qld[[x]]$y-fitted(coef.rain.qld[[x]])
              } else {NA})

# 
# ## NSW/VIC
# 
  rsq_nswvic <- unlist(lapply(1:length(coef.rain.nswvic), 
        function(x) ifelse(summary(coef.rain.nswvic)[x,2]=="gam",
                           summary(coef.rain.nswvic[[x]])$r.sq,
                           NA)))
# 

# extract residual
residual_nswvic <- lapply(1:length(coef.rain.nswvic), 
        function(x) if(summary(coef.rain.nswvic)[x,2]=="gam") {
          coef.rain.nswvic[[x]]$y-fitted(coef.rain.nswvic[[x]])
          } else {NA})
saveRDS(residual_nswvic, file="residual_nswvic.RDS")
saveRDS(residual_qld, file="residual_qld.RDS")



## explaining power of the partial model
rain.trend4 <- function(x,y,m,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))+0.0001
  
  if (!is.na(mean(var.data$rain))) {
    if (grepl("qld",substitute(y))) {
      rain_fit <- gam(rain ~ s(SOI, k=3)
                  , data=var.data,family=Gamma(link=log))
    } else
    if (grepl("nsw",substitute(y))) {
      rain_fit <- gam(rain ~ s(SOI, k=3)
                  + s(IOD, k=3) 
                  , data=var.data,family=Gamma(link=log))
    }        
                  
  return(rain_fit)
  } else {NA}
  
}

## explaining power of index
  coef.soi.qld <- lapply(2:ncol(qld_30), 
                function(x) rain.trend4(x,qld_30,30,var.data))
  coef.soi.nswvic <- lapply(2:ncol(nsw_30), 
                  function(x) rain.trend4(x,nsw_30,30,var.data))
  rsq_soi_qld <- unlist(lapply(1:length(coef.soi.qld), 
          function(x) ifelse(summary(coef.soi.qld)[x,2]=="gam",
                             summary(coef.soi.qld[[x]])$r.sq,NA)))
  rsq_soi_nswvic <- unlist(lapply(1:length(coef.soi.nswvic),
          function(x) ifelse(summary(coef.soi.nswvic)[x,2]=="gam",
                             summary(coef.soi.nswvic[[x]])$r.sq,
                             NA)))
  
pdf("soi.pdf", width = 10, height = 4)
par(mfrow = c(1,2))
 hist(rsq_soi_qld*100,main="",xlab=expression(paste("% of variability explained (",R^2,")")),cex.lab=1.2)
 text(4.2,400, "(a)", font=2)
 hist(rsq_soi_nswvic*100,main="",xlab=expression(paste("% of variability explained (",R^2,")")),cex.lab=1.2)
text(3.2,300, "(b)", font=2)
dev.off()

@

\subsubsection{Mann-Whitney rank-sum statistic}

The step trend test is a modified version of the Mann-Whitney rank-sum statistic \citep{Hirsch1985}. As a nonparametric rank-based test, the Mann-Whitney test does not use the exact values of rainfall but depends on the ranks of the data. For each month, rainfall residuals of each year were ranked in an ascending order. The ranking of January rainfall in a sample pixel k in QLD is illustrated below:

\begin{table}[h]
  \centering
  \begin{tabular}{lccccccc}
  & 1998 & 1999 & 2000 & 2001 & 2002 & 2005 & 2006\\
  \textit Rainfall residuals: & -0.3 & -60.9 & -16.1 & -71.7 & 111.1 & -7.2 & -60.5 \\
  \textit Rank ($R'_{1k}$): & 6 & 2 & 4 & 1 & 7 & 5 & 3\\
  \end{tabular}
\end{table}
\noindent 

Therefore, the smallest value (including negative values) has rank 1 and the largest value has the maximum rank.

The before period and the after period formed two groups of samples. The split point of the two periods was based on the timing of the vegetation cover changes. In the QLD region, changes occurred anytime during 2003 and 2004. In contrast to the previous method, the time period of where the land cover chang occurred was excluded, as the nonparametric test allows missing data. \citet{Hirsch1985} also pointed out that the power of the test is higher if the data of the change period is ignored. Hence 2003 and 2004 were excluded from the analysis. As a result, the after-change period was 2005 - 2007. 

In the case of NSW/VIC, the bushfires broke out in early January 2003. The change was within a relatively short period of the year. Therefore the after-change period in this region still started in January 2003. The before period was set to five years (1998 - 2002) in both regions. 
  
The rank of rainfall in month j year i in pixel k is denoted as $R'_{ijk}$. The sum of ranks of rainfall in month j in pixel k before the known intervention is:  
\begin{linenomath*}
  \begin{equation}
    W_{jk} = \sum_{i=1}^{n_1}R'_{ijk}.
    \label{eqn:Wj}
  \end{equation}
\end{linenomath*}
$n_1$ is the number of years before the land cover change. The expected value of $W_{jk}$ is 
\begin{linenomath*}
  \begin{equation}
    \mu_w=n_1(n_1+n_2+1)/2
  \end{equation}
\end{linenomath*}
$n_2$ is the number of years after the change. Hence the expected value of the rank sum before the intervention is the same for all months and all pixels. The sum of ranks for the whole time period is fixed, as $(n_1+n_2)(n_1+n_2+1)/2$. Knowing the rank-sum of one group the rank-sum of the other group can be easily derived. If the rainfall data is temporally and spatially independent, the variance of $W_{jk}$ is 
\begin{linenomath*}
  \begin{equation}
    \sigma^2_w = n_1\cdot n_2(n_1+n_2+1)/m
  \end{equation}
\end{linenomath*}
where m is the number of months which is 12 in the case of a full year. 

\subsubsection{Step trend test}

Instead of completing the Mann-Whitney U-test, \citet{Hirsch1985} applied the rank-sum statistics in a standard normal Z test. The modified test can be used to detect step change and it accounts for serial and cross correlation in the data. In the case here, the deseasonalised and detrended data shows little autocorrelation in the time series but possesses strong cross correlation between neighbouring pixels, i.e. $R>0.99$. Hence the covariance between pixels would need to be considered in the test.

The sum of $W_{jk}$ for a block of $ns$ pixels over the whole year, $\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk}$, has a mean value of 
\begin{linenomath*}
  \begin{equation}
    E(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})=12\cdot ns\cdot\mu_W
  \end{equation}
\end{linenomath*}
and variance
\begin{linenomath*}
  \begin{equation}
    Var(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})=\sum_{j=1}^{12}\sum_{k=1}^{ns}\sum_{h=1}^{ns}C(W_{jk},W_{jh}).
  \end{equation}
\end{linenomath*}
$C(W_{jk},W_{jh})$ is the covariance of the W statistics between pixel k and pixel h in month j. When $k=h$, $C(W_{jk},W_{jh})=\sigma^2_w$. When $k\neq h$, 
\begin{linenomath*}
  \begin{equation}
    C(W_{jk},W_{jh})=\sigma^2_w r(R_k,R_h)
  \end{equation}
\end{linenomath*}
where $r(R_k,R_h)$ is the product moment correlation coefficient of the concurrent ranks in pixel k and h. Here $r$ is calculated on the full time series in each pixel. In this analysis, the test was applied to a square block of four pixels each time. As argued by \citet{Hirsch1985}, $ns=4$ is the most optimal solution to balance the cost and the gain in the test power.

The statistic of the step trend test is then defined as 
\begin{linenomath*}
  \begin{equation}
    Z'=\frac{\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk}-12\cdot ns\cdot\mu_w}{\sqrt{Var(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})}}.
    \label{eqn:Z}
  \end{equation}  
\end{linenomath*}
The above statistic is written for a 12 month period. The statistic can also be used to test seasonal rainfall change or for other customized periods, by changing the value 12.

The null hypothesis ($H_0$) in this study is that there was no change in rainfall due to land surface intervention. The results of the step trend test can be interpreted according to the sign of Z' score (see Table~\ref{tab:Zscore}). Z' is normally distributed similar to the standard normal statistics Z. Hence it can be compared to a standard normal distribution to determine the p value. 

\begin{table}
  \caption[The interpretation of Z' score in the step trend test.]{The interpretation of Z' score in the step trend test. Following \citet[][Chapter 23, P887]{Hipel1994}.}
  \label{tab:Zscore}
  \centering
  \begin{tabular}{ll} \hline
    Z' $>$ 0 & rainfall decreases after change \\
    Z' $<$ 0 & rainfall increases after change \\ 
    Z' = 0 & rainfall does not change \\ \hline
  \end{tabular}
\end{table}
  
%chunk 6
<<chunk6,eval=F , echo = F, results = hide>>=

## perform step test on the data
## function to calculate the step trend statistic (Hirsch, 1985)
stepTrend2 <- function(x,y,i){  
    n1 <- 2002-1997
    if (i==1){
      z <- 56  # no. of column
    } else {
    z <- 37 } # close if
    
  if (x%%z!=0){ #& x%%z!=(z-1)) {
    y.1 <- y[[x]]
    y.2 <- y[[x+1]]
    y.3 <- y[[x+z]]
    y.4 <- y[[x+z+1]]

  if(!is.na(y.1[1])&!is.na(y.2[1])&!is.na(y.3[1])&!is.na(y.4[1])) {
    if (i == 1) {
      n2 <- 2008-2004    
      v.1 <- ts(y.1[c(229:288,313:360)],start=c(1998,1),
                frequency=12)
      v.2 <- ts(y.2[c(229:288,313:360)],start=c(1998,1),
                frequency=12)
      v.3 <- ts(y.3[c(229:288,313:360)],start=c(1998,1),
                frequency=12)
      v.4 <- ts(y.4[c(229:288,313:360)],start=c(1998,1),
                frequency=12)
    } else {
      n2 <- 2008-2002
      v.1 <- ts(y.1[c(229:360)],start=c(1998,1),frequency=12)
      v.2 <- ts(y.2[c(229:360)],start=c(1998,1),frequency=12)
      v.3 <- ts(y.3[c(229:360)],start=c(1998,1),frequency=12)
      v.4 <- ts(y.4[c(229:360)],start=c(1998,1),frequency=12)
    } # close if (i ==1)
  #browser()
## rank by month
   for (j in 1:12) { 
    assign(paste("r1",j,sep=""),rank(subset(v.1,cycle(v.1)==j)))
    assign(paste("r2",j,sep=""),rank(subset(v.2,cycle(v.2)==j)))
    assign(paste("r3",j,sep=""),rank(subset(v.3,cycle(v.3)==j)))
    assign(paste("r4",j,sep=""),rank(subset(v.4,cycle(v.4)==j))) 
   } # close rank by month
## mann-whitney rank sum statistic
    rlist.1 <- list(r11,r12,r13,r14,r15,r16,r17,r18,r19,r110,
                    r111,r112) ## full year
    rlist.2 <- list(r21,r22,r23,r24,r25,r26,r27,r28,r29,r210,
                    r211,r212)
    rlist.3 <- list(r31,r32,r33,r34,r35,r36,r37,r38,r39,r310,
                    r311,r312)
    rlist.4 <- list(r41,r42,r43,r44,r45,r46,r47,r48,r49,r410,
                    r411,r412)
    rlist <- list(unlist(rlist.1),unlist(rlist.2),unlist(rlist.3),unlist(rlist.4)) 
    w.s1 <- 0
    w.s2 <- 0
    w.s3 <- 0
    w.s4 <- 0
  for (k in 1:length(rlist.1)) {
    w.s1 <- sum(rlist.1[[k]][1:n1])+w.s1
    w.s2 <- sum(rlist.2[[k]][1:n1])+w.s2
    w.s3 <- sum(rlist.3[[k]][1:n1])+w.s3
    w.s4 <- sum(rlist.4[[k]][1:n1])+w.s4
    }
    w.s <- sum(w.s1,w.s2,w.s3,w.s4) #,w.s5,w.s6,w.s7,w.s8,w.s9)
  
## other statistic
# mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- 12*4*mu

# assume only cross correlation
    ss <- n1*n2*(n1+n2+1)/12
    ss.s <- 0
    for (kk in 1:4) {
      for (kkk in 1:4) {
          ss.s <- 12*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
      }
    }
## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)
    return(z) }
     else {return(NA)} }
     else {return(NA)}
  }

## 30 years
## full year, 
## central QLD
  qld.z.new <- unlist(lapply(1:(length(residual_qld)-56),
                    function(x) stepTrend2(x,residual_qld,1)))
  qld.z.new <- c(qld.z.new,rep(NA,56))
  
  tr_qld.step.new <- raster(qld_tif)
  tr_qld.step.new[] <- qld.z.new
## NSW  
  nswvic.z.new <- unlist(lapply(1:(length(residual_nswvic)-37),
                  function(x) stepTrend2(x,residual_nswvic,2)))
  
  nswvic.z.new <- c(nswvic.z.new,rep(NA,37))
  
  tr_nswvic.step.new <- raster(nsw_tif)
  tr_nswvic.step.new[] <- nswvic.z.new


  plotclt <- rev(brewer.pal(8,"RdYlBu"))

pdf("step_new.pdf", width=10, height = 4.5)
  par(mar=c(3,3,1,7),xpd=T, mfrow=c(1,2))
  plot(e111,xlab="",ylab="")#,border="white")
  image(tr_qld.step.new,col=plotclt,breaks=c(-3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3) 
  plot(e111,add=T)
image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.5,cex=1,font=2),axis.args=list(cex.axis=0.8))
text(146, -25.4, "(a)", font=2)
  plot(e222,xlab="",ylab="")#,border="white")
  image(tr_nswvic.step.new,col=plotclt,breaks=c(-2.3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3)
  plot(aus_reg2,border="grey",add=T) 
  plot(e222,add=T)
# image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.5,cex=1,font=2),axis.args=list(cex.axis=0.8))
text(147.1, -34.96, "(b)", font=2)
legend(149,-36.0,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=0.9)
  dev.off()

@


% chunk 8: bootstrapping (spatial structure is kept, used)
<<chunk8,eval = F , echo = F, results = hide>>=

## multiple cell step trend
## perform step test on the data for the bootstrapping test (spatial structure was kept)
## function to calculate the step trend statistic (Hirsch, 1985)
NstepTrend <- function(x,m,i){

    n1 <- 2002-1997

    if (i==1){

      z <- 56  # no. of column

    } else {

    z <- 37 }
#browser()
   # print(x)
if (x%%z!=0){ #& x%%z!=(z-1)) {
    y.1 <- m[,x]
    y.2 <- m[,(x+1)]
#     y.3 <- y[,x+2]
    y.3 <- m[,(x+z)]
    y.4 <- m[,(x+z+1)]
#     y.6 <- y[[x+z+2]]
#     y.7 <- y[[x+2*z]]
#     y.8 <- y[[x+2*z+1]]
#     y.9 <- y[[x+2*z+2]]

    if(!is.na(y.1[1])&!is.na(y.2[1])&!is.na(y.3[1])&!is.na(y.4[1])) { #|!is.na(y.5[1])|!is.na(y.6[1])|!is.na(y.7[1])|!is.na(y.8[1])|!is.na(y.9[1])) {

    if (i == 1) {
      n2 <- 2008-2004
      v.1 <- ts(y.1[c(229:288,313:360)],start=c(1998,1),frequency=12)
      v.2 <- ts(y.2[c(229:288,313:360)],start=c(1998,1),frequency=12)
      v.3 <- ts(y.3[c(229:288,313:360)],start=c(1998,1),frequency=12)
      v.4 <- ts(y.4[c(229:288,313:360)],start=c(1998,1),frequency=12)
#       v.5 <- ts(y.5[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.6 <- ts(y.6[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.7 <- ts(y.7[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.8 <- ts(y.8[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.9 <- ts(y.9[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v <- (x$y-x$fitted.values)[c(1:288,313:357)]
#       v.s <- ts(v,start=c(1998,1),frequency=12)

    } else {

      n2 <- 2008-2002

      v.1 <- ts(y.1[c(229:360)],start=c(1998,1),frequency=12)
      v.2 <- ts(y.2[c(229:360)],start=c(1998,1),frequency=12)
      v.3 <- ts(y.3[c(229:360)],start=c(1998,1),frequency=12)
      v.4 <- ts(y.4[c(229:360)],start=c(1998,1),frequency=12)
#       v.5 <- ts(y.5[c(229:348)],start=c(1998,1),frequency=12)
#       v.6 <- ts(y.6[c(229:348)],start=c(1998,1),frequency=12)
#       v.7 <- ts(y.7[c(229:348)],start=c(1998,1),frequency=12)
#       v.8 <- ts(y.8[c(229:348)],start=c(1998,1),frequency=12)
#       v.9 <- ts(y.9[c(229:348)],start=c(1998,1),frequency=12)
#       v <- (x$y-x$fitted.values)[c(1:288, 301:357)]
#       v.s <- ts(v,start=c(1998,1),frequency=12)
}

## rank by month
   for (j in 1:12) {
    # y1.mth <- data.frame(mth=as.vector(window(v.1,start=c(1998,i),frequency=1)),o=y[[j]])[order(y[[j]]),]
    # y2.mth <- data.frame(mth=as.vector(window(v.2,start=c(1998,i),frequency=1)),o=y[[j]])[order(y[[j]]),]
    # y3.mth <- data.frame(mth=as.vector(window(v.3,start=c(1998,i),frequency=1)),o=y[[j]])[order(y[[j]]),]
    # y4.mth <- data.frame(mth=as.vector(window(v.4,start=c(1998,i),frequency=1)),o=y[[j]])[order(y[[j]]),]

    assign(paste("r1",j,sep=""),rank(subset(v.1,cycle(v.1)==j)))
    assign(paste("r2",j,sep=""),rank(subset(v.2,cycle(v.2)==j)))
    assign(paste("r3",j,sep=""),rank(subset(v.3,cycle(v.3)==j)))
    assign(paste("r4",j,sep=""),rank(subset(v.4,cycle(v.4)==j)))
#     assign(paste("r5",j,sep=""),rank(subset(v.5,cycle(v.5)==j)))
#     assign(paste("r6",j,sep=""),rank(subset(v.6,cycle(v.6)==j)))
#     assign(paste("r7",j,sep=""),rank(subset(v.7,cycle(v.7)==j)))
#     assign(paste("r8",j,sep=""),rank(subset(v.8,cycle(v.8)==j)))
#     assign(paste("r9",j,sep=""),rank(subset(v.9,cycle(v.9)==j)))

    }

## mann-whitney rank sum statistic
    rlist.1 <- list(r11,r12,r13,r14,r15,r16,r17,r18,r19,r110,r111,r112) ## full year
    rlist.2 <- list(r21,r22,r23,r24,r25,r26,r27,r28,r29,r210,r211,r212)
    rlist.3 <- list(r31,r32,r33,r34,r35,r36,r37,r38,r39,r310,r311,r312)
    rlist.4 <- list(r41,r42,r43,r44,r45,r46,r47,r48,r49,r410,r411,r412)
#     rlist.5 <- list(r51,r52,r53,r54,r55,r56,r57,r58,r59,r510,r511,r512)
#     rlist.6 <- list(r61,r62,r63,r64,r65,r66,r67,r68,r69,r610,r611,r612)
#     rlist.7 <- list(r71,r72,r73,r74,r75,r76,r77,r78,r79,r710,r711,r712)
#     rlist.8 <- list(r81,r82,r83,r84,r85,r86,r87,r88,r89,r810,r811,r812)
#     rlist.9 <- list(r91,r92,r93,r94,r95,r96,r97,r98,r99,r910,r911,r912)
    rlist <- list(unlist(rlist.1),unlist(rlist.2),unlist(rlist.3),unlist(rlist.4)) #,unlist(rlist.5),unlist(rlist.6),unlist(rlist.7),unlist(rlist.8),unlist(rlist.9))
## seasonal
#     rlist <- list(unlist(rlist.1[c(9:11)]),unlist(rlist.2[c(9:11)]),unlist(rlist.3[c(9:11)]),unlist(rlist.4[c(9:11)]))
#     rlist <- list(r1,r2,r12) ## summer
#     rlist <- list(r3,r4,r5)  ## autumn
#     rlist <- list(r6,r7,r8)  ## winter
#     rlist <- list(r9,r10,r11) ## spring
    w.s1 <- 0
    w.s2 <- 0
    w.s3 <- 0
    w.s4 <- 0
#     w.s5 <- 0
#     w.s6 <- 0
#     w.s7 <- 0
#     w.s8 <- 0
#     w.s9 <- 0
  for (k in 1:length(rlist.1)) {
#   for (k in c(9:11)) {
    w.s1 <- sum(rlist.1[[k]][1:n1])+w.s1
    w.s2 <- sum(rlist.2[[k]][1:n1])+w.s2
    w.s3 <- sum(rlist.3[[k]][1:n1])+w.s3
    w.s4 <- sum(rlist.4[[k]][1:n1])+w.s4
#     w.s5 <- sum(rlist.5[[k]][1:n1])+w.s5
#     w.s6 <- sum(rlist.6[[k]][1:n1])+w.s6
#     w.s7 <- sum(rlist.7[[k]][1:n1])+w.s7
#     w.s8 <- sum(rlist.8[[k]][1:n1])+w.s8
#     w.s9 <- sum(rlist.9[[k]][1:n1])+w.s9
    }
    w.s <- sum(w.s1,w.s2,w.s3,w.s4) #,w.s5,w.s6,w.s7,w.s8,w.s9)

## other statistic
# mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- 12*4*mu
# ## mean for one season
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- 3*4*mu

## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, cor.test(), true for NSW, mostly true for WA. QLD? there are some situations in WA require further investigation)
# assume only cross correlation
    ss <- n1*n2*(n1+n2+1)/12
    ss.s <- 0
    for (kk in 1:4) {
      for (kkk in 1:4) {
#         for (kkkk in 1:12) {
          ss.s <- 12*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#         }
      }
    }
## variance for one season
#     ss <- n1*n2*(n1+n2+1)/3
#     ss.s <- 0
#     for (kk in 1:4) {
#       for (kkk in 1:4) {
#           ss.s <- 3*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#       }
#     }

## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)

    return(z) }

     else {return(NA)} }

     else {return(NA)}

  }

## full year
residual_nswvic <- readRDS(file="residual_nswvic.RDS")
residual_qld <- readRDS(file="residual_qld.RDS")

## central QLD
  data_df <-  as.data.frame(t(do.call(rbind, residual_qld)))
  data_df$years <- rep(1979:2008,each=12)

qld.z <- sapply(1:(ncol(data_df)-58),
                    function(x) NstepTrend(x,data_df,1))
## NSW/VIC
## treatment 1: excluding 2003
  data_df <-  as.data.frame(t(do.call(rbind, residual_nswvic)))
  data_df$years <- rep(1979:2008,each=12)
  nswvic.z <- sapply(1:(ncol(data_df)-39),
                    function(x) NstepTrend(x,data_df,2))

  qld_origp <- length(qld.z[qld.z >= 
                      abs(qt(0.1,length(qld.z)))])/length(qld.z)
# 0.01
  qld_orign <- length(qld.z[qld.z <= 
                      qt(0.1,length(qld.z))])/length(qld.z)
# 0

  nsw_origp <- length(nswvic.z[nswvic.z >= 
                   abs(qt(0.1,length(nswvic.z)))])/length(nswvic.z)
# 0.022
  nsw_orign <- length(nswvic.z[nswvic.z <= 
                    qt(0.1,length(nswvic.z))])/length(nswvic.z)

# Bootstrapping new (September 2017)  
# 1000 bootstrap samples, time is in the vector (will become column), xy locations are the list elements (will become rows)

require(doParallel)
# parallelise  
Boot_strap_fun <- function(DataList, k, Site) {
  # k is number of samples
  # Site is location 1 = qld, 2 = nsw_vic
  data_df <-  as.data.frame(t(do.call(rbind, DataList)))
  data_df$years <- rep(1979:2008,each=12)
  # storage
  nyears <- nrow(data_df)/12
#  browser()
  # run the bootstrap
  cl <- makeCluster(6) # create a cluster with 6 cores
  registerDoParallel(cl) # register the cluster
  # use a foreach loop to calibrate
  out <- foreach(i = 1:k, .export=c("NstepTrend")) %dopar% {

 # for (i in 1:k) {
      mangle_years <- sample(unique(data_df$years),nyears)
    for (j in 1:length(mangle_years)) {
      if (j==1) { 
        new_df <- as.data.frame(data_df[data_df$years==mangle_years[j],])
      } else {
    # rbind to dataframe
        new_df <- rbind(new_df,
                       as.data.frame(data_df[data_df$years==mangle_years[j],]))
      }
    }
    new_df$years <- rep(1979:2008,each=12)
  # run step_trend on block of cells
  #  browser()
    z_score <- sapply(1:(ncol(new_df)-ifelse(Site==1,58,39)),
                    function(x) NstepTrend(x,new_df,i=Site))
    z_score
    }  

  return(out)
}
system.time({
qld_z_bs <- Boot_strap_fun(residual_qld,k=1000, Site = 1)
})
nswvic_z_bs <- Boot_strap_fun(residual_nswvic,k=1000, Site = 2)


zpq.values <- unlist(lapply(qld_z_bs,function(x)
  length(x[x >= abs(qt(0.1,length(x)))])/length(x)*100))
znq.values <- unlist(lapply(qld_z_bs,function(x)
  length(x[x <= qt(0.1,length(x))])/length(x)*100))
zpnsw.values <- unlist(lapply(nswvic_z_bs,function(x)
  length(x[x >= abs(qt(0.1,length(x)))])/length(x)*100))
znnsw.values <- unlist(lapply(nswvic_z_bs,function(x)
  length(x[x <= qt(0.1,length(x))])/length(x)*100))


write.table(zpq.values,file="bt_outp_qld.txt",row.names=F)
write.table(znq.values,file="bt_outn_qld.txt",row.names=F)
write.table(zpnsw.values,file="bt_outp_nsw.txt",row.names=F)
write.table(znnsw.values,file="bt_outn_nsw.txt",row.names=F)
  

# 
bt4_nswp.values <- read.table("bt_outp_nsw.txt",header=T,sep="")
bt4_nswn.values <- read.table("bt_outn_nsw.txt",header=T,sep="")
bt4_qldp.values <- read.table("bt_outp_qld.txt",header=T,sep="")
bt4_qldn.values <- read.table("bt_outn_qld.txt",header=T,sep="")

pdf("bt4_nsw.pdf",width=8,height=4)
par(mfrow=c(1,2))
hist(bt4_nswp.values[,1],nclass=100,xlab="% positive Z'",main="4-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(nsw_origp*100,0,pch=16,col="red",cex=1.8)
hist(bt4_nswn.values[,1],nclass=100,xlab="% negative Z'",main="4-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(nsw_orign*100,0,pch=16,col="red",cex=1.8)
dev.off()

# pdf("bt4_nswn.pdf")
# dev.off()

pdf("bt4_qld.pdf",width=8,height=4)
par(mfrow=c(1,2))
hist(bt4_qldp.values[,1],nclass=100,xlab="% positive Z'",main="4-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(qld_origp*100,0,pch=16,col="red",cex=1.8)
hist(bt4_qldn.values[,1],nclass=100,xlab="% negative Z'",main="4-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(qld_orign*100,0,pch=16,col="red",cex=1.8)
dev.off()

# pdf("bt4_qldn.pdf")
# dev.off()

@

% chunk 9: bootstrapping (spatial structure is kept, remove short term trend, randomly select after change period)
<<chunk9,eval=F , echo = F, results = hide>>=

## x: rainfall series; y: new order; ii: selection of region
# NstepTrend3 <- function(x,y,ii){  
# 
#   if(!is.na(unlist(x)[1])) {
#   
#   v <- x[c(229:360)][order(y)]
#   ttrd <- c(1:132)
#   v <- residuals(lm(v~ttrd))
#   
#   n1 <- sample(c(4:8),1)
#   
#   if(ii==1) {    
#       yy <- ts(v[c(1:60,85:132)],start=c(1998,1),frequency=12)    
#       n2 <- 9-n1
#     } else
#       if(ii==2) {
#       yy <- ts(v,start=c(1998,1),frequency=12)
#       n2 <- 11-n1
#     } 
#   
#   for(i in 1:12) { 
#   y.mth <- as.vector(window(yy,start=c(1998,i),frequency=1))
#   
#   ## rank by month   
#     assign(paste("r",i,sep=""),rank(y.mth) )
#   } 
#   
#   
# ## mann-whitney rank sum statistic
#     rlist <- list(r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12) ## full year
# 
#     w.s <- 0
#     for (k in 1:length(rlist)) {
#     w.s <- sum(rlist[[k]][1:n1])+w.s
#     }
#   
# ## other statistic
# ## mean for full year
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- length(rlist)*mu
# 
#   
# ## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, true for QLD and NSW)
#     ss <- n1*n2*(n1+n2+1)/length(rlist)
#     ss.s <- length(rlist)*ss
# 
# ## step trend statistic
#     z <- (w.s - mu.s)/sqrt(ss.s)
#   
#     return(z) 
#     }
#     
#      else {return(NA)}
#   
#   }
# 
# R <- 1000
# z3pq.values = numeric(R)
# z3nq.values = numeric(R)
# ## random sample with replacement. Both the order of the months and the order of years change
# 
# ptm <- proc.time()
# for (i in 1:R) {
#   
#   new.order <- sample(c(1:132),replace=T)
#   temp <- unlist(lapply(residual_qld,function(x,y) NstepTrend3(x,y,1),new.order))
# #   if(i==1) {write.table(temp,file="bt_zvalues3_qld.txt",row.names=F)
# #             } else
# #               {write.table(temp,file="bt_zvalues3_qld.txt",append=T,row.names=F,col.names=F)}
#   z3pq.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
#   z3nq.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
# }
# proc.time()-ptm
# 
# write.table(z3pq.values,file="bt_out3p_qld.txt",row.names=F)
# write.table(z3nq.values,file="bt_out3n_qld.txt",row.names=F)
# 
# #NSW
# z3pn.values = numeric(R)
# z3nn.values = numeric(R)
# ## random sample with replacement. Both the order of the months and the order of years change
# 
# ptm <- proc.time()
# for (i in 1:R) {
#   
#   new.order <- sample(c(1:132),replace=T)
#   temp <- unlist(lapply(residual_nswvic,function(x,y) NstepTrend3(x,y,2),new.order))
# #   if(i==1) {write.table(temp,file="bt_zvalues3_qld.txt",row.names=F)
# #             } else
# #               {write.table(temp,file="bt_zvalues3_qld.txt",append=T,row.names=F,col.names=F)}
#   z3pn.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
#   z3nn.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
# }
# proc.time()-ptm
# 
# write.table(z3pn.values,file="bt_out3p_nsw.txt",row.names=F)
# write.table(z3nn.values,file="bt_out3n_nsw.txt",row.names=F)
# 
# setEPS()
# postscript("bt3_qldp.eps")
# hist(z3pq.values,nclass=100,xlab="% positive Z'",main="QLD",cex.lab=1.4,cex.main=1.3)
# points(qld_origp,0,pch=16,col="red",cex=1.8)
# dev.off()
# 
# setEPS()
# postscript("bt3_qldn.eps")
# hist(z3nq.values,nclass=100,xlab="% negative Z'",main="QLD",cex.lab=1.4,cex.main=1.3)
# points(qld_orign,0,pch=16,col="red",cex=1.8)
# dev.off()
# 
# setEPS()
# postscript("bt3_nswp.eps")
# hist(z3pn.values,nclass=100,xlab="% positive Z'",main="NSW",cex.lab=1.4,cex.main=1.3)
# points(nsw_origp,0,pch=16,col="red",cex=1.8)
# dev.off()
# 
# setEPS()
# postscript("bt3_nswn.eps")
# hist(z3nn.values,nclass=100,xlab="% negative Z'",main="NSW",cex.lab=1.4,cex.main=1.3)
# points(nsw_orign,0,pch=16,col="red",cex=1.8)
# dev.off()

@
% apply the LocSig function in SpatialVx for block bootstrapping
<<chunk91,eval=F , echo = F, results = hide>>=

# require(SpatialVx)
# 
# ## reconstruct the data into format required in LocSig
# qld_res_mat <- matrix(unlist(residual_qld),nrow=360)
# nsw_res_mat <- matrix(unlist(residual_nswvic),nrow=360)
# 
# ## the step trend function for LocSig
# NstepTrend4 <- function(x,ii){  
#   
#   n1 <- sample(c(4:8),1)
#   zz <- vector()
# 
#   for(m in 1:ncol(x)) {
#     if(!is.na(x[1,m])) {
#   
#   v <- x[c(229:360),m]
#   ttrd <- c(1:132)
#   v <- residuals(lm(v~ttrd))
#   
#   if(ii==1) {    
#       yy <- ts(v[c(1:60,85:132)],start=c(1998,1),frequency=12)    
#       n2 <- 9-n1
#     } else
#       if(ii==2) {
#       yy <- ts(v,start=c(1998,1),frequency=12)
#       n2 <- 11-n1
#     } 
#   
#   for(i in 1:12) { 
#   y.mth <- as.vector(window(yy,start=c(1998,i),frequency=1))
#   
#   ## rank by month   
#     assign(paste("r",i,sep=""),rank(y.mth) )
#   } 
#   
#   
# ## mann-whitney rank sum statistic
#     rlist <- list(r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12) ## full year
# 
#     w.s <- 0
#     for (k in 1:length(rlist)) {
#     w.s <- sum(rlist[[k]][1:n1])+w.s
#     }
#   
# ## other statistic
# ## mean for full year
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- length(rlist)*mu
# 
#   
# ## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, true for QLD and NSW)
#     ss <- n1*n2*(n1+n2+1)/length(rlist)
#     ss.s <- length(rlist)*ss
# 
# ## step trend statistic
#     z <- (w.s - mu.s)/sqrt(ss.s)
#     zz[m] <- z
#     }
#     
#      else {zz[m]<-NA}
#   }
#   return(zz)
#   
#   }
@


\section{Results}

\subsection{Tree cover changes}

The pixels with significant tree cover change in each study region are shown in Figure~\ref{fig:tc_trend}, at the p $<$ 0.1 significance level. Despite the limitations of the length of this data series, it still indicates a large change in the NSW/VIC region. In the NSW/VIC region, much of the tree loss between 2002 and 2003 was in the Snowy Mountains which are at the border of NSW and VIC. Tree cover loss occurred in large parts of the QLD study region between 2002 and 2005. Most of the clearings appear in the centre of this region. The tree cover change map is consistent with the annual mean EVI trend map (based on DLCD data, map not shown here), which confirms these changes are significant and persistent over the study period. 

%figure 8
\begin{figure}[ht!]
\centering
\includegraphics[scale=0.65]{tc.pdf}
  \caption{The maps show the areas with significant changes in tree cover (at p $<$ 0.1) in (a) the QLD region and (b) the NSW/VIC region. The amount of change was calculated as the difference in tree covers before and after the specified land cover intervention and it is shown as the percentage of the ground area. Green colour indicates an increase in tree cover, while red colour indicates a decrease in tree cover. }
  \label{fig:tc_trend}
\end{figure}

\subsection{Regression Model \& Significance of Vegetation Cover Changes}

The regression model does not explain much of the rainfall variability. The model in Equation~\ref{eqn:model2} accounts for around 13\%\footnote{Here the adjusted $R^2$ was reported. Adjusted $R^2$ is the coefficient of determination, a measurement of the amount of variability predicted by the model adjusting for the number of explanatory terms} of the rainfall variations in the QLD region and 19\% in the NSW/VIC region on average. The residual analysis shows that the assumptions of the regression model are generally met. The standardised residual plots, however, show some funnelling for the NSW/VIC regions, suggesting non constant variance. The residual analysis, based on one sample pixel from each region, in Figure~\ref{fig:residuals_qld} and Figure~\ref{fig:residuals_nswvic} illustrates this. The residual patterns are consistent within each region.

The model confirms the importance of the climate drivers and the seasonality in Australian rainfall. Even at the grid level, the seasons and the climatic indices were significant ($p < 0.05$)  in both regions. The explaining power of the model is mostly due to these variables. The climate drivers (at lag zero) accounted, on average, for 6\% of the rainfall variability in both the QLD region and the NSW/VIC region (see Figure~\ref{fig:rsq} for the distribution of $R^2$ in these two regions). These figures are within the upper bound of seasonal rainfall predictability by SST anomaly field reported by \citet{Westra2010}.

%figure 9
\begin{figure}[ht!]
  \centering
  \includegraphics[scale=0.8]{qld_check.pdf}
  \caption{The residual analysis of a sample pixel in the QLD region.}
  \label{fig:residuals_qld}
\end{figure}

%figure 10
\begin{figure}[ht!]
  \centering
  \includegraphics[ scale=0.8]{nswvic_check.pdf}
  \caption{The residual analysis of a sample pixel in the NSW/VIC region.}
  \label{fig:residuals_nswvic}
\end{figure}

%figure 11
\begin{figure}[ht!]
  \centering
  \includegraphics[scale=0.65]{soi.pdf}
  \caption{The distribution of $R^2$ when rainfall is only modelled by the climate drivers. It shows the percentage of rainfall variability that can be explained by the climate drivers. In the case of (a) the QLD region, SOI was the only climatic index considered. In (b) the NSW/VIC region, SOI and IOD were used.}
  \label{fig:rsq}
\end{figure}


A statistically significant long term trend was not observed in either of the two regions. However, this result does not disprove the importance of a long term trend in rainfall. The overall time period is fairly short and more pixels in NSW/VIC would have a significant step change if the long term trend effect is not removed by the model. As trend free data is an important requirement for the step trend test, the trend term was kept in the regression model to ensure the detection of step change was not due to a possible long term trend. 

%figure 12
\begin{figure}[ht!]
\centering
\includegraphics[ scale=0.6]{Cp_30yrs.pdf}
  \caption{The spatial distribution of significance of vegetation cover changes in the two study regions. The significance of vegetation cover changes is assessed in the regression model. The figures report the p values of the coefficient of the land cover variable in the model at different significance level. The plot of the QLD region is for the scenario that the after change period started from January 2005, as the other scenarios don't have any p value less than 0.2.}
  \label{fig:LC_p}
\end{figure}

The land cover variable implies a step change with different values before and after the land cover intervention. This variable was only significant ($p=0.05$) for the rainfall estimates in some areas in NSW/VIC, as shown in Figure~\ref{fig:LC_p}~(b). The effect of tree removal in the NSW/VIC region was highly significant in the area from the Snowy Mountains range in the south to the west side of Australian Capital Territory (ACT), highlighted by the red colour in Figure~\ref{fig:LC_p}~(b). However no significant step change (at p $<$ 5\%) due to the land cover changes was found in rainfall of the QLD region in any of the four scenarios. 

In the NSW/VIC region, the locations of rainfall change show some agreement with the locations of vegetation cover change. Comparing the results in Figure~\ref{fig:LC_p}~(b) to Figure~\ref{fig:tc_trend}~(b), the alpine area with massive tree cover loss is located inside the highlighted region. The results show that the step change in rainfall also occurred in the cotter river catchment which was heavily burned in 2003 bushfires (refer to Figure~\ref{fig:bushfire}). However, Figure~\ref{fig:LC_p}~(b) also shows that a significant step change in rainfall was found in an area larger than where the bushfires has occurred. From this point of view, the results might be showing a large scale effect that extends beyond the vegetation cover change effect. 

More generally, the model also shows that the tree cover has a positive impact on rainfall. The fitted coefficients for the reference state "trees" were consistently positive for the pixels whose step changes of rainfall were significant. It implies that rainfall was higher when the surface was covered by trees. This was confirmed by applying a two sample Student's t-test on the annual rainfall of the before-change and after-change periods. 

\subsection{Step Trend Test}

%figure 13
\begin{figure}[ht!]
  \centering
 \includegraphics[ scale=0.7]{step_new.pdf}
  \caption{Spatial distribution of the step trend test Z' statistics in the two study sites. The test was conducted on the 30-year rainfall data from 1979 to 2009. Warm colours (yellow, orange and red) are for positive Z' values which indicate decreasing rainfall trend due to the land surface intervention. Cold colours (light blue to blue) are for negative Z' values which indicate increasing rainfall trend. The deeper the colour, the more significant the statistic.}
  \label{fig:steptest30}
\end{figure}

The spatial step trend test Z' scores are shown in Figure~\ref{fig:steptest30}. This figure provides two types of information: the sign and the significance level. The sign indicates the direction of the step change, as listed in Table~\ref{tab:Zscore}. In each region, there is a broad area of positive Z' values which implies a decrease in rainfall. In QLD, the areas of positive Z', especially when p is smaller than 0.1, almost align with the locations reported to have heavy land clearing (see Figure~\ref{fig:slat}). However the vegetation cover change map in Figure~\ref{fig:tc_trend}~(a) does not indicate a clear similar pattern. In the Snowy Mountains area and the west of ACT, where severe bushfires occurred in 2003, positive Z' values were also found. It again indicates that loss of tree cover was related to a rainfall decrease. Nevertheless the observed step change in rainfall was not strong. At the 5\% significance level, changes in a number of pixels in the alpine area are possibly where the tree recovery is slow. In the QLD region, 35 pixels obtained a Z' score with p $<$ 5\%. In the NSW/VIC region, there are only 18 pixels in the alpine area having a Z' score with p $<$ 5\%. They are a very small proportion of both study regions.
As the variability of the monthly rainfall, and the variability of rainfall in Australia is considerable \citep{Delworth_regional_2014}, detecting significant trends at p $<$ 5\% could be difficult. Therefore, an analysis based on p $<$ 10\% is presented in the figures. At p = 10\%, 278 pixels in the QLD region had a significant positive Z' score, while 142 pixels in the NSW/VIC region were significant. In both cases this was a bit over 10\% of the total area.

%figure 14
\begin{figure}[ht!]
  \centering
  \includegraphics[scale=0.6]{slat.jpg}
  \caption{Woody vegetation clearing rate in QLD. The maps and figures are obtained from \citet{SLATS2004}. The red rectangle is the boundary of the QLD study region.}
  \label{fig:slat}
\end{figure}

%figure 15
\begin{figure}[ht!]
  \centering
  \includegraphics[scale=0.8]{compare_mean.pdf}
  \caption[Boxplots of annual rainfall (estimated based on rainfall residuals from Equation~\ref{eqn:model}) before and after the land cover intervention during 1998 - 2008 in the study regions.]{Boxplots of annual rainfall (estimated based on rainfall residuals from Equation~\ref{eqn:model}) before and after the land cover intervention during 1998 - 2008 in the study regions. On average, the after period has a lower annual rainfall amount and with outliers of small values.}
  \label{fig:mean_diff}
\end{figure}

The rainfall residuals of the two periods (before-change since 1998 and after-change) were also compared (Figure~\ref{fig:mean_diff}). The annual values of the 11-year period (1998 - 2008) were calculated for each pixel. The boxplots indicate that there were different mean values between the ``before" and ``after" periods in both regions. There are small outliers in the after period in NSW/VIC. A close look at the rainfall data revealed that rainfall was consistently very low in 2006 for the whole region. The low rainfall in 2006 was due to a weak El Ni\~{n}o and memory effects of the previous drought. While the regression model has removed most of the effect of ENSO, the  cumulative drought effect could still be visible in the residuals if the response of the rainfall to the ENSO effect is non-linear, and the memory of the past drought is persistent. This can also explain the significant results in the previous method. To remove the outlier effects, the two periods were compared excluding the 2006 rainfall. An F test confirmed that the variances were different between the before and after periods. Hence an unpaired unequal variance two sample t-test was applied to test whether the after period has lower mean rainfall than the before period, for the group of pixels showing a negative step change in rainfall ($p = 0.05$) and the group of pixels with no change. The rainfall in the after period was lower than the before period (p $<$ 0.05) for pixels showing a negative step change. For those pixels without a step change, there was no statistical evidence that the two periods have different means. Hence the t-test results are consistent with the step trend test results.


The choice of $ns$ has some impact on the test results, as shown by \citet{Hirsch1985}. The cases of $ns = 1$ and $ns = 9$ were also tested. When $ns = 1$, 18 pixels in the QLD region obtained a Z' score at the 5\% significance level. In the NSW/VIC region, the detection of negative step change ($p = 0.05$) reduced to 16 pixels. On the other hand, when $ns = 9$, the results were similar to the case of $ns = 4$. In this case, the changes ($p = 0.05$) were detected in 35 pixels in the QLD region and 18 pixels in the NSW/VIC region. The power of the test does not change much after $ns = 4$, as shown by \citet{Hirsch1985}. The cause of the somewhat inconsistent results in the QLD region between $ns = 1$ and $ns = 4$ is unclear. This could possibly be because the higher $ns$ values smooth the individual pixel results.

The "field significance" of the test is considered to make inferences about the step change at regional scales from multiple local tests \citep{Wilks2006,Westra2013}. Here, the bootstrapping resampling method from \citet{Westra2013} was modified to evaluate the field significance. The spatial structure of the pixels was maintained, while the order of the years and months, were changed by random resampling. The test statistic identifies the percentage of the pixels with significant step change, positive and negative respectively, for the step trend test. The test statistics on 1000 resampled replicates were used to develop the distribution of these percentage values under the local null hypothesis that there was no step change.

The bootstrapping resampling technique was applied on both $ns=1$ and $ns=4$ cases. In the $ns=4$ case, a spatial moving block bootstrapping was used, in which the change of time sequence within the 2$\times$2 block was consistent. The distribution of the test statistics is highly concentrated at zero with a skew to the right. In the outputs, negative step changes in the cases of $ns=1$ and $ns=4$, the test statistics on the observed time series generally fall within the null hypothesis distribution (the cases of $ns=4$ are shown in Figure~\ref{fig:boot_qld} and Figure~\ref{fig:boot_nsw}). However, the bootstrap distribution is very wide and highly skewed, with step change values close to 0. The result for both the positive Queensland and positive NSW/VIC $ns=4$ step change tests are located much further to the right on the tail of the disctribution, away from 0 and give a stronger indication of a change. The results showed that overall the chance of detecting a rainfall change was small, which is related to the strong natural variability of the rainfall in Australia. However, the location of the positive tests on the tail of the distribution suggests some support for the hypothesis that vegetation cover change affects local rainfall.

%figure 16
\begin{figure}[ht!]
\centering
\includegraphics[scale=0.8]{bt4_qld.pdf}
\caption{Percentage of pixels showing statistically significant positive Z' values (left) and negative Z' values (right) in QLD at  p $<$ 0.1. The histogram shows the distribution of results from 1000 bootstrap resampling of the rainfall time series. The red dot represents the results from the observed data.}
\label{fig:boot_qld}
\end{figure}

%figure 17
\begin{figure}[ht!]
\centering
\includegraphics[scale=0.8]{bt4_nsw.pdf}
\caption{Percentage of pixels showing statistically significant positive Z' values (left) and negative Z' values (right) in NSW/VIC at p $<$ 0.1. The histogram shows the distribution of results from 1000 bootstrap resampling of the rainfall time series. The red dot represents the results from the observed data.}
\label{fig:boot_nsw}
\end{figure}


% chunk 81
<<chunk81,eval=F , echo = F, results = hide>>=

## calculate mean rainfall difference in two period for 11-year

  sel_neg.qld <- residual_qld[which(values(tr_qld.step.new)>=1.645)]

  sel_neg.nswvic <- residual_nswvic[which(values(tr_nswvic.step.new)>=1.645)]

## compare mean of before and after
## boxplot
  data.qld <- data.frame(year=seq(1998,2008,1))
  for (i in 1:length(sel_neg.qld)) {
    data.qld[,i+1] <- as.vector(rollapply(as.zoo(sel_neg.qld[[i]])[229:360],width=12,sum,by=12))
  }
  data2.qld <- melt(data.qld,id="year")
  data2.qld$group[data2.qld$year<2003] <- "1before"
  data2.qld$group[data2.qld$year>2004] <- "2after"


  data.nswvic <- data.frame(year=seq(1998,2008,1))
  for (i in 1:length(sel_neg.nswvic)) {
    data.nswvic[,i+1] <- as.vector(rollapply(as.zoo(sel_neg.nswvic[[i]])[229:360],width=12,sum,by=12))
  }
  data2.nswvic <- melt(data.nswvic,id="year")
  data2.nswvic$group[data2.nswvic$year<2003] <- "1before"
  data2.nswvic$group[data2.nswvic$year>2002] <- "2after"


## perform a 2 sample t test
  var.test(data2.qld[data2.qld$year<2003,3],data2.qld[data2.qld$year>2004 & data2.qld$year!=2006,3],alternative="two.sided")
## unequal variance
  t.test(data2.qld[data2.qld$year<2003,3],data2.qld[data2.qld$year>2004 & data2.qld$year!=2006,3],alternative="greater")
## p = 2.2e-16

  var.test(data2.nswvic[data2.nswvic$year<2003,3],data2.nswvic[data2.nswvic$year>2002& data2.nswvic$year!=2006,3],alternative="two.sided")
## unequal variance
  t.test(data2.nswvic[data2.nswvic$year<2003,3],data2.nswvic[data2.nswvic$year>2002& data2.nswvic$year!=2006,3],alternative="greater")
## p < 1.4e-13


  pdf("compare_mean.pdf")
  par(mfrow=c(1,2))
  boxplot(value~group,data=data2.qld,names=c("before","after"),boxwex=0.4,main="QLD site",ylab="rainfall (mm)")

  boxplot(value~group,data=data2.nswvic,names=c("before","after"),boxwex=0.4,main="NSW/VIC site")
  dev.off()

@

% chunk 82
<<chunk82,eval=F , echo = F, results = hide>>=
# identify whether 2006 is significantly different in the rainfall anomalies
require(ggplot2)  
  
residual_nswvic <- readRDS(file="residual_nswvic.RDS")
residual_qld <- readRDS(file="residual_qld.RDS")

## central QLD
  data_df <-  as.data.frame(t(do.call(rbind, residual_qld)))
  data_df$years <- rep(1979:2008,each=12)
  foo <- gather(data_df, key=pixel, value = anomaly,V1:V2800)
  qld_foo <- foo[foo$years>1996,]
  pl_qld <- ggplot(qld_foo,aes(x=as.factor(years),y=anomaly)) + geom_boxplot()
  pdf("QldrainfallAnomalyByYear.pdf")
  pl_qld
  dev.off()
  
  mod_qld <- aov(anomaly~as.factor(years),data=qld_foo)
  TukeyHSD(mod_qld)
  
## NSW/VIC
## treatment 1: excluding 2003
  data_df <-  as.data.frame(t(do.call(rbind, residual_nswvic)))
  data_df$years <- rep(1979:2008,each=12)
  foo <- gather(data_df, key=pixel, value = anomaly,V1:V1184)
  nsw_foo <- foo[foo$years>1996,]
  pl <- ggplot(nsw_foo,aes(x=as.factor(years),y=anomaly)) + geom_boxplot()
  pdf("NSWrainfallAnomalyByYear.pdf")
  pl
  dev.off()
  
  mod_nsw <- aov(anomaly~as.factor(years),data=nsw_foo)
  TukeyHSD(mod_nsw)
  

@
\section{Summary and Discussion}

Generally, empirical studies on LCC-precipitation interaction are conducted within an area with known land surface intervention \citep[e.g.][]{Otterman1990,Durieux2003,Negri2004,Sato2007}. However, these locations are rare and difficult to isolate from real landscape change. In this study we therefore tested the effect of land cover change across a broad region, rather than only for locations where changes were known to occur or have occured. The advantage of this approach is that it does not require a long time series of land cover data which is usually unavailable. Furthermore, it does not assume a specific relationship between vegetation cover change and rainfall but allows the data to show this relationship, by applying the analysis to a broader area outside the boundary of the vegetation cover change. This approach is expected to provide a way to reduce the risk of a false positive paradox, by comparing results between areas with and without vegetation cover change. 

Parametric tests are generally more powerful than nonparametric test in detecting a trend, when the data is normally distributed \citep{Onoz2003,Kundzewicz2004}. As a non-parametric test, the step trend test has the advantages of distribution free and having no restriction on missing data \citep{Hirsch1985}. This is particularly useful in rainfall analysis since rainfall data is usually skewed. On the other hand, the disadvantages of non-parametric tests, such as being limited to hypothesis testing and weaker in power, also hold for the step trend test \citep{Whitley2002}. 

The regression model used here is a simple model. We only consider the important effects of historical trend, seasonality and climate drivers. Furthermore, no more than two large scale climatic indices were used in order to avoid over-parameterisation and multiple cross-correlations between climatic indices. A purpose of the regression model is to remove the variability in rainfall that is due to these known important factors. The model shows that seasonality, ENSO and IOD together explain no more than 20\% of the rainfall variability, and around 6 - 8\% on average is due to the climate drivers. This is consistent with the literature \citep[e.g.][]{Westra2010}. A large amount of variation is left in the model residuals, which is likely due to random factors. Rainfall is generally considered a stochastic process \citep[e.g.][]{Fowler2005,Cowpertwait2009,Burton2010}. The high variability increases the difficulty to detect a change in rainfall. 

There was some evidence that a step change has occurred in the QLD region. The semi-parametric model could not identify any step change in the rainfall data. On the other hand, the step trend test suggested a couple of locations (300 - 500 km$^2$) might have experienced rainfall change ($p = 0.05$). The results from the step trend test also indicated a possible widespread change, but the spatial pattern of change is not consistent with the tree cover change map. Although land clearings in QLD have occurred at a high rate and broad scale \citep{SLATS2005}, this study cannot confirm its impact on the local rainfall. At this location, land cover change was not found to change the mean rainfall significantly in some other studies \citep[e.g.][]{Narisma2003,McAlpine2007}. The characteristics of vegetation cover changes in QLD might increase the difficulty in detecting a step change. QLD has a long history of land clearing. According to the series of SLATS reports on land cover changes in QLD released by the Queensland government, land clearing continued in and around the study region between 1988 - 2008. Major broad scale and high rate clearings occurred in 1999 - 2000 and 2002 - 2004. It is therefore difficult to define a clear cut change in this region. The more continuous ongoing land clearing could have reduced the significance of a step change. 
The two methods indicate quite different results on the level of change in the NSW/VIC region. The semi-parametric model showed that a large area in the NSW/VIC region has experienced significant step change ($p = 0.05$) in rainfall after 2003. But this result is likely to be affected by the low rainfall in 2006 as the area is larger than the bushfires region. The step trend test was able to detect significant changes ($p = 0.05$) in about 400 km$^2$ areas in the Snowy Mt. and some possible changes along the bushfires region ($p = 0.1$). This might be due to the possible small size of the step change and/or a short after-fire period \citep{Hirsch1985}. The vegetation cover change due to bushfires might have possibly changed the rainfall but the evidence was not strong either. 

The bushfires locations highlighted in the analysis results is an interesting outcome. The results might be due to a drought effect. The 2002 - 2003 drought has affected rainfall in a large part of Australia, particularly the MDB \citep{Nicholls2004}. The severe bushfires in 2003 were also triggered by the extreme drought conditions. Although the dry episode effect on rainfall has been accounted for in part by the SOI, further impact of drought could be passed through the local land-atmosphere interaction. However, this impact might not be statistically significant, even under an extreme event such as bushfires. Overall, the rainfall feedback to the vegetation cover change could be weak under dry conditions. 

The different causes of vegetation cover change in these two regions could lead to different post-change characteristics. The magnitude of EVI decreasing trends in the QLD region are less than in NSW region, as reported in the DLCD data. This is due to the lower tree density in the QLD region than in the NSW/VIC region before land surface interventions. Wild fires might have totally damaged the vegetation cover and recovery was very slow in some areas within the Snowy Mt. The persistent drought in the 2000s \citep{Howden2012} has delayed the regrowth of trees. On the other hand, replacing tree cover with pasture and crops might have a relatively subtle impact on the EVI. On the other hand, regrowth of trees can be expected after fires or as drought condition is relieved; but clearings for agricultural purpose impose permanent or semi-permanent changes to the land surface.

The rainfall data used in this study is a gridded data set. This data set is robust and consistent over a long time series (from 1900 to current) and has a broad national wide coverage which can provide more information spatially. However, high cross correlation between pixels due to the interpolation method generating this data set can also introduce spatial noise. Here the cross correlation has been account for in the step trend test. Some other methods are also available which can be used to perform a comparative trial. For example, \citet{Narisma2007} applied a spatial Gaussian filter on a similar data set and used wavelet analysis to detect step change in rainfall. High quality station data is another option to test whether the observed spatial pattern in the step trend test results was not due to the gridded data itself. Resampling methods, such as bootstrapping and permutation \citep{Wilks1997,Kundzewicz2004,Westra2013}, can also be used to further assess the strength of significance of results and incorporate spatial and temporal patterns in the analysis. We are also aware that the gridded data set is most useful in regions with sparse rain gauge networks but it actually reduces information where the rain gauge density is high \citep{Jones2009}. In the Snowy Mountains area, the coverage of rainfall stations is intensive but they are mainly located in the valleys. The interpolated data might not best represent the local rainfall.

Overall, the inclusion of the anomalous rainfall year 2006, could have influenced the results, and this means that strong conclusions cannot be drawn.

However, the current study provides some evidence to reject the null hypothesis (no step change in rainfall is due to the tree cover loss). Limited by the available data, the time frame under study was chosen within a long lasting drought period \citep{Holper2011}. The strong impact of this prolonged drought might have suppressed the land-atmosphere interaction and confused the cause and effect relation between rainfall and vegetation cover change. This could be one of the reasons that the LCC effects found in other studies \citep[e.g.]{Gorgen2006,McAlpine2007} are not found to be significant here. So possible future work can be conducted for a non-drought period, when a longer series of land cover data is available. This approach should be further assessed in different scenarios of wet period and/or afforestation. Continuous monitoring of land surface conditions is important for future research. The power of the test can also be improved with the longer length of the after-intervention period \citep{Hirsch1985}. But then the question is what is an appropriate length for land cover change study, when ongoing change is possible, such as tree regrowth or cropping. This will require further research.

\section{Conclusion}

In this study, we found some evidence, although not strong, that vegetation cover change has changed local rainfall. The semi-parametric method and non-parametric method did not reach an agreement on detecting significant step change in rainfall in the hot dry QLD region where land clearing has occurred. On the other hand, the bushfires in the humid temperate mountain range in the NSW/VIC region could have reduced rainfall. But the dry spell also plays an important role in the results. 

Drought has had a pronounced impact on the land surface condition during the study period, leading to significant reduction in vegetation and extreme events such as bushfires. The lack of rainfall associated and high temperature may cause a step change in the vegetation. Hence, the signal of LCC feedback on rainfall is probably weaker under such regional dry condition, as the impact of LCC on rainfall is mainly through changes in moisture convergence \citep{Gorgen2006,Pitman2007}.


\appendix

\section{Summary of Data}

 \begin{sidewaystable}
 \caption{Summary of data.}
  \label{tab:ch3Data}
 \begin{tabular}{lllll}
  \hline
  \textbf{Data} & \textbf{Source} & \multicolumn{2}{c}{\textbf{Resolution}} & \textbf{Analysis period} \\\cline{3-4}
  & & Temporal & Spatial & \\\hline
  Percent tree cover & MOD44B & Annual &	250m & 2000-2010\\
  Trend of vegetation cover change  &	DLCD (2009)	& Onetime & 250m	& Trend of Apr 2000 - Apr 2008\\
  Rainfall &	AWAP gridded rainfall data &	Monthly &	0.05\textdegree$\times$0.05\textdegree & Jan 1979- Dec 2008\\
  SOI	& BoM	& Monthly &	N/A &	Jan 1979- Dec 2008\\
  NINO 3, 3.4, 4 &	IRI/LDEO data library	& Monthly	& N/A	& Jan 1979- Dec 2008\\
  PDO	& NOAA & Monthly	& N/A	& Jan 1979- Dec 2008\\
  IOD	& POAMA-2 dataset	& Monthly	& N/A	& Jan 1979- Dec 2008\\
  \hline
  \end{tabular}
\end{sidewaystable}

\newpage
\begin{acknowledgments}
CL was supported by an Australian Postgraduate Award for this work.
\end{acknowledgments}


%\bibliography
\bibliography{reflist_chap3}


\end{document}
