---
title: Detecting the impact of land cover change on observed rainfall.
author:
  - name: Chun X. Liang
    email: summer.chunliang@gmail.com 
    affiliation: a
  - name: Floris F. van Ogtrop
    email: floris.vanogtrop@sydney.edu.au 
    affiliation: a
  - name: R. Willem Vervoort
    email: willem.vervoort@sydney.edu.au
    affiliation: a
    footnote: Corresponding Author
address:
  - code: a
    address: Sydney Institute of Agriculture, The University of Sydney, NSW 2006
abstract: |
  Analysis of observational data to identify relationships between rainfall and land cover change are difficult due to multiple environmental factors that cannot be strictly controlled. In this study we present a methodology to investigate the relationship using statistical methods on data from best available sources at two sites in Australia. Gridded data of rainfall and tree cover were used as spatially corresponding local conditions. Large scale effects were represented by climatic indicators, such as SOI and IOD. Regression analysis and step trend tests were used to assess the effect of abrupt land surface intervention. 
  At a Queensland site, significant tree cover change between 2002 - 2005 did not result in strong statistically significant precipitation changes. On the other hand, results from a bushfire affected NSW/VIC region suggests significant changes in the rainfall. This indicates the method works better when a abrupt change in the data can be clearly identified. The results from the step trend test implied a positive relationship between the tree cover and the rainfall at 0.1 significance level in both locations in data up to 2009. However, high rainfall variability and possible regrowth meant that no signifcant changes were observed in alonger time sereies to 2015. 

journal: "Journal of Hydrology Regional Studies"
date: "`r Sys.Date()`"
bibliography: reflist_chap3.bib
output: 
 bookdown::pdf_book:
    base_format: rticles::elsevier_article
---
```{r packages, echo=F, warnings=F, message=F, eval=T}
require(knitr)
require(bookdown)
require(pander)
library(fields)
library(graphics)
library(maptools)
#library(plotKML)
library(raster)
library(reshape)
library(rgeos)
library(rgdal)
library(RColorBrewer)
library(tidyverse)
require(lubridate)
library(deseasonalize)
library(mgcv)
library(ncdf4)
require(gridExtra)
#library(nnet)
```

```{r setup, warning=F, message=F, echo =F}
# root dir
knitr::opts_knit$set(root.dir = 
                       "C:/Users/rver4657/ownCloud/chun/chun/manuscripts/Rainfall_Landuse_paper")
```


Introduction
==========

Land use and land cover changes can lead to changes in the local climate. Empirical and modelling studies have found cloud types and rainfall are correlated to large scale vegetation cover changes, such as deforestation in the Amazon and in the Sahel [@Chagnon2005;@Pinto2009; @Wang2009; @Mei2010; @kucharski_further_2013; @pitman_scale_2016] and afforestation in south Israel [@Otterman1990; @Ben-Gai1998]. Using airborne measurement in Western Australia, @Junkermann2009 showed a significantly higher level of aerosols over an agricultural area compared to an adjacent natural vegetation. They suggested that a modification of aerosol concentrations due to deforestation could have contributed to a reduction of local rainfall, as more, but smaller rain droplets were observed. @Nair2011 reported from the Bunny Fence Experiment in Western Australia that local land use change altered the synoptic west coast trough dynamics and surface roughness, and this resulted in an observed rainfall decrease. Maximum temperatures were also found to be sensitive to land cover change in eastern Australia [@McAlpine2007]. 

Overall the number of empirical studies analyzing changes to rainfall due to land cover change from observational data is limited. Most of the studies mentioned previously were either model simulations, or comparisons of modelled data with observations. This is because there are some fundamental experimental difficulties in both space (where does evaporated water reappear as rainfall?) and in time (how much time does it take for land cover change effects to appear or disappear?). In addition, in many areas across the globe rainfall variability is related to complex set of interactions, of which land use change might only be a minor component.

Locally, there are two main sources that generate rainfall: moisture from advective atmospheric transport; and local evapotranspiration [@Eltahir1996; @Bosilovich2006; @Dirmeyer2009; @Gimeno2010]. The local evapotranspiration component is the component considered to be affected by land use change [@Eltahir1996]. According to @Trenberth1999, the contribution of advective moisture partially depends on the availability of external moisture and atmospheric transport. On the longer time scale, such as monthly and annually, large scale atmospheric dynamics are affected by large scale climate drivers. For example, many studies have reported significant relationships between rainfall in large parts of Australia and the El Niño-Southern Oscillation (ENSO) [@Verdon2004; @Risbey2009; @Speer2011]. In contrast, local ET is determined by local land surface characteristics, which influence local scale atmospheric dynamics and hence the amount of rainfall, including contribution from both main sources. Therefore land surface is suggested to play an important role in local rainfall. 


Although climate drivers demonstrate some capability to predict Australian rainfall, there is still a large amount of unexplained variance. @Westra2010 pointed out that models based on global sea surface temperature anomalies can only predict up to 14.7\% of annual precipitation variance. Some of the remaining variance could be due to land surface processes as suggested in studies predicting local rainfall [e.g. @Ma2011; @Zeng2012; @pitman_scale_2016; @saha_investigating_2016]. However, they are mostly based on modelling experiments and little evidence was reported from observations. However, @Pitman2004 found a good match between observations and simulated rainfall changes in southwest Western Australia ,forced by land cover change. @Timbal2006 were able to reproduce the rainfall decline in south west Australia by including land cover influence. In addition, local land use change might not be a primary, but is likely to be a secondary cause of rainfall change [@Nicholls2006]. 

Therefore, the aim of this study is to expand the available methodology to use empirical evidence at regional scales to investigate the cause and effect relationship between land cover change and local rainfall. More specifically, we hypothesize that a step change on the land cover on the surface will cause a step change in the rainfall. To demonstrate the approach and this effect we applied the methodology to study the changes in rainfall at two locations in Queensland and NSW/Victoria where there are possible step changes in land cover change due to land clearing and bush fires. The methodology is mainly based on statistical approaches to identify changes in rainfall, which were subsequently associated with land cover change through spatial comparison.

In this paper, after this section (the introduction), section 2 covers the case study areas and the observed land use change. Section 3 describes the data used in the study in more detail. Section 4 details the statistical methods and the underlying assumptions related to the modelling approach, Section 5 gives the results, which are further discussed in section 6 and finally section 7 offers the conclusions.  

Study regions and tree cover change
===================================

We use two areas in Australia to demonstrate the approach. In Australia, significant tree cover change has mainly occurred in the north east of the continent and on the southeast coast, as well as in the southwest of Western Australia. According to the National Dynamic Land Cover Dataset (DLCD) [@Lymburner2010], most of these areas have experienced decreasing EVI post 2000. As an index for vegetation greenness, the decreasing values indicate lower biomass over time in the tree cover regions. The possible EVI reduction might be due to land clearing, bush fires or drought.  

```{r selreg, fig.cap="Selected study regions are highlighted by red rectangles in the main map (the red rectangle in the insert indicates the location of the main map). The types of tree cover in 2008 from the DLCD product is shown at the background. In site 1 (the QLD region), the tree cover is mostly sparse. In site 2 (the NSW/VIC region), many areas have open or close forest in which tree cover is denser.", out.width="90%", echo=F}  

include_graphics("figures/map_selreg.jpg")
```
  
Two regions were selected where significant tree cover change was reported. The first region is located in south central Queensland to the north of the Murray Darling Basin (MDB) (site 1 in Figure \@ref(fig:selreg). High rates of land clearing have been reported in this region during the early 2000s [@SLATS2004]. The second study region is located at the border of New South Wales and Victoria, and includes the Snowy Mountain ranges (site 2 in Figure \@ref(fig:selreg). Severe bush fires occurred in this area and the surroundings in early 2003 (see Figure \@ref(fig:figure2bushfire)). The 2003 bush fires were the largest and the worst in this area for the last 60 years [@Fire2011]. Two thirds of Kosciuszko national park was heavily burned and regrowth was reported to be slow due to drought and cold conditions [@ABC2003] and the type of species in this region. However, in the longer term, after an early high transpiration period a recovery of pre-fire evapotranspiration would be expected [@Kuzcera1987]. As a result , significant tree cover loss has happened in both study areas in the last decade, either permanently or temporarily.  

```{r figure2bushfire, fig.cap = "Location of bushfires occurring in January 2003, in and around the NSW/VIC study region, as shown by the red pixels. The map shows large area in the Kosciuszko national park has been burned. Some locations in the southwest of ACT have also experienced intensive bushfires.", out.width="90%", echo=F}
include_graphics("figures/bushfire_nswvic.jpg")
```


The two regions have different climate characteristics. The QLD region is partially grassland and partially subtropical, while the NSW/VIC region is mainly within the temperate zone, under the Köppen classification. According to Australian Bureau of Meteorology (BoM), the NSW/VIC region receives 1000 - 2000 mm rainfall annually, which is more than double of the rainfall in the QLD region. Evapotranspiration is similar in both regions. Marine moisture and orographic effects are likely to be the main contributors to rainfall in the southeast mountain areas of the NSW/VIC region. 

The land use and land cover characteristics in the two regions are also different. In the Queensland region, the tree cover is sparse over most of the area. The MODIS satellite tree cover data (discussed in more detail in section 3) shows that tree cover in this region is generally below 20\% of total ground area. Grazing is the main activity in this region, with over 90\% of land used by the grazing industry [@ABARES2010]. Our starting assumption is that the main cause of the EVI  decline over large part of the region is due to land clearing. Tree cover has been cleared at a massive scale over the last decade, especially during 2002 - 2004. The Kosciuszko national park is within the NSW/VIC region. Here tree cover is denser with open or even closed forest (the tree cover distribution is bimodal at 10 - 20\% and 60 - 70\%). The dominant species in the alpine area are Snow Gum and large stand species such as Alpine Ash and Mountain Gum in the sub-alpine area. These trees can reach a great height but they take long time to grow. For example, Alpine Ash would need about 20 years to mature. Although land clearing is not a major issue in this region, it is vulnerable to fires and drought. 

Therefore two types of land cover changes were studied. The reports from the Queensland Statewide Land Cover and Trees Study (SLATS) [e.g. @SLATS2001; @SLATS2017] were used to investigate the time and location of land clearing in the QLD region. The MODIS burned area product, MCD45A1 [@Roy2002; @Roy2005; @Roy2008], was used to locate bush fires areas in the NSW/VIC region, with a grid resolution of 500 m. MCD45A1 provides monthly burning information on all pixels, which helps to pinpoint an abrupt event. Due to the nature of the different land cover change, the post-change vegetation status in the two regions is expected to be different (see Figure \@ref(fig:figure3-tc-simple)). 

```{r figure3-tc-simple, fig.cap= "The expected evolution of the land surface after trees have been removed in (a) the QLD region and (b) the NSW/VIC region.", out.width="90%", echo=F}
include_graphics("figures/tc_simple.jpg")
```


```{r mapping, echo = F, eval=F}
  
## define the boundary of sub-regions
   e1 <- extent(c(1324304.091,1723901.773,-222556.668,80451.265))
   e2 <- extent(c(1346395.141,1534425.527,-1169402.246,-607644.171))
  # 
   e11 <- extent(c(145.425, 149.025, -28.475, -25.175))
   e22 <- extent(c(146.675, 149.325, -37.075, -34.675))

  e111 <- extent(c(145.825, 148.625, -28.075, -25.575)) 
  e222 <- extent(c(147.075, 148.925, -36.675, -35.075)) 

## the selected regions for mapping
root_dir <- "c:/users/rver4657/owncloud/chun/chun/data"
aus_reg <- readShapePoly(paste(root_dir,
                               "Geo\\aus_state2011\\STE11aAust.shp",sep="/"),
                         proj4string=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0"))
aus_reg2 <- gSimplify(aus_reg,0.01,topologyPreserve=T)

mdb_reg <- readShapePoly(paste(root_dir,
                               "Geo\\MDB\\mdb_boundary.shp", sep="/"),
                               proj4string=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0"))
mdb_reg2 <- gSimplify(mdb_reg,0.01,topologyPreserve=TRUE)

#remove(list=c("aus_reg","mdb_reg"))

## Burned area map

fire_0301 <- raster(paste(root_dir,
          "Other\\bushfires\\Burnt_Area\\tmpA2003001.burndate.jpg",
                          sep="/"))
fire_0301nsw <- crop(fire_0301,e2)
fire_loc <- crop(reproject(fire_0301nsw,
                           CRS=CRS("+proj=longlat +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84")),
                 e222)
remove(list=c("fire_0301","fire_0301nsw"))

  jpeg("../../figures/bushfire_nswvic.jpg", width=960, height=960)
  par(mar=c(3,3,1,6),xpd=T)
  plot(e222,border="white")  
  image(fire_loc,add=T, breaks=c(0,0.99,366.5,10000),col=c("white","red","white"))
  plot(e222,add=T)
  plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
#   text(1430000,-1000000,"study region",cex=1.2)
  text(149.1, -35.3,"ACT",font=2,cex=1.2)
  text(148.4, -36,"Kosciuszko",font=2,cex=0.9)#,srt=90)
  text(147.5, -36.4,"VIC",font=2,cex=1.2)
  text(148, -35.5,"NSW",font=2,cex=1.2)
  image.plot(zlim=c(0,1),breaks=c(0,0.5,1),lab.breaks=c("","burned \narea",""),legend.only=T,horizontal=F,col=c("red","red"),legend.shrink=0.03,legend.width=1.3,legend.args=list(text="",line=0),lwd.poly=0.1)
legend(149,-36.1,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=0.9)
 dev.off()

 
Data <- read_csv(paste(root_dir,
          "/Other/slats/SLATSOverviewClearing20180814.csv",
          sep=""))


jpeg("../../figures/slats.jpg", width=1024, height = 760)
Data %>% 
  gather(key="Year",value="clearing", `1988-1989`:`2014-2015`) %>%
  filter(Bioregion == "Mulga Lands" |
           Bioregion == "Brigalow Belt") %>%
  ggplot(aes(Year,clearing, fill=Bioregion)) + 
  geom_bar(stat="identity") + ylab("Clearing (ha)") +
  scale_fill_grey() +
  theme(axis.text.x = element_text(size = rel(2),
                                   angle = 45, vjust=0.5),
        axis.text.y = element_text(size = rel(2)),
        axis.title = element_text(size = rel(2), face = "bold"),
        legend.text = element_text(size = rel(2)),
        legend.title = element_text(size = rel(2), face = "bold"))
dev.off() 
 
```

```{r treeCover,eval=F , echo = F}

rootdir <-"C:/users/rver4657/owncloud/chun2/data/satellite/MOD44/B"

# read in the file list from the directory
x <- dir(path=rootdir,pattern="Percent_Tree_Cover.tif")
# Identify the different states in the images
# NSW
NSW <- x[grep("NSW",x)]
# Qld
Qld <- x[grep("Qld",x)]

img <- list()
# raster and brick
for(i in 1:length(NSW)) {
  img[[i]] <- raster(paste(rootdir,NSW[i],sep="/"))
}

imgQ <- list()
# raster and brick
for(i in 1:length(Qld)) {
  imgQ[[i]] <- raster(paste(rootdir,Qld[i],sep="/"))
}

NSW_b <- do.call(brick,img)
Qld_b <- do.call(brick, imgQ)

tm <- seq(as.Date("2000-03-06"), as.Date("2016-03-06"), "year")
mod_tc_r22 <- setZ(NSW_b, tm, "year")

mod_tc_r11 <- setZ(Qld_b, tm, "year")

## apply t-test to tree cover data
fun <- function(x,m) {
  var_x <- sd(x,na.rm=T)
  mu_1 <- mean(x[1:3],na.rm=T)
  # m = 1 Queensland, 
  if (m==1) {y <- x[4:16]} else {
    # NSW whole series m = 2
    if (m ==2) {y <- x[4:16]} else {
      # build in other possibilities for length series
      y <- x[4:(16 - m)]
    }  
  mu_2 <- mean(y,na.rm=T)
  z <- (mu_2-mu_1)/var_x
  if (!is.na(z) & abs(z)>1.645) {return(mu_2-mu_1)} else {return(NA)}
  }
}

# Qld
mod_tc_r1.z <- calc(mod_tc_r11,function(x) fun(x,1))
# Qld 2011
mod_tc_r1_7y.z <- calc(mod_tc_r11,function(x) fun(x,5))
# NSW
mod_tc_r2.z <- calc(mod_tc_r22,function(x) fun(x,2))
# # NSW only 5 years after
# mod_tc_r2_5y.z <- calc(mod_tc_r22,function(x) fun(x,7))
# NSW 7 years after (2011)
mod_tc_r2_7y.z <- calc(mod_tc_r22,function(x) fun(x,5))
# # NSW 9 years after
# mod_tc_r2_9y.z <- calc(mod_tc_r22,function(x) fun(x,3))


plotclr <- brewer.pal(8,"PiYG")

jpeg("../../figures/tc_figs.jpg", width=1280, height=960, quality=100)
par(mar=c(3,3,2,11),mfrow=c(2,2))
# Qld 7 year 2011
plot(e111, cex.axis=1.5, font.axis=2, ylab="")
image(mod_tc_r1_7y.z,col=plotclr,breaks=c(-70,-20,-10,-5,0,5,10,20,70),
      legend=F,add=T)
#plot(e111,add=T)
plot(aus_reg2,border="grey",add=T)
plot(mdb_reg2,border="grey",lwd=3,add=T)
legend(146,-27.5,c("State","MDB"),col=c("grey","grey"),
       lwd=c(1,3),bty="n",title="Boundary",cex=1.8)
image.plot(zlim=c(-4,4), breaks=c(-4,-3,-2,-1,-0.2,0.2,1,2,3,4),
           lab.breaks=c(-70,-20,-10,-5,"no tree","0 or",5,10,20,70),
           legend.only=T,horizontal=F,
           col=c("#C51B7D","#DE77AE","#F1B6DA","#FDE0EF","white",
                 "#E6F5D0","#B8E186","#7FBC41","#4D9221"),
           legend.shrink=0.8,
           legend.width=1.5,
           legend.args=list(text=expression(paste(Delta,
                            "tree (% ground)",sep="")),
                            line=1,cex=1.3,font=2),
           axis.args=list(cex.axis=1.5),graphics.reset=F)

par(mar=c(3,9,2,5))
plot(e111, cex.axis=1.5, font.axis=2, ylab="")
image(mod_tc_r1.z,col=plotclr,breaks=c(-70,-20,-10,-5,0,5,10,20,70),
      legend=F,add=T)
#plot(e111,add=T)
plot(aus_reg2,border="grey",add=T)
plot(mdb_reg2,border="grey",lwd=3,add=T)
# image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,-0.2,0.2,1,2,3,4),
#            lab.breaks=c(-70,-20,-10,-5,"no tree","0 or",5,10,20,70),
#            legend.only=T,horizontal=F,
#            col=c("#C51B7D","#DE77AE","#F1B6DA","#FDE0EF","white",
#                  "#E6F5D0","#B8E186","#7FBC41","#4D9221"),
#            legend.shrink=0.7,
#            legend.width=0.7,
#            legend.args=list(text=expression(paste(Delta,
#                             "tree (% ground)",sep="")),
#                             line=0.5,cex=0.9,font=2),
#            axis.args=list(cex.axis=0.8),graphics.reset=F)
# 2011 NSW
par(mar=c(3,3,1,11))
plot(e222, cex.axis=1.5, font.axis=2, ylab="")
image(mod_tc_r2_7y.z,col=plotclr,breaks=c(-70,-20,-10,-5,0,5,10,20,70),
      legend=F,add=T)
#plot(e111,add=T)
plot(aus_reg2,border="grey",add=T)
plot(mdb_reg2,border="grey",lwd=3,add=T)
image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,-0.2,0.2,1,2,3,4),
           lab.breaks=c(-70,-20,-10,-5,"no tree","0 or",5,10,20,70),
           legend.only=T,horizontal=F,
           col=c("#C51B7D","#DE77AE","#F1B6DA","#FDE0EF","white",
                 "#E6F5D0","#B8E186","#7FBC41","#4D9221"),
           legend.shrink=0.8,
           legend.width=1.5,
           legend.args=list(text=expression(paste(Delta,
                            "tree (% ground)",sep="")),
                            line=1,cex=1.3,font=2),
           axis.args=list(cex.axis=1.5),graphics.reset=F)

# FULL PERIOD NSW
par(mar=c(3,9,1,5))
plot(e222, cex.axis=1.5, font.axis=2, ylab="")
image(mod_tc_r2.z,col=plotclr,breaks=c(-70,-20,-10,-5,0,5,10,20,70),
      legend=F,add=T)
#plot(e111,add=T)
plot(aus_reg2,border="grey",add=T)
plot(mdb_reg2,border="grey",lwd=3,add=T)
# image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,-0.2,0.2,1,2,3,4),
#            lab.breaks=c(-70,-20,-10,-5,"no tree","0 or",5,10,20,70),
#            legend.only=T,horizontal=F,
#            col=c("#C51B7D","#DE77AE","#F1B6DA","#FDE0EF","white",
#                  "#E6F5D0","#B8E186","#7FBC41","#4D9221"),
#            legend.shrink=0.7,
#            legend.width=0.7,
#            legend.args=list(text=expression(paste(Delta,
#                             "tree (% ground)",sep="")),
#                             line=0.5,cex=0.9,font=2),
#            axis.args=list(cex.axis=0.8),graphics.reset=F)
dev.off()


jpeg("../../figures/map.jpeg", width=960, height=960)
par(mar=c(1.5,1.5,1.5,1.5))
plot(mdb_reg2,border="grey",lwd=3)
plot(aus_reg2,border="grey",add=T)
legend(150.2,-36,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=1.5)
#invisible(text(getSpPPolygonsLabptSlots(aus_reg2), labels=as.character(aus_reg2$NAME), cex=0.7,adj=0.5))
box(lty=1)
plot(e111,col="red",add=T)
plot(e222,col="red",add=T)
text(147.2,-26.8,"QLD",cex=1.5)
text(148,-34.7,"NSW/VIC",cex=1.5)
dev.off()

```

The hypothesis in this study therefore is that the effect of 2003 - 2004 land clearings in the QLD region and the 2003 bush fires in the NSW/VIC region cause a step change in the local rainfall. The actual tree cover change at the pixel level during this time was derived from the 15-year MODIS data (discussed below). The difference of tree cover before and after the land disturbance was tested using a Student's t-test. As the length of the tree cover data is shorter than available rainfall data, earlier land clearings in the QLD region cannot be identified spatially, hence they are excluded from the analysis.

## Data {#Data}

Several land surface data sets were used in this study. The main one was the MOD44B product Global Vegetation Continuous Field data set (version 5). This data set provides estimates of percent tree cover (percentage of ground surface covered by trees) at a grid resolution of 250 m [@Townshend2011], which is finer then the earlier mentioned burned product MCD45A1. The data set is available on an annual time interval for the study period of 2000 - 2015. The tree cover data was produced from 16-day Terra MODIS Land Surface Reflectance data and Land Surface Temperature [@Townshend2011]. The National Dynamic Land Cover Dataset (DLCD) [@Lymburner2010] from the Australian Collaborative Land Use Mapping Program (ACLUMP) was used to verify the trend of vegetation cover change calculated from the previous data set. This data set, developed by Geoscience Australia and Australian Bureau of Agricultural and Resource Economics and Sciences (ABARES), is the first nationally consistent and thematically comprehensive land cover reference for Australia. The DLCD is based on the 16-day Enhanced Vegetation Index (EVI), again from the MODIS satellite, between April 2000 and April 2015. It also has a grid resolution of 250 m. The data set provides information on the final land cover types (as in 2015) and estimated trend of EVI statistics (annual mean, maximum and minimum). 

Rainfall data for Australia [@Jones2009] was obtained from the Bureau of Meteorology. The data has been projected onto a national 0.05\textdegree × 0.05\textdegree grid (approximately 5 km × 5 km). This gridded data set was generated from station observations using an optimised Barnes successive correction technique. The Barnes technique combines a weighted averaging process and defined topographical information to estimate rainfall values between spatial points [@BoM2009]. The resulting data set provides additional information for data-sparse areas like central Australia but reduces information in the data-rich areas, such as southeast Australia where station density is up to 20 per 100 $\text{km}^2$. The data is available on a monthly basis from 1900 to current. Here a subset of 36 years (1979 - 2015) was used. The study was conducted on monthly data, as a land cover change effect on annual rainfall might be negligible but can often found to be significant in particular months or seasons [e.g. @Otterman1990; @Gaertner2001; @Semazzi2001; @Oleson2004; @Deo2009]. 

Large scale climate drivers are represented by various climatic indices. The Southern Oscillation Index (SOI) is generally regarded as a good predictor of Australian rainfall [@Risbey2009; @Chowdhury2010; @Westra2010], but its skill is weaker in some parts of Australia. For example the Southern Annular Mode (SAM) is found to be more important than ENSO in south Western Australia [@Meneghini2007]. The suitability of each index for the regions of interest was tested in section \@ref(sec:reg_model). The following climate indices were used as candidate predictors for local rainfall. 

- Southern Oscillation Index (SOI). The Troup version of the monthly SOI series used in this study was obtained from BoM (available online at \url{http://www.bom.gov.au/climate/current/soihtm1.shtml}).  
- Eastern, East Central and Central Tropical Pacific Sea Surface Temperatures (NINO 3, NINO 3.4 and NINO 4). Monthly SST anomalies are available from IRI/LDEO data library and the extended NINO data set is used (available online at \url{http://iridl.ldeo.columbia.edu/SOURCES/.Indices/.nino/.EXTENDED/}).   
- Pacific Decadal Oscillation (PDO). The Pacific Decadal Oscillation is the leading principal component of monthly SST anomaly in the North Pacific Ocean.. The monthly PDO series was provided by JISAO (Joint Institute for the Study of the Atmosphere and Ocean, University of Washington) (available online at \url{http://jisao.washington.edu/pdo/PDO.latest}).  
- Indian Ocean Dipole (IOD). The Indian Ocean dipole is commonly measured by the difference between SST anomaly in the western (50 - 70\textdegree E and 10\textdegree S-10\textdegree N) and eastern (90 - 110\textdegree E and 0 - 10\textdegree S) equatorial India Ocean [@Saji1999]. Monthly IOD was obtained from JAMSTEC (the Japan Agency for Marine-Earth Science and Technology) (available online at \url{http://www.jamstec.go.jp/frcgc/research/d1/iod/DATA/dmi.monthly.txt}).  

```{r climaticIndex,eval=F , echo = F}

# climate indicator data
file1 <- "../..\\Data\\BoM\\SOI\\SOI.csv"
SOI <- read_csv(file1)
SOI <- gather(SOI,key="Month", value="SOI",Jan:Dec)
SOI <- SOI[order(as.Date(paste(SOI$Year,SOI$Month,
                                        "01",sep="-"), "%Y-%b-%d")),]
SOI_100a <- SOI %>%
  filter(Year > 1899 & Year < 2016)
SOI_30a <- SOI %>%
  filter(Year > 1978 & Year < 2016)
## deseasonalised SOI
SOI_100 <- ds(SOI_100a$SOI, ic = "AIC", type = "monthly",
              standardizeQ=F)$z
SOI_30 <- ds(SOI_30a$SOI, ic = "AIC", type = "monthly",
             standardizeQ=F)$z

file2 <- "../..\\Data\\BoM\\SST\\SST34_anomaly.nc"
SST34 <- nc_open(file2)
SST34_var <- ncvar_get(SST34,SST34$var[[1]])
nc_close(SST34)
SST34_df <- tibble(Date = seq.Date(as.Date("1856-01-01"),
                                   as.Date("2018-04-01"),
                                   by="month"),
                   SST34 = SST34_var)
SST34_100a <- SST34_df %>%
  filter(Date >= "1900-01-01" & Date < "2016-01-01")
SST34_30a <- SST34_df %>%
  filter(Date >= "1979-01-01" & Date < "2016-01-01")
## deseasonalised SST34
SST34_30 <- ds(SST34_30a$SST34,ic = "AIC", type="monthly",
               standardizeQ=F)$z
SST34_100 <- ds(SST34_100a$SST34,ic = "AIC", type="monthly",
               standardizeQ=F)$z

file3 <- "../..\\Data\\BoM\\SST\\SST3_anomaly.nc"
SST3 <- nc_open(file3)
SST3_var <- ncvar_get(SST3,SST3$var[[1]])
nc_close(SST3)
SST3_df <- tibble(Date = seq.Date(as.Date("1856-01-01"),
                                   as.Date("2018-04-01"),
                                   by="month"),
                   SST3 = SST3_var)
SST3_100a <- SST3_df %>%
  filter(Date >= "1900-01-01" & Date < "2016-01-01")
SST3_30a <- SST3_df %>%
  filter(Date >= "1979-01-01" & Date < "2016-01-01")
## deseasonalised SST3
SST3_30 <- ds(SST3_30a$SST3,ic = "AIC", type="monthly",
              standardizeQ=F)$z
SST3_100 <- ds(SST3_100a$SST3,ic = "AIC", type="monthly",
              standardizeQ=F)$z

file4 <- "../..\\Data\\BoM\\SST\\SST4_anomaly.nc"
SST4 <- nc_open(file4)
SST4_var <- ncvar_get(SST4,SST4$var[[1]])
nc_close(SST4)
SST4_df <- tibble(Date = seq.Date(as.Date("1856-01-01"),
                                   as.Date("2018-04-01"),
                                   by="month"),
                   SST4 = SST4_var)
SST4_100a <- SST4_df %>%
  filter(Date >= "1900-01-01" & Date < "2016-01-01")
SST4_30a <- SST4_df %>%
  filter(Date >= "1979-01-01" & Date < "2016-01-01")
## deseasonalised SST4
SST4_30 <- ds(SST4_30a$SST4,ic = "AIC", type="monthly",
              standardizeQ=F)$z
SST4_100 <- ds(SST4_100a$SST4,ic = "AIC", type="monthly",
              standardizeQ=F)$z

file5 <- "../..\\Data\\BoM\\PDO\\PDO.latest_1900-.txt"
pdo_mth <- read_table(file5)
pdo_mth <- gather(pdo_mth,key="Month", value="PDO", JAN:DEC)
pdo_mth$YEAR <- substr(pdo_mth$YEAR,1,4)
pdo_mth <- pdo_mth[order(as.Date(paste(pdo_mth$YEAR,pdo_mth$Month,
                                        "01",sep="-"), "%Y-%b-%d")),]
PDO_100a <- pdo_mth %>%
  filter(YEAR > 1899 & YEAR < 2016)
## deseasonalised PDO
PDO_100 <- ds(PDO_100a$PDO,ic = "AIC", type = "monthly",
              standardizeQ=F)$z

file7 <- "../..\\Data\\BoM\\IOD\\iod_jamstec.txt"
IOD <- read_table2(file7)
IOD <- tibble(Date = seq.Date(as.Date("1870-01-16"),
                                   as.Date("2018-03-16"),
                                   by="month"),
              IOD = IOD$`DMI(=West-East)`)
IOD_30a <- IOD %>%
  filter(Date > "1979-01-01" & Date < "2016-01-01")
IOD_100a <- IOD %>%
  filter(Date > "1899-01-01" & Date < "2016-01-01")
## deseasonalised IOD
IOD_30 <- ds(IOD_30a$IOD, ic = "AIC", type = "monthly",
             standardizeQ=F)$z
IOD_100 <- ds(IOD_100a$IOD, ic = "AIC", type = "monthly",
             standardizeQ=F)$z
# end of read data
# should write out useful data
save.image("../../data/data_environment.Rdata")
```

## Statistical method

The step changes on rainfall were analysed using two different statistical methods. A step change is not obvious in the time series data of the rainfall residuals (Figure \@ref(fig:ts-mean)), even though the data is deseasonalised and detrended.  Both methods in this paper make use of a regression model to remove variability in rainfall due to climatic factors to strengthen the tree cover change signal. In the first method, the tree cover change was implemented as a factor variable in the regression model. In the second method, a rank sum test (step trend test), was applied to the model residuals after effects of other major factors were removed. This assumes that after removal of all climate variation, the vegetation cover change is the only factor explaining the non-random pattern in the rainfall residuals.

```{r ts-mean, echo = F, fig.cap = "The deseasonalised and detrended rainfall over the 30 years period in (a) the QLD region and (b) the NSW/VIC region. The vertical red lines indicate the year of 2003, in which the studied land cover changes occurred. A change in the time series data is not obvious before and after the land cover changes.", out.width="90%", echo=F}

include_graphics("figures/Rainfall_resid.jpg")
```


### Regression model {#reg_model}

As highlighted in the introduction, the Australian climate is influenced by sea surface temperatures in the tropical Pacific and Indian Oceans, as well as pressure systems in the Southern Ocean [@BoM2012].  @Risbey2009 compared five large-scale drivers, including ENSO (measured by SOI and the Tropical Pacific SSTs), IOD, SAM, MJO (Madden-Julian oscillation) and blocking, in relation to Australian rainfall variability. The MJO is a large scale eastward-propagating wave-like disturbance in equatorial latitudes [@Risbey2009]. They identified SOI as the most important index among all indices tested for broad parts of Australia (including QLD and NSW/VIC) in almost any season. In this study, four indices were selected from the main climatic indicators (see section [Data]) were used as the explanatory variables in the model for each study region.

```{r climateData, echo=F, eval=F}
load("../../data/data_environment.Rdata")

# read in the BOM gridded rainfall data extracted earlier
rain <- readRDS("../../data/bom/rainfall/Raindata.rds")
# dim(rain)
# 43829 columns (days from 19000101) by 4161 locations (rows)

# split by Qld and NSW
# NSW has first 1254 locations (columns) Qld other 2907
rainNSW <- rain[1:1254,]
rainQld <- rain[1255:4161,]
rm(rain)

# summarise to monthly
# NSW
rainNSW_t <- as.tibble(data.frame(Date = 
                                    seq.Date(as.Date("1900-01-01"),
                                    as.Date("2015-12-31"),by=1),
                    rain=t(rainNSW)))
rm(rainNSW)
rainNSW_t <- rainNSW_t %>% 
  mutate(Month = format(Date,"%Y-%m")) 
rain_monthNSW <- rainNSW_t %>%
  group_by(Month) %>%
  summarise_at(vars(starts_with("rain")), funs(sum = sum(.)))

# Qld
rainQld_t <- as.tibble(data.frame(Date = 
                                    seq.Date(as.Date("1900-01-01"),
                                    as.Date("2015-12-31"),by=1),
                    rain=t(rainQld)))
rm(rainQld)
rainQld_t <- rainQld_t %>% 
  mutate(Month = format(Date,"%Y-%m")) 
rain_monthQld <- rainQld_t %>%
  group_by(Month) %>%
  summarise_at(vars(starts_with("rain")), funs(sum = sum(.)))
rm(rainNSW_t, rainQld_t)

## 100 years data & 30 years
# Qld
qld_100 <- rain_monthQld
qld_30 <- qld_100 %>%
 filter(Month >= "1979-01")

qld100_mean <- qld_100 %>%
  mutate(Means = rowMeans(.[,-1])) %>%
  dplyr::select(Month,Means)
  
  
qld30_mean <- qld100_mean %>%
 filter(Month >= "1979-01")

# NSW
nsw_100 <- rain_monthNSW
nsw_30 <- nsw_100 %>%
 filter(Month >= "1979-01")

nsw100_mean <- nsw_100 %>%
  mutate(Means = rowMeans(.[,-1])) %>%
  dplyr::select(Month,Means)
  
  
nsw30_mean <- nsw100_mean %>%
 filter(Month >= "1979-01")


require(MASS)
fitdistr(qld30_mean$Means,"gamma")  ## assume shape=0.9
fitdistr(nsw30_mean$Means,"gamma")  ## assume shape =2.19
ks.test(qld30_mean$Means,"pgamma",0.90,0.03)
ks.test(nsw30_mean$Means,"pgamma",2,0.03)


jpeg("../../figures/hist_rainfall.jpg", width=960, height=480)
par(mfrow=c(1,2))
hist(qld30_mean$Means,main="",xlab=expression(paste("rainfall (mm mont",h^-1,")",sep="")))
 hist(nsw30_mean$Means,main="",xlab=expression(paste("rainfall (mm mont",h^-1,")",sep="")))
dev.off()

  
# autocorrelation in rainfall
acf_df <- data_frame(lag = 1:12, 
                     acf_Qld = acf(qld30_mean$Means,
                                   lag.max=12,main="QLD")$acf[2:13,1,1],
                     acf_NSW = acf(nsw30_mean$Means,
                                   lag.max=12,main="NSW & VIC")$acf[2:13,1,1],
                     pacf_Qld = pacf(qld30_mean$Means,
                                     lag.max=12,main="")$acf[,1,1],
                     pacf_NSW = pacf(nsw30_mean$Means,
                                     lag.max=12,main="")$acf[,1,1])
                     
jpeg("../../figures/autocorrelation.jpg")
acf_df %>%
  gather(key="acf", value="cor", acf_Qld:pacf_NSW) %>%
  ggplot(aes(lag, cor)) + geom_bar(stat="identity", fill = "blue") +
  facet_wrap(~acf) + xlab("Lag") + ylab("correlation")
dev.off()
  
## deseasonalise & detrend rainfall: assume the deseasonalised monthly zonal rainfall is normal distributed and can be used in pearson cross-correlation function
## use stl function in R

## revision June 2018: change this to only deseasonalise using the 
# deseasonalise package
qld30_deseason <- ds(qld30_mean$Means,ic="AIC", type="monthly",
                     standardizeQ=F)$z
nsw30_deseason <- ds(nsw30_mean$Means,ic="AIC", type="monthly",
                     standardizeQ=F)$z
qld100_deseason <- ds(qld100_mean$Means,ic="AIC", type="monthly",
                      standardizeQ=F)$z
nsw100_deseason <- ds(qld100_mean$Means,ic="AIC", type="monthly",
                      standardizeQ=F)$z
  
  
# test whether any linear trends are significant
df_list <- list(qld30 = data.frame(z=qld30_deseason,
                           trend=1:length(qld30_deseason)),
                nsw30 = data.frame(z=nsw30_deseason,
                           trend=1:length(nsw30_deseason)),
                qld100 = data.frame(z=qld100_deseason,
                 trend=1:length(qld100_deseason)),
                nsw100 = data.frame(z=nsw100_deseason,
                 trend=1:length(nsw100_deseason)))
result <- lapply(df_list,
                 function(x) summary(lm(z~trend,
                                        data=x))$coefficients)
# none have a trend

# 
plot_df <- tibble(Dates = rep(ymd(paste(qld30_mean$Month,
                                        "01",sep="_")),2),
                  Resid = c(qld30_deseason,nsw30_deseason),
                  State = c(rep("Qld",length(qld30_deseason)),
                            rep("NSW",length(nsw30_deseason))))

jpeg("../../figures/Rainfall_resid.jpg", width=960, height=960)
plot_df %>%
  ggplot(aes(Dates,Resid)) + geom_line() + 
  geom_vline(xintercept = as.Date("2003-01-01"), 
             col="red", size=1.5) +
  geom_text(aes(x=as.Date("2004-12-01"),y=150),
            label="2003", col="red", size=7) +
  facet_wrap(~State, ncol = 1) + xlab("Date") +
  ylab("Deseasonalised rainfall for the NSW and Qld locations") +
  theme(axis.text=element_text(size=rel(2)),
        axis.title=element_text(size=rel(2.5)),
        strip.text =element_text(size=rel(2), face="bold"))
dev.off()  




# Figure 5
plot_df_qld <- tibble(Lag = ccf(as.vector(SOI_30),
                            as.vector(qld30_deseason),lag.max=12, 
                            plot=F)$lag[,,1],
                  SOI = ccf(as.vector(SOI_30),
                            as.vector(qld30_deseason),lag.max=12, 
                            plot=F)$acf[,,1],
                  NINO3.4 = ccf(as.vector(SST34_30),
                                as.vector(qld30_deseason),lag.max=12,
                                plot=F)$acf[,,1],
                  NINO4 = ccf(as.vector(SST4_30),
                              as.vector(qld30_deseason),lag.max=12,
                              plot=F)$acf[,,1],
                  PDO = ccf(as.vector(PDO_100),
                            as.vector(qld100_deseason),lag.max=12,
                            plot=F)$acf[,,1],
                  IOD = ccf(as.vector(IOD_30),
                            as.vector(qld30_deseason),lag.max=12, 
                            plot=F)$acf[,,1])

jpeg("../../figures/cor_qld.jpg", width=960, height=960)
plot_df_qld %>%
  gather(key="SST", value="correlation", SOI:IOD) %>%
  ggplot(aes(Lag,correlation)) + 
  geom_bar(fill="blue", stat="identity") +
  facet_wrap(~SST) + xlab("Lag in months") + ylab("correlation") +
  xlim(c(-12.5,0.5)) +
  theme(axis.text=element_text(size=rel(2)),
        axis.title=element_text(size=rel(2.5)),
        strip.text =element_text(size=rel(2), face="bold"))
dev.off()

# to add and calculate ci: qnorm((1 + 0.95)/2)/sqrt(x$n.used)

plot_df <- tibble(Lag = ccf(as.vector(SOI_30),
                            as.vector(nsw30_deseason),lag.max=12, 
                            plot=F)$lag[,,1],
                  SOI = ccf(as.vector(SOI_30),
                            as.vector(nsw30_deseason),lag.max=12, 
                            plot=F)$acf[,,1],
                  NINO3.4 = ccf(as.vector(SST34_30),
                                as.vector(nsw30_deseason),lag.max=12,
                                plot=F)$acf[,,1],
                  NINO4 = ccf(as.vector(SST4_30),
                              as.vector(nsw30_deseason),lag.max=12,
                              plot=F)$acf[,,1],
                  PDO = ccf(as.vector(PDO_100),
                            as.vector(nsw100_deseason),lag.max=12,
                            plot=F)$acf[,,1],
                  IOD = ccf(as.vector(IOD_30),
                            as.vector(nsw30_deseason),lag.max=12, 
                            plot=F)$acf[,,1])

jpeg("../../figures/cor_nswvic.jpg", width=960, height=960)
plot_df %>%
  gather(key="SST", value="correlation", SOI:IOD) %>%
  ggplot(aes(Lag,correlation)) + 
  geom_bar(fill="blue", stat="identity") +
  facet_wrap(~SST) + xlab("Lag in months") + ylab("correlation") +
  xlim(c(-12.5,0.5)) +
  theme(axis.text=element_text(size=rel(2)),
        axis.title=element_text(size=rel(2.5)),
        strip.text =element_text(size=rel(2), face="bold"))
dev.off()

```

Correlations between rainfall and each climate index were analysed. Rainfall in each study region was first deseasonalised and detrended using the seasonal decomposition function `ds` in the package `deseasonalise` in R [@Rstats2018]. Using detrended data gives a better indication of the underlying correlation rather than the correlation between trends in the data [@Smith2012]. 
The cross-correlations between the deseasonalised and detrended rainfall and the climatic indices were tested using the Pearson's product moment correlation method, assuming the relationships are linear. Although the optimal technique for exploring the correlation with each index could be different as described in @Risbey2009, the Pearson's method was applied to all indices for consistency. Because the PDO describes the multi-decadal SST with lower frequency [@MacDonald2005; @Zanchettin2008; @Kamruzzaman2011], instead of 37-year rainfall data, a longer period (115 years, from 1900 to 2015) was used to estimate the correlation with PDO, up to lag 24. For the other indices, the 37-year data was used.  

```{r cor-rain-qld, fig.cap="Cross-correlation of six climate indices and rainfall in QLD study region. For the PDO analysis, 108-year rainfall data (1900 - 2008) are used. Otherwise, 36-year rainfall data are used. The correlation with NINO 3 is not shown as it is very similar to but weaker than for NINO 3.4.", out.width="90%", echo=F}
include_graphics("figures/cor_qld.tif")
```

```{r cor-rain-nsw, fig.cap="Cross-correlation of six climate indices and rainfall in NSW/VIC study region.", out.width="90%", echo=F}
include_graphics("figures/cor_nswvic.tif")
```

Based on the correlation between the climatic indices and rainfall (as shown in Figure \@ref(fig:cor-rain-qld) and Figure \@ref(fig:cor-rain-nsw)), it can be concluded that:
\begin{itemize}
  \setlength{\itemsep}{0cm}
  \setlength{\parskip}{0cm}
  \item In QLD, the correlation between rainfall and SOI at zero time lags is the highest across all indices, outweighing the other ENSO indicators. IOD, had a weak influence in QLD.
  \item In NSW/VIC, again the SOI has the highest correlation with rainfall, followed by the IOD. Both occur at the zero time lags. 
  \item in both cases PDO had the weakest correlations, and this factor was not further considered as a predictor.
\end{itemize}
The above findings are consistent with previous studies. Although some indices are serially correlated with rainfall up to several months, the lag zero events have the most significant correlation coefficients. Concurrent climatic index series were generally found most useful in rainfall prediction [e.g. @Risbey2009; @Kamruzzaman2011]. The correlations between the climatic indices and rainfall for each individual season have also been tested, and the results were similar. 


Rainfall in Australia shows strong seasonal patterns [@Holper2011; @ABS2012]. For example, the north part of the country is summer rainfall dominant with a dry winter, while most of the southern part has a winter rainfall regime. This character is driven by the movement of subtropical high pressure systems which dominate the Australian climate [@BoM2012a]. These characteristic summer and winter rainfall patterns mean that the seasonal component of rainfall has a periodic pattern which should be included in the model.

Long term trends in the regional rainfall in some parts of Australia are significant [@Hughes2003; @Gallant2007; @Chowdhury2010]. In the northern and eastern parts of the continent, increasing rainfall is reported over the last century [@Hughes2003]. The presence of such long term trends may be confused with the outcome of a step change in rainfall. As a result a linear trend term was implemented in the model to remove any long term effect.

We assumed all the factors are additive smooth components in determining rainfall following @Kamruzzaman2011. Generally, monthly rainfall has a skewed distribution so the normality assumption of the residuals in a general linear model could be violated. In this case, the rainfall model is a generalised additive model (GAM) [@Hastie1986] with a log link function `g()` and assuming the residuals are gamma distributed (see Figure \@ref(fig:hist-rain)). This means all predictors are modelled as smooth functions, in this case using the shrinkage version of the cubic regression splines [@Wood2011].
\vspace{0.5cm}
\begin{equation}
\begin{array}{lll}
g(E(\mathbf{R}_r)) = &\beta_0 + s_1(\mathbf{SOI}) + s_2(\mathbf{IOD}) + \\                &s_3(\mathbf{Nino3.4}) + s_4(\mathbf{Nino4}) + s_5(\mathbf{Season}) + \\
           &\beta_1\mathbf{Trend} + \boldsymbol{\epsilon}_r
\end{array}
(\#eq:model)
\end{equation}
The bold letters represent the time series vectors.  The region is indicated by $r$, while $\beta_u$ ($_u$=0, 1) are the fitted coefficients in the model. $s_v$ ($_v$=1, 2, 3) are the smooth penalized cubic regression spline functions on the climatic indices and the season. Apart from dropping the PDO as a predictor, all other climate indices were included, allowing the model to select the appropriate predictors.

A possible linear long term trend in the rainfall data is modelled by \textbf{Trend} = 1,2,3...n, where n is the total number of months in the time series. \textbf{Season} is the seasonal component.
The climatic terms are also modelled with smooth functions. The effect of large scale drivers on Australian rainfall is more likely to be seasonal [@Murphy2008; @Schepen2012], and the smooth spline function is more flexible in reproducing the variability in impacts of the climatic indices.

```{r hist-rain, fig.cap="Distribution of monthly rainfall in (a) QLD and (b) NSW/VIC. Using a Kolmogorov-Smirnov test with shape = 1 and 2.4  for QLD and NSW/VIC respectively, rainfall in both regions can be modelled as a gamma distribution.", echo=F, out.width="90%"}
include_graphics("figures/hist_rainfall.jpg")
```


\subsection{Tree cover change as factor variable}

One of the main difficulties in empirical observation studies on the effect of land cover change on rainfall is the lack of continuous monitoring of land surface variables, or even, that no specific variable can be defined that can clearly represent the land surface process. Given the lack of a full picture of the land surface process, a factor variable was used in this study to represent the abrupt land surface change (see Equation \@ref(eq:model)). The change could be a result of either land clearing or bush fires as long as it is permanent or takes a long time to recover. Here we approached the problem with two different models.

In the first method, the tree cover change was used as a predictor in the regression model, represented by a factor variable \textbf{LC}. The significance of the coefficient of \textbf{LC}, denoted as $\beta'_5$ in Equation \@ref(eq:model), can be determined by a ratio test.
\begin{equation}
  \mbox{LC} = \left\{
  \begin{array}{ll}
     \mbox{Trees} \\
     \mbox{Removed}
  \end{array} \right.\\
  (\#eq:dummyC)
\end{equation}
Therefore in both regions, land cover is "trees" for the period before land cover change and "removed" for the period after the change. Here we simply assumed that vegetation cover change has occurred on every pixel. The remaining term $\epsilon_r$ is the amount of rainfall that is attributed to other unspecified factors and random errors. Hence the regression model becomes
\vspace{0.5cm}
\begin{equation}
\begin{array}{lll}
g(E(\mathbf{R}_r)) = &\beta'_0 + s'_1(\mathbf{SOI}) + s'_2(\mathbf{IOD}) + \\
  &s'_3(\mathbf{Nino3.4}) + s'_4(\mathbf{Nino4}) + s'_5\mathbf{Season} + \\
  &\beta'_1\mathbf{Trend} + \beta'_2\mathbf{LC} + \boldsymbol{\epsilon'}_r
\end{array}
  (\#eq:model2)
\end{equation}


One of the difficulties is to point an exact time to the changes in the vegetation cover in the two regions. In the QLD region, no exact time can be assigned to the land clearing. According to the SLATS reports, the most substantial clearing occurred between 2003 - 2004 . However, the information on the change in type of land cover during the time period is missing. Therefore, four scenarios were initially tested in the analysis. In these scenarios the "after change" period started from: (1) June 2003, (2) January 2004, (3) June 2004 and (4) January 2005. A further complicating factor is the influence of the "millenium drought" over the study period and in particular to change to wet conditions in 2010 - 2011 [@vanDijk2013]. In the NSW/VIC region, severe bush fires were reported in early January 2003. Hence the "tree" cover state was up to December 2002 then it was changed to "removed" state from January 2003. However, there is similar uncertainty about when the tree cover had recovered from the bushfire and how this interacted with climate variability. As a result several scenarios were tested for both locations: 1) analysis up to 7 years post change (assumed to be 2010 for both regions); and 2) analysis of the full period (2015). More detail about this is later in the methods. As a starting date, the regression model was run from 1979 for both regions.

```{r simpleMode,eval=F, echo = F}
## plotting a hypothesed land cover change model
data1 <- data.frame(year=c(1,2,2,3),tc=c(2,2,1,1))
data2 <- data.frame(year=c(1,2,2,3,4),tc=c(2,2,1,1.5,2))

jpeg("../figures/tc_simple.jpg", width=720, height=480)
par(mar=c(5,6,1,1), mfrow=c(1,2))
plot(data1$year,data1$tc,type="l",ylim=c(0.5,2.5),xlab="",ylab="",xaxt="n",yaxt="n")
axis(1,at=c(1,2,3),labels=c("before","LCC","after"),cex.axis=1.3)
axis(2,at=c(1,2),label=c("removed","tree"),cex.axis=1.3,las=2)
par(mar=c(5,6,1,1))
plot(data2$year,data2$tc,type="l",ylim=c(0.5,2.5),xlab="",ylab="",xaxt="n",yaxt="n")
axis(1,at=c(1,2,4),labels=c("before","LCC","after"),cex.axis=1.3)
axis(2,at=c(1,2),label=c("removed","tree"),cex.axis=1.3,las=2)
dev.off()

```

```{r fullRegression,eval=F , echo = F}
## predicting model: land cover is category variable
rain.trend <- function(x,y,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))[1:nrow(var.data)]+0.0001

  #if (!is.na(mean(var.data$rain))) {
#    if (grepl("qld",substitute(y))) {
      #var.data <- na.omit(var.data)
      rain_fit <- gam(rain ~ s(month, k=3, bs="cs")
                  + s(SOI, k=3, bs="cs")
                  + s(IOD, k=3, bs="cs")
                  #+ s(PDO, k=3, bs="cs")
                  + s(NINO3.4, k=3, bs="cs")
                  + s(NINO4, k=3, bs="cs")
                  + cover
                  + trd
                  , data=var.data,family=Gamma(link=log),
                  na.action = na.omit)
    # } else
    #  if (grepl("nsw",substitute(y))) {
    #   var.data <- na.omit(var.data)
    #   rain_fit <- gam(rain ~ s(month, k=3)
    #               + s(SOI, k=3)
    #               + s(IOD, k=3)
    #               + cover
    #               + trd
    #               , data=var.data,family=Gamma(link=log))
   # }
    #
  return(rain_fit)

}

## note: link=log generally has higher r.sq value than link=reverse

## generate variables for the model
trd <- seq(1:444)
month <-rep(1:12,times=37)
mth <- cycle(ts(month,start=c(1979,1),frequency=12))

LC <- c(rep("tree",288),rep("clear",156))
# different QLD scenarios
LC_qld1 <- c(rep("tree",294),rep("clear",150)) ## after-change: from Jun 2003
LC_qld2 <- c(rep("tree",300),rep("clear",144)) ## after- : from Jan 2004
LC_qld3 <- c(rep("tree",306),rep("clear",138)) ## after- : from Jun 2004
LC_qld4 <- c(rep("tree",312),rep("clear",132)) ## after- : from Jan 2005

# NSW
var.data <- data.frame(month, trd, SOI = SOI_30a$SOI,
                       IOD = IOD_30a$IOD,
                       PDO = PDO_100a$PDO[949:1392],
                       NINO3.4 = SST34_30a$SST34,
                       NINO4 = SST4_30a$SST4,
                       cover = LC)
# # 5 years
# var.data5 <- var.data %>%
#   filter(trd <= 348)

# 7 years to 2009
var.data7 <- var.data %>%
  filter(trd <= 372)
# 8 years to 2010
 var.data8 <- var.data %>%
   filter(trd <= 384)

# # 9 years
# var.data9 <- var.data %>%
#   filter(trd <= 396)

# QLD
# test different scenarios
# var.qld1 <- data.frame(month, trd, SOI = SOI_30a$SOI,
#                        IOD = IOD_30a$IOD,
#                        PDO = PDO_100a$PDO[949:1392],
#                        NINO3.4 = SST34_30a$SST34,
#                        NINO4 = SST4_30a$SST4,
#                        cover = LC_qld1)
#
var.qld2 <- data.frame(month, trd, SOI = SOI_30a$SOI,
                       IOD = IOD_30a$IOD,
                       PDO = PDO_100a$PDO[949:1392],
                       NINO3.4 = SST34_30a$SST34,
                       NINO4 = SST4_30a$SST4,
                       cover = LC_qld2)
#
# var.qld3 <- data.frame(month, trd, SOI = SOI_30a$SOI,
#                        IOD = IOD_30a$IOD,
#                        PDO = PDO_100a$PDO[949:1392],
#                        NINO3.4 = SST34_30a$SST34,
#                        NINO4 = SST4_30a$SST4,
#                        cover = LC_qld3)

var.qld4 <- data.frame(month, trd, SOI = SOI_30a$SOI,
                       IOD = IOD_30a$IOD,
                       PDO = PDO_100a$PDO[949:1392],
                       NINO3.4 = SST34_30a$SST34,
                       NINO4 = SST4_30a$SST4,
                       cover = LC_qld4)
# 31 years: 1979 - 2009)
# shorter qld series
var.qld4_7y <- var.qld4 %>%
  filter(trd <= 372)
# shorter series to 2010
var.qld4_8y <- var.qld4 %>%
  filter(trd <= 384)


## run model for all periods
   # coef.rain30.qld1 <- lapply(2:ncol(qld_30),
   #                            function(x) rain.trend(x,qld_30,var.qld1))
coef.rain30.qld2 <- lapply(2:ncol(qld_30),
                            function(x) rain.trend(x,qld_30,var.qld2))
   # coef.rain30.qld3 <- lapply(2:ncol(qld_30),
   #                            function(x) rain.trend(x,qld_30,var.qld3))
coef.rain30.qld4 <- lapply(2:ncol(qld_30),
                             function(x) rain.trend(x,qld_30,var.qld4))
# QUEENSLAND 7 yr series
   coef.rain30.qld4_7y <- lapply(2:ncol(qld_30),
                              function(x) rain.trend(x,qld_30,var.qld4_7y))
# and qld 8 year series
   coef.rain30.qld4_8y <- lapply(2:ncol(qld_30),
                             function(x) rain.trend(x,qld_30,var.qld4_8y))
  # NSW/VIC
  coef.rain30.nswvic <- lapply(2:ncol(nsw_30),
                               function(x) rain.trend(x,nsw_30,var.data))
# # 5 years
# coef.rain30.nswvic5 <- lapply(2:ncol(nsw_30),
#                               function(x) rain.trend(x,nsw_30,var.data5))
# 7 years
 coef.rain30.nswvic7 <- lapply(2:ncol(nsw_30),
                               function(x) rain.trend(x,nsw_30,var.data7))
# 8 years (includes 2010)
coef.rain30.nswvic8 <- lapply(2:ncol(nsw_30),
                              function(x) rain.trend(x,nsw_30,var.data8))
# # 9 years
# coef.rain30.nswvic9 <- lapply(2:ncol(nsw_30),
#                               function(x) rain.trend(x,nsw_30,var.data9))


## extract sign of C (the tree cover effect)
  C30_qld <- unlist(lapply(1:length(coef.rain30.qld4),function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",summary(coef.rain30.qld4[[x]])$p.coeff[2],NA)))
# shorter series QLD (includes 2009)
  C30_qld_7y <- unlist(lapply(1:length(coef.rain30.qld4_7y),function(x) ifelse(summary(coef.rain30.qld4_7y)[x,2]=="gam",summary(coef.rain30.qld4_7y[[x]])$p.coeff[2],NA)))
# shorter series QLD (includes 2010)
  C30_qld_8y <- unlist(lapply(1:length(coef.rain30.qld4_8y),function(x) ifelse(summary(coef.rain30.qld4_8y)[x,2]=="gam",summary(coef.rain30.qld4_8y[[x]])$p.coeff[2],NA)))
# NSW/VIC
C30_nswvic <- unlist(lapply(1:length(coef.rain30.nswvic),function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",summary(coef.rain30.nswvic[[x]])$p.coeff[2],NA)))
# NSW/VIC 7 year (includes 2009)
 C30_nswvic7 <- unlist(lapply(1:length(coef.rain30.nswvic7),function(x) ifelse(summary(coef.rain30.nswvic7)[x,2]=="gam",summary(coef.rain30.nswvic7[[x]])$p.coeff[2],NA)))
# NSW/VIC 8 year (includes 2010)
 C30_nswvic8 <- unlist(lapply(1:length(coef.rain30.nswvic8),function(x) ifelse(summary(coef.rain30.nswvic8)[x,2]=="gam",summary(coef.rain30.nswvic8[[x]])$p.coeff[2],NA)))

jpeg("../../figures/hist_sign_LC.jpg")
par(mfrow=c(2,2))
hist(C30_nswvic)
hist(C30_nswvic7)
hist(C30_nswvic8)
dev.off()
# also for long term trend in nsw
jpeg("../../figures/hist_trend_nsw.jpg")
par(mfrow=c(2,2))
hist(unlist(lapply(1:length(coef.rain30.nswvic),function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",summary(coef.rain30.nswvic[[x]])$p.coeff[3],NA))), xlab = "value of trend estimate", main="full data period")
hist(unlist(lapply(1:length(coef.rain30.nswvic7),function(x) ifelse(summary(coef.rain30.nswvic7)[x,2]=="gam",summary(coef.rain30.nswvic7[[x]])$p.coeff[3],NA))), xlab = "value of trend estimate", main="Up to 2009")
hist(unlist(lapply(1:length(coef.rain30.nswvic8),function(x) ifelse(summary(coef.rain30.nswvic8)[x,2]=="gam",summary(coef.rain30.nswvic8[[x]])$p.coeff[3],NA))), xlab = "value of trend estimate", main="Up to 2010")
dev.off()
# shows trds are all positive and small

# C30_nswvic5 <- unlist(lapply(1:length(coef.rain30.nswvic5),function(x) ifelse(summary(coef.rain30.nswvic5)[x,2]=="gam",summary(coef.rain30.nswvic5[[x]])$p.coeff[2],NA)))
# C30_nswvic9 <- unlist(lapply(1:length(coef.rain30.nswvic9),function(x) ifelse(summary(coef.rain30.nswvic9)[x,2]=="gam",summary(coef.rain30.nswvic9[[x]])$p.coeff[2],NA)))

# p-value of C
Cp30_qld4 <- unlist(lapply(1:length(coef.rain30.qld4),
   function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                      summary(coef.rain30.qld4[[x]])$p.pv[2],NA)))
# Cp30_qld2 <- unlist(lapply(1:length(coef.rain30.qld2),
#    function(x) ifelse(summary(coef.rain30.qld2)[x,2]=="gam",
#                       summary(coef.rain30.qld2[[x]])$p.pv[2],NA)))
# Qld 7 year series
 Cp30_qld4_7y <- unlist(lapply(1:length(coef.rain30.qld4_7y),
    function(x) ifelse(summary(coef.rain30.qld4_7y)[x,2]=="gam",
                       summary(coef.rain30.qld4_7y[[x]])$p.pv[2],NA)))
# Qld 8 year series
Cp30_qld4_8y <- unlist(lapply(1:length(coef.rain30.qld4_8y),
   function(x) ifelse(summary(coef.rain30.qld4_8y)[x,2]=="gam",
                      summary(coef.rain30.qld4_8y[[x]])$p.pv[2],NA)))
# NSW all data
Cp30_nswvic <- unlist(lapply(1:length(coef.rain30.nswvic),
    function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                       summary(coef.rain30.nswvic[[x]])$p.pv[2],
                       NA)))
# NSW 7 year series
 Cp30_nswvic7 <- unlist(lapply(1:length(coef.rain30.nswvic7),
               function(x) ifelse(summary(coef.rain30.nswvic7)[x,2]=="gam",
                             summary(coef.rain30.nswvic7[[x]])$p.pv[2],NA)))
# NSW 8 year series
Cp30_nswvic8 <- unlist(lapply(1:length(coef.rain30.nswvic8),
          function(x) ifelse(summary(coef.rain30.nswvic8)[x,2]=="gam",
                             summary(coef.rain30.nswvic8[[x]])$p.pv[2],NA)))

## p value of seasons and climate indices
p_qld <- do.call(rbind,
                 lapply(1:length(coef.rain30.qld4), function(x) {
                   ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                      return(summary(coef.rain30.qld4[[x]])$s.pv),
                                       return(rep(NA,6)))}))

p_qld <- as.tibble(p_qld)
colnames(p_qld) = c("month", "SOI", "IOD", "NINO3.4", "NINO4")
p_qld$state <- "QLD"

p_nsw <- do.call(rbind,
                 lapply(1:length(coef.rain30.nswvic), function(x) {
                ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                  return(summary(coef.rain30.nswvic[[x]])$s.pv),
                       return(rep(NA,6)))}))
p_nsw <- as.tibble(p_nsw)
colnames(p_nsw) = c("month", "SOI", "IOD", "NINO3.4", "NINO4")
p_nsw$state <- "NSW/VIC"

p_plot_df <- rbind(p_qld,p_nsw)

jpeg("../../figures/pvalues_fullmodel.jpg", height=960, width=960)
p_plot_df %>%
  gather(key="Variable", value="p_value", month:NINO4) %>%
  ggplot(aes(p_value,fill=state)) + geom_histogram(alpha=0.5) +
  facet_wrap(~Variable) +
  scale_fill_manual(values = c("blue","red")) +
  theme(axis.title = element_text(size = rel(2)),
        axis.text = element_text(size=rel(1.5)),
        strip.text = element_text(face="bold", size= rel(2)),
        legend.text = element_text(face="bold", size= rel(1.5)),
        legend.title = element_text(face="bold", size= rel(2)))
dev.off()
rm(p_plot_df)

## extract p value of long term trend
trdp30_qld4 <- unlist(lapply(1:length(coef.rain30.qld4),function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",summary(coef.rain30.qld4[[x]])$p.pv[3],NA)))
trdp30_nswvic <- unlist(lapply(1:length(coef.rain30.nswvic),function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",summary(coef.rain30.nswvic[[x]])$p.pv[3],NA)))

# show histogram
plot_df <- data_frame(p_trd = c(trdp30_qld4,trdp30_nswvic),
                      state = c(rep("QLD", length(trdp30_qld4)),
                                rep("NSW/VIC", length(trdp30_nswvic))))

jpeg("../../figures/pvalue_trd.jpg", height=480, width=480)
plot_df %>%
  ggplot(aes(p_trd, fill=state)) + geom_histogram() +
  scale_fill_manual(values = c("blue","red")) +
  xlab("pvalue trend of the full gam model")
dev.off()


## extract r.sq of the model
rsq_qld <- unlist(lapply(1:length(coef.rain30.qld4),
          function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam",
                    summary(coef.rain30.qld4[[x]])$r.sq,NA)))
rsq_nsw <- unlist(lapply(1:length(coef.rain30.nswvic),
    function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam",
                    summary(coef.rain30.nswvic[[x]])$r.sq,NA)))

# show histogram
plot_df <- data_frame(`r.squared` = c(rsq_qld,rsq_nsw),
                      state = c(rep("QLD", length(rsq_qld)),
                                rep("NSW/VIC", length(rsq_nsw))))

jpeg("../../figures/rsq_fullmodel.jpg", height=480, width=480)
plot_df %>%
  ggplot(aes(`r.squared`*100, fill=state)) + geom_histogram() +
  scale_fill_manual(values = c("blue","red")) +
  xlab("r_squared of the full gam model")
dev.off()

plot_df %>%
  group_by(state) %>%
  summarise(mean_rsq = mean(`r.squared`))

## frame of the two regions (100 years data)
qld_tif <- raster("../..\\Data\\BoM\\rainfall\\AWAP\\from1900_FVG\\r19000101_qld.tif")
nsw_tif <- raster("../..\\Data\\BoM\\rainfall\\AWAP\\from1900_FVG\\r19000101_nsw.tif")

  dist_Cp30_qld4 <- raster(qld_tif)
  dist_Cp30_qld4[] <- Cp30_qld4
  dist_Cp30_qld4_8y <- raster(qld_tif)
  dist_Cp30_qld4_8y[] <- Cp30_qld4_8y
  dist_Cp30_qld4_7y <- raster(qld_tif)
  dist_Cp30_qld4_7y[] <- Cp30_qld4_7y

  jpeg("../../figures/Cp_30yrs_qld.jpg", width=1440, height=720)
  par(mfrow=c(1,2))
  par(mar=c(3,3,1,7),xpd=T)
  plot(e111,xlab="",ylab="", cex.lab = 2,
       cex.axis=2)
  image(dist_Cp30_qld4,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
#   plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e111,add=T)
  image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
legend(148.7,-27.9,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=1)

  par(mar=c(3,3,1,7),xpd=T)
  plot(e111,xlab="",ylab="", cex.lab = 2,
       cex.axis=2)
  image(dist_Cp30_qld4_7y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
#   plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e111,add=T)

  # this is a totally blue plot
#   par(mar=c(3,3,1,7),xpd=T)
#   plot(e111,xlab="",ylab="", cex.lab = 2,
#        cex.axis=2)
#   image(dist_Cp30_qld4_8y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
# #   plot(aus_reg2,border="grey",add=T)
#   plot(mdb_reg2,border="grey",lwd=3,add=T)
#   plot(e111,add=T)
#   image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
# legend(148.7,-27.9,c("State","MDB"),col=c("grey","grey"),lwd=c(1,3),bty="n",title="Boundary",cex=1)
  dev.off()

    #   dist_Cp30_qld <- crop(reproject(dist_Cp100_qld,CRS=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84"),program="raster"),e1)
  dist_Cp30_nsw <- raster(nsw_tif)
  dist_Cp30_nsw[] <- Cp30_nswvic
  dist_Cp30_nsw_7y <- raster(nsw_tif)
  dist_Cp30_nsw_7y[] <- Cp30_nswvic7
  dist_Cp30_nsw_8y <- raster(nsw_tif)
  dist_Cp30_nsw_8y[] <- Cp30_nswvic8
#   dist_Cp30_nsw <- crop(reproject(dist_Cp30_nsw,CRS=CRS("+proj=lcc +lat_1=-18 +lat_2=-36 +lat_0=-27 +lon_0=132 +x_0=0 +y_0=0 +ellps=WGS84"),program="raster"),e2)
#
  jpeg("../../figures/Cp_30yrs_nswvic.jpg", width=1440, height=720)
  par(mfrow=c(1,3))
  par(mar=c(3,3,1,7),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw_8y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
  image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
  #dev.off()

  par(mar=c(3,3,1,7),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw_7y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
  # # image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
  # dev.off()

   # jpeg("../../figures/Cp_30yrs_nswvic_8y.jpg", width=960, height=960)
  par(mar=c(3,3,1,7),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
  dev.off()
#

# Now make the final plot for the paper with both sites and 2009 and all data
  jpeg("../../figures/Cp_30yrs.jpg", width=1440, height=1440)
  par(mfrow=c(2,2))
  # NSW first
  par(mar=c(3,3,1,9),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw_7y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
  image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
legend(149,-36.6,c("State","MDB"),col=c("grey","grey"),
       lwd=c(1,3),bty="n",title="Boundary",cex=1.8)
  #dev.off()

  par(mar=c(3,5,1,7),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)


  # Then qld
  par(mar=c(3,3,1,9),xpd=T)
  plot(e111,xlab="",ylab="", cex.lab = 2,
       cex.axis=2)
  image(dist_Cp30_qld4_7y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
#   plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e111,add=T)
  image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))

  par(mar=c(3,5,1,7),xpd=T)
  plot(e111,xlab="",ylab="", cex.lab = 2,
       cex.axis=2)
  image(dist_Cp30_qld4,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
#   plot(aus_reg2,border="grey",add=T)
  plot(mdb_reg2,border="grey",lwd=3,add=T)
  plot(e111,add=T)

  dev.off()
# plot up to 2010 for the appendix
  jpeg("../../figures/Cp_30yrs_8y_appendix.jpg", width=1440, height=720)
  par(mfrow=c(1,2))
  # NSW first
  par(mar=c(3,3,1,9),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_nsw_8y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
  image.plot(zlim=c(0,4),breaks=c(0,1,2,3,4),lab.breaks=c(0,0.05,0.1,0.2,1),legend.only=T,horizontal=F,col=c("red","orange","yellow","light blue"),legend.shrink=0.6,legend.width=0.7,legend.args=list(text="p value",line=1,cex=2,font=2),axis.args=list(cex.axis=1.8))
legend(149,-36.6,c("State","MDB"),col=c("grey","grey"),
       lwd=c(1,3),bty="n",title="Boundary",cex=1.8)
  #dev.off()

  par(mar=c(3,5,1,7),xpd=T)
  plot(e222,xlab="",ylab="", cex.lab = 2,
       cex.axis=2) #,border="white")
  image(dist_Cp30_qld_8y,col=c("red","orange","yellow","light blue"),breaks=c(0,0.05,0.1,0.2,1),legend=F,add=T)
  plot(aus_reg2,border="grey75",lwd=5,add=T)
  plot(mdb_reg2,border="grey75",lwd=5,add=T)
  plot(e222,add=T)
dev.off()



# ## range of predicted values
  # predictmax_qld30 <- unlist(lapply(1:length(coef.rain30.qld4), function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam", max(coef.rain30.qld4[[x]]$fitted.values),NA)))
  # predictmin_qld30 <- unlist(lapply(1:length(coef.rain30.qld4), function(x) ifelse(summary(coef.rain30.qld4)[x,2]=="gam", min(coef.rain30.qld4[[x]]$fitted.values),NA)))
#
resid_qld <- lapply(1:length(coef.rain30.qld4), function(x) if(summary(coef.rain30.qld4)[x,2]=="gam") {residuals(coef.rain30.qld4[[x]])} else{NA})

# ## calculate mean residual
  test <- do.call(cbind,resid_qld)
  qld.resid.mean <- apply(test,1, mean,na.rm=T)
  residuals <- data_frame(Dates = seq.Date(as.Date("1979-01-01"),
                                           length = length(qld.resid.mean),
                                           by = "month"),
                          QLD = qld.resid.mean)
#
# predictmax_nsw30 <- unlist(lapply(1:length(coef.rain30.nswvic), function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam", max(coef.rain30.nswvic[[x]]$fitted.values),NA)))
# # 70 - 254.7
#   predictmin_nsw30 <- unlist(lapply(1:length(coef.rain30.nswvic), function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam", min(coef.rain30.nswvic[[x]]$fitted.values),NA)))
# # 18.4 - 62.2
#
resid_nswvic <- lapply(1:length(coef.rain30.nswvic),
            function(x) if(summary(coef.rain30.nswvic)[x,2]=="gam")
              {residuals(coef.rain30.nswvic[[x]])} else{NA})

## calculate mean residual
test <- do.call(cbind,resid_nswvic)
nswvic.resid.mean <- apply(test,1, mean,na.rm=T)
residuals$NSWVIC <- nswvic.resid.mean


## plots
jpeg("../../figures/GAMresidualTime.jpeg", height=960, width=960)
residuals %>%
  gather(key="State", value="residual", QLD, NSWVIC) %>%
  ggplot(aes(Dates,residual)) + geom_line(colour="blue") +
  geom_vline(xintercept=as.numeric(as.Date("2003-01-01")), colour="red",
             size=1.5) +
  facet_wrap(~State)  +
  theme(axis.text = element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(2)),
        strip.text = element_text(size=rel(2), face = "bold"))
dev.off()


#
# ## R^2 of the regression
#     rsq_qld30 <- unlist(lapply(1:length(coef.rain30.qld), function(x) ifelse(summary(coef.rain30.qld)[x,2]=="gam", summary(coef.rain30.qld[[x]])$r.sq,NA)))
#     rsq_nswvic30 <- unlist(lapply(1:length(coef.rain30.nswvic), function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam", summary(coef.rain30.nswvic[[x]])$r.sq,NA)))
#
# ## significant of the other two variables
#     v1_qld30 <- unlist(lapply(1:length(coef.rain30.qld), function(x) ifelse(summary(coef.rain30.qld)[x,2]=="gam", summary(coef.rain30.qld[[x]])$s.pv[1],NA)))
#     v1_nswvic30 <- unlist(lapply(1:length(coef.rain30.nswvic), function(x) ifelse(summary(coef.rain30.nswvic)[x,2]=="gam", summary(coef.rain30.nswvic[[x]])$s.pv[1],NA)))
#
## plot gam.check
jpeg("../../figures/gam_check.jpg", width=720, height=960)
  par(mfrow=c(4,2))
  gam.check(coef.rain30.qld4[[1]])
  gam.check(coef.rain30.nswvic[[1]])
  dev.off()

```

## Step trend test

To support the regression analysis, a step trend test was used to detect changes in rainfall as a result of vegetation cover change. This nonparametric statistical test was modified from the Mann-Whitney Rank-Sum test by [@Hirsch1985] and can identify a step change in data which is cross correlated. The gridded rainfall dataset used in this study has a high spatial correlation between neighbouring pixels due to the underlying interpolation method. The advantages of using the Rank-Sum test therefore are: (1) it does not depend on assumptions of the data distribution; (2) it is not restricted to datasets with no missing data; (3) it is robust and not as easily influenced by outliers and negative numbers [@Hirsch1985].

The rainfall residuals from the regression model in Equation \@ref(eq:model2) were used for the step trend test. According to [@Hirsch1985], to detect a step change, using deseasonalised and detrended data is important. Furthermore, as rainfall can only be partially attributed to local sources and conditions, other effects are introduced by large scale dynamics and changes in other climatic factors. The assumption is that the regression model should remove these effects, and additionally deseasonalise and detrend the rainfall data. As a result, the local landuse effects are amplified in the variation of the remaining residuals. The  test, described in the following sub section, subsequently associates trends in the rainfall residuals with tree cover changes.

```{r Residual_Analysis, eval=F, echo=F}
## GAM without land cover variable for step trend test
rain.trend3 <- function(x,y,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))+0.0001

  #if (!is.na(mean(var.data$rain))) {
    # if (grepl("qld",substitute(y))) {
      rain_fit <- gam(rain ~ trd
                      + s(month, k=3, bs="cs")# added month back in
                  + s(SOI, k=3, bs="cs")
                  + s(IOD, k=3, bs="cs")
                  #+ s(PDO, k=3, bs="cs")
                  + s(NINO3.4, k=3, bs="cs")
                  + s(NINO4, k=3, bs="cs")
                    , data=var.data,family=Gamma(link=log),
                  na.action=na.omit)
    # } else
    # if (grepl("nsw",substitute(y))) {
    #   rain_fit <- gam(rain ~ trd
    #               + s(month,k=3)
    #               + s(SOI, k=3)
    #               + s(IOD, k=3)
    #               , data=var.data,family=Gamma(link=log))
    #}

  return(rain_fit)
  #} #else {NA}

}
#
# ## change LC variable to be null
#   var.data <- data.frame(month, trd, SOI = SOI_30a, IOD = IOD_30a)
#
## run model for 37 years
  coef.rain.qld <- lapply(2:ncol(qld_30),
                          function(x) rain.trend3(x,qld_30,var.qld4))
  coef.rain.qld2 <- lapply(2:ncol(qld_30),
                          function(x) rain.trend3(x,qld_30,var.qld2))
  # QLD shorter series
  test <- qld_30[1:372,]
  coef.rain.qld_7y <- lapply(2:ncol(qld_30), function(x) rain.trend3(x,test,var.qld4_7y))
rm(test)
## QLD
  rsq_qld <- unlist(lapply(1:length(coef.rain.qld), function(x) ifelse(summary(coef.rain.qld)[x,2]=="gam", summary(coef.rain.qld[[x]])$r.sq,NA)))
#
#
## extract residual
  residual_qld <- lapply(1:length(coef.rain.qld), function(x) if(summary(coef.rain.qld)[x,2]=="gam") {coef.rain.qld[[x]]$y-fitted(coef.rain.qld[[x]])} else {NA})

  residual_qld2 <- lapply(1:length(coef.rain.qld2), function(x) if(summary(coef.rain.qld2)[x,2]=="gam") {coef.rain.qld2[[x]]$y-fitted(coef.rain.qld2[[x]])} else {NA})

# shorter Qld series
    residual_qld_7y <- lapply(1:length(coef.rain.qld_7y), function(x) if(summary(coef.rain.qld_7y)[x,2]=="gam") {coef.rain.qld_7y[[x]]$y-fitted(coef.rain.qld_7y[[x]])} else {NA})


#
# ## NSW/VIC
#
#NSW/VIC
  coef.rain.nswvic <- lapply(2:ncol(nsw_30), function(x) rain.trend3(x,nsw_30,var.data))
  test <- nsw_30[1:372,]
  coef.rain.nswvic7 <- lapply(2:ncol(nsw_30), function(x) rain.trend3(x,test,var.data7))
  rm(test)
  # coef.rain.nswvic5 <- lapply(2:ncol(nsw_30), function(x) rain.trend3(x,nsw_30[1:348,],30,var.data5))
  # coef.rain.nswvic9 <- lapply(2:ncol(nsw_30), function(x) rain.trend3(x,nsw_30[1:396,],30,var.data9))

  ## explaining power of the partial model
  rsq_nswvic <- unlist(lapply(1:length(coef.rain.nswvic), function(x) ifelse(summary(coef.rain.nswvic)[x,2]=="gam", summary(coef.rain.nswvic[[x]])$r.sq,NA)))
#

#   predictmax_nswvic <- unlist(lapply(1:length(coef.rain.nswvic), function(x) ifelse(summary(coef.rain.nswvic)[x,2]=="gam", max(coef.rain.nswvic[[x]]$fitted.values),NA)))
#   predictmin_nswvic <- unlist(lapply(1:length(coef.rain.nswvic), function(x) ifelse(summary(coef.rain.nswvic)[x,2]=="gam", min(coef.rain.nswvic[[x]]$fitted.values),NA)))

# extract residual
residual_nswvic <- lapply(1:length(coef.rain.nswvic), function(x) if(summary(coef.rain.nswvic)[x,2]=="gam") {coef.rain.nswvic[[x]]$y-fitted(coef.rain.nswvic[[x]])} else {NA})
# 7 year (2003 - 2010)
residual_nswvic7 <- lapply(1:length(coef.rain.nswvic7), function(x) if(summary(coef.rain.nswvic7)[x,2]=="gam") {coef.rain.nswvic7[[x]]$y-fitted(coef.rain.nswvic7[[x]])} else {NA})

# 5 year
# residual_nswvic5 <- lapply(1:length(coef.rain.nswvic5), function(x) if(summary(coef.rain.nswvic5)[x,2]=="gam") {coef.rain.nswvic5[[x]]$y-fitted(coef.rain.nswvic5[[x]])} else {NA})

# 9 year
# residual_nswvic9 <- lapply(1:length(coef.rain.nswvic9), function(x) if(summary(coef.rain.nswvic9)[x,2]=="gam") {coef.rain.nswvic9[[x]]$y-fitted(coef.rain.nswvic9[[x]])} else {NA})

# histogram of partial model rsq
qld_df <-  data.frame(rsq = rsq_qld*100,
                      state = "Qld")
nsw_df <-  data.frame(rsq = rsq_nswvic*100,
                      state = "NSW")

plot_df <- rbind(qld_df, nsw_df)
jpeg("../../figures/pmodel_explHistogram.jpg")
plot_df %>%
  ggplot(aes(rsq)) + geom_histogram(fill="blue") +
  facet_wrap(~state) +
  xlab(expression(paste("% of variability explained (",r^2,")"))) +
  theme(axis.text = element_text(size=rel(1.5)),
        strip.text = element_text(size=rel(2)),
        axis.title = element_text(size=rel(2)))
 dev.off()


# stack the residuals

# create a boxplot with the annual residuals from 1998
resplot_df <- data_frame(Date = rep(ymd(paste(nsw_30[[1]],
                                              "01", sep="-")),
                        length(residual_nswvic)+length(residual_qld)),
                          residuals = c(unlist(residual_nswvic),
                                                  unlist(residual_qld)),
                      State = c(rep("NSW/VIC",
                                    length(unlist(residual_nswvic))),
                                  rep("QLD", length(unlist(residual_qld)))))

jpeg("../../figures/ResidualBoxplot.jpg")
resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  ggplot(aes(Date,residuals, fill=State)) +
  geom_boxplot(aes(group=year(Date))) +
  facet_wrap(~State, ncol=1)
dev.off()


# residuals before and after change
#par(mfrow=c(1,2))
jpeg("../../figures/ResidualBoxplotchange.jpg")
p1 <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  ggplot(aes(Change,residuals, fill= State)) +
  geom_boxplot(aes(group=Change)) + facet_wrap(~State, ncol=1) +
  guides(fill=FALSE) + ggtitle("1998 - 2015")
#dev.off()

#jpeg("../../figures/ResidualBoxplotchange2.jpg")
p2 <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  filter(year(Date) < 2010) %>%
  ggplot(aes(Change,residuals, fill = State)) +
  geom_boxplot(aes(group=Change)) + facet_wrap(~State, ncol=1) +
  ylab(label="") + ggtitle("1998 - 2009")
lay <- rbind(c(1,1,2,2,2))
grid.arrange(p1,p2, layout_matrix = lay)
dev.off()

res2 <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  filter(year(Date) < 2010) %>%
  filter(State == "QLD")

  summary(lm(residuals~Change-1,data=res2))
  t.test(formula=residuals~Change,data=res2)
# No significant difference if measured to 2010 and slightly less rain (p < 0.05) before if measured to 2015 (~ 2 mm/month)

# 2015
#   data:  residuals by Change
# t = 21.177, df = 513000, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  1.863279 2.243363
# sample estimates:
#  mean in group After mean in group Before
#            0.7206134           -1.3327075

# 2009
#   data:  residuals by Change
# t = 1.6534, df = 414050, p-value = 0.09825
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.03314461  0.39066623
# sample estimates:
#  mean in group After mean in group Before
#            -1.153947            -1.332708

res2 <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  filter(year(Date) < 2010) %>%
  filter(State != "QLD")

  summary(lm(residuals~Change-1,data=res2))
  t.test(formula=residuals~Change,data=res2)

  # slightly more rain (p < 0.05) after the change if measured to 2015 (~ 1 mm/month), significantly less rain (p < 0.05) after the change (~ 9 mm/month) if measured to 2009
# 2015
#   data:  residuals by Change
# t = 7.3033, df = 215950, p-value = 2.817e-13
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  0.9041572 1.5674572
# sample estimates:
#  mean in group After mean in group Before
#            -2.919095            -4.154902

# 2009
#   data:  residuals by Change
# t = -55.329, df = 180240, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -10.144149  -9.450039
# sample estimates:
#  mean in group After mean in group Before
#           -13.951996            -4.154902



```

```{r partialSSTmodel, eval=F, echo=F}
## explaining power of the partial model only SST
rain.trend4 <- function(x,y,var.data) {

  var.data$rain <- as.vector(unlist(y[x]))+0.0001

  #if (!is.na(mean(var.data$rain))) {
#    if (grepl("qld",substitute(y))) {
      rain_fit <- gam(rain ~  s(SOI, k=3, bs="cs")
                  + s(IOD, k=3, bs="cs")
                  #+ s(PDO, k=3, bs="cs")
                  + s(NINO3.4, k=3, bs="cs")
                  + s(NINO4, k=3, bs="cs")
                  , data=var.data,family=Gamma(link=log))
    # } else
    # if (grepl("nsw",substitute(y))) {
    #   rain_fit <- gam(rain ~ s(SOI, k=3)
    #               + s(IOD, k=3)
    #               , data=var.data,family=Gamma(link=log))
    # }
    #
  return(rain_fit)
  #} #else {NA}

}

## explaining power of index
  coef.soi.qld <- lapply(2:ncol(qld_30), function(x) rain.trend4(x,qld_30,var.qld4))
  coef.soi.nswvic <- lapply(2:ncol(nsw_30), function(x) rain.trend4(x,nsw_30,var.data))
  rsq_soi_qld <- unlist(lapply(1:length(coef.soi.qld), function(x) ifelse(summary(coef.soi.qld)[x,2]=="gam", summary(coef.soi.qld[[x]])$r.sq,NA)))
  rsq_soi_nswvic <- unlist(lapply(1:length(coef.soi.nswvic), function(x) ifelse(summary(coef.soi.nswvic)[x,2]=="gam", summary(coef.soi.nswvic[[x]])$r.sq,NA)))

qld_df <-  data.frame(rsq = rsq_soi_qld*100,
                      state = "Qld")
nsw_df <-  data.frame(rsq = rsq_soi_nswvic*100,
                      state = "NSW")

plot_df <- rbind(qld_df, nsw_df)
jpeg("../../figures/soi_explHistogram.jpg", width=960, height=960)
plot_df %>%
  ggplot(aes(rsq)) + geom_histogram(fill="blue") +
  facet_wrap(~state) +
  xlab(expression(paste("% of variability explained (adj",r^2,")"))) +
  theme(axis.text = element_text(size=rel(1.5)),
        strip.text = element_text(size=rel(2)),
        axis.title = element_text(size=rel(2)))
 dev.off()

 plot_df %>%
   group_by(state) %>%
   summarise(mean_rsq = mean(rsq))


```

### Mann-Whitney rank-sum statistic

As indicated, the step trend test is a modified version of the Mann-Whitney rank-sum statistic [@Hirsch1985]. As a nonparametric rank-based test, the Mann-Whitney test does not use the exact values of rainfall but depends on the ranks of the data. For each month, rainfall residuals of each year were ranked in an ascending order. The ranking of January rainfall in a sample pixel k in QLD is illustrated below:

```{r exampleRank, echo=F}
table <- data_frame(Year = c(1998 , 1999 , 2000 , 2001 ,
                             2002 , 2005 , 2006),
                    `Rainfall residuals` =c(-0.3, -60.9, -16.1,
                                                      -71.7, 111.1,
                                             -7.2, -60.5),
                    Rank= c(6, 2, 4,
                                                               1, 7, 5, 3))
colnames(table)[3] <- paste("Rank","$R'_{1k}$")
pander(table, caption="Example of ranking rainfall residuals",
             style="rmarkdown")

```

\noindent Therefore, the smallest or most negative value has rank 1 and the largest value has the maximum rank.

The before and after period in the data formed two groups of samples. The split point of the two periods was based on the timing of the vegetation cover changes. In the QLD region, changes occurred anytime during 2003 and 2004. In contrast to the previous method, the time period covering the land cover change  was excluded, as the nonparametric test allows missing data. @Hirsch1985 also pointed out that the power of the test is higher if the data of the change period is ignored. Hence 2003 and 2004 were excluded from the analysis. As a result, the after-change period was 2005 - 2015 for the Queensland location.

In the case of NSW/VIC, the bushfires broke out in early January 2003. The change was within a relatively short period of the year. Therefore the after change period in this region still started in January 2003. Following @Hirsch1985, the before period was set to five years (1998 - 2002) in both regions. The length of the after period is difficult for the NSW/VIC as the regrowth would at some point have impacted the local effects.

There is a further complication in the data. The year 2009 was the final year of the millenium drought [@vanDijk2013], followed by two very wet years (also visible in Figure \@ref(fig:ts-mean) in 2010 and 2011. As highlighted earlier, this means the the length of after period could influence the analysis by the inclusion of more or fewer years. as a result the period up to (and including) 2009 was compared to the full period up to 2015. Further analysis up to 2010 is included in the supplementary material.

The rank of rainfall in month j year i in pixel k is denoted as $R'_{ijk}$. The sum of ranks of rainfall in month j in pixel k before the known intervention is:
\begin{equation}
  W_{jk} = \sum_{i=1}^{n_1}R'_{ijk}.
  (\#eq:Wj)
\end{equation}
$n_1$ is the number of years before the land cover change. The expected value of $W_{jk}$ is
\begin{equation}
  \mu_w=n_1(n_1+n_2+1)/2
\end{equation}

$n_2$ is the number of years after the change. Hence the expected value of the rank sum before the intervention is the same for all months and all pixels. The sum of ranks for the whole time period is fixed, as $(n_1+n_2)(n_1+n_2+1)/2$. In this study, since there are only two groups (before and after), knowing the rank-sum of one group is the same as knowing the rank-sum of the other group. If the rainfall data is temporally and spatially independent, the variance of $W_{jk}$ is
\begin{equation}
  \sigma^2_w = n_1\cdot n_2(n_1+n_2+1)/m
\end{equation}
where m is the number of months which is 12 in the case of a full year.

### Step trend test

Instead of completing the Mann-Whitney U-test, @Hirsch1985 applied a standard normal Z test to the rank-sum statistics. As highlighted, this modified test accounts for serial and cross correlation in the data. In the case here, the deseasonalised and detrended data shows little autocorrelation in the time series but possesses strong cross correlation between neighbouring pixels, i.e. $R>0.99$.

The sum of $W_{jk}$ for a block of $ns$ pixels over the whole year, $\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk}$, has mean
\begin{equation}
  E(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})=12\cdot ns\cdot\mu_W
\end{equation}
and variance
\begin{equation}
  Var(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})=\sum_{j=1}^{12}\sum_{k=1}^{ns}\sum_{h=1}^{ns}C(W_{jk},W_{jh}).
\end{equation}
$C(W_{jk},W_{jh})$ is the covariance of the W statistics between pixel k and pixel h in month j. When $k=h$, $C(W_{jk},W_{jh})=\sigma^2_w$. When $k\neq h$,
\begin{equation}
  C(W_{jk},W_{jh})=\sigma^2_w r(R_k,R_h)
\end{equation}
where $r(R_k,R_h)$ is the product moment correlation coefficient of the concurrent ranks in pixel k and h. Here $r$ is calculated on the full time series in each pixel. In the analysis, the test was applied to a square block of four pixels each time. As argued by @Hirsch1985, $ns=4$ is the most optimal solution to balance the cost and the gain in the test power.

The statistic of the step trend test is then defined as
\begin{equation}
  Z'=\frac{\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk}-12\cdot ns\cdot\mu_w}{\sqrt{Var(\sum_{j=1}^{12}\sum_{k=1}^{ns}W_{jk})}}.
  (\#eq:Z)
\end{equation}
The above statistic is written for a 12 month period. By changing the value 12, it can also be used to test seasonal rainfall change or for other customized periods.

The null hypothesis ($H_0$) in this study is that there was no change in rainfall due to land surface intervention. The results of the step trend test can be interpreted according to the sign of the Z' score (see Table \@ref(tab:Zscore) [Chapter 23, P887 @Hipel1994]). Z' is normally distributed similar to the standard normal statistics Z. Hence it can be compared to a standard normal distribution to determine the p value.

```{r (ref:Zscore), echo=F}
table2 <- data_frame(" "= c("Z' $>$ 0 & rainfall decreases after change",
    "Z' $<$ 0 & rainfall increases after change",
    "Z' = 0 & rainfall does not change"))
pander(table2, caption="The interpretation of Z' score in the step trend test", style="rmarkdown")
```

```{r steptrend_ns4, echo=F, eval=F}
## perform step test on the data using ns = 4
## function to calculate the step trend statistic (Hirsch, 1985)
stepTrend2 <- function(x,y,i, endyear=2015){
#browser()
    n1 <- 2002-1997

    if (i==1){

      z <- 56  # no. of column, related to the dim of the region
      # Qld 57 by 51
      # NSW 38 by 33

    } else {

    z <- 37 }

if (x%%z!=0){ #& x%%z!=(z-1)) {
    y.1 <- y[[x]]
    y.2 <- y[[x+1]]
#     y.3 <- y[[x+2]]
    y.3 <- y[[x+z]]
    y.4 <- y[[x+z+1]]
#     y.6 <- y[[x+z+2]]
#     y.7 <- y[[x+2*z]]
#     y.8 <- y[[x+2*z+1]]
#     y.9 <- y[[x+2*z+2]]

    if(!is.na(y.1[1])&!is.na(y.2[1])&!is.na(y.3[1])&!is.na(y.4[1])) { #|!is.na(y.5[1])|!is.na(y.6[1])|!is.na(y.7[1])|!is.na(y.8[1])|!is.na(y.9[1])) {

    if (i == 1) {
      n2 <- endyear-2004
      v.1 <- ts(y.1[c(229:288,313:length(y.1))],
                start=c(1997,1),frequency=12)
      v.2 <- ts(y.2[c(229:288,313:length(y.1))],
                start=c(1997,1),frequency=12)
      v.3 <- ts(y.3[c(229:288,313:length(y.1))],
                start=c(1997,1),frequency=12)
      v.4 <- ts(y.4[c(229:288,313:length(y.1))],
                start=c(1997,1),frequency=12)
#       v.5 <- ts(y.5[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.6 <- ts(y.6[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.7 <- ts(y.7[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.8 <- ts(y.8[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v.9 <- ts(y.9[c(229:288,313:348)],start=c(1998,1),frequency=12)
#       v <- (x$y-x$fitted.values)[c(1:288,313:357)]
#       v.s <- ts(v,start=c(1998,1),frequency=12)

    } else {

      n2 <- endyear-2002

      v.1 <- ts(y.1[c(229:length(y.1))],
                start=c(1997,1),frequency=12)
      v.2 <- ts(y.2[c(229:length(y.2))],
                start=c(1997,1),frequency=12)
      v.3 <- ts(y.3[c(229:length(y.3))],
                start=c(1997,1),frequency=12)
      v.4 <- ts(y.4[c(229:length(y.4))],
                start=c(1997,1),frequency=12)
#       v.5 <- ts(y.5[c(229:348)],start=c(1998,1),frequency=12)
#       v.6 <- ts(y.6[c(229:348)],start=c(1998,1),frequency=12)
#       v.7 <- ts(y.7[c(229:348)],start=c(1998,1),frequency=12)
#       v.8 <- ts(y.8[c(229:348)],start=c(1998,1),frequency=12)
#       v.9 <- ts(y.9[c(229:348)],start=c(1998,1),frequency=12)
#       v <- (x$y-x$fitted.values)[c(1:288, 301:357)]
#       v.s <- ts(v,start=c(1998,1),frequency=12)
}

## rank by month
   for (j in 1:12) {
    assign(paste("r1",j,sep=""),rank(subset(v.1,cycle(v.1)==j)))
    assign(paste("r2",j,sep=""),rank(subset(v.2,cycle(v.2)==j)))
    assign(paste("r3",j,sep=""),rank(subset(v.3,cycle(v.3)==j)))
    assign(paste("r4",j,sep=""),rank(subset(v.4,cycle(v.4)==j)))
#     assign(paste("r5",j,sep=""),rank(subset(v.5,cycle(v.5)==j)))
#     assign(paste("r6",j,sep=""),rank(subset(v.6,cycle(v.6)==j)))
#     assign(paste("r7",j,sep=""),rank(subset(v.7,cycle(v.7)==j)))
#     assign(paste("r8",j,sep=""),rank(subset(v.8,cycle(v.8)==j)))
#     assign(paste("r9",j,sep=""),rank(subset(v.9,cycle(v.9)==j)))

    }

## mann-whitney rank sum statistic
    rlist.1 <- list(r11,r12,r13,r14,r15,r16,r17,r18,r19,r110,r111,r112) ## full year
    rlist.2 <- list(r21,r22,r23,r24,r25,r26,r27,r28,r29,r210,r211,r212)
    rlist.3 <- list(r31,r32,r33,r34,r35,r36,r37,r38,r39,r310,r311,r312)
    rlist.4 <- list(r41,r42,r43,r44,r45,r46,r47,r48,r49,r410,r411,r412)
#     rlist.5 <- list(r51,r52,r53,r54,r55,r56,r57,r58,r59,r510,r511,r512)
#     rlist.6 <- list(r61,r62,r63,r64,r65,r66,r67,r68,r69,r610,r611,r612)
#     rlist.7 <- list(r71,r72,r73,r74,r75,r76,r77,r78,r79,r710,r711,r712)
#     rlist.8 <- list(r81,r82,r83,r84,r85,r86,r87,r88,r89,r810,r811,r812)
#     rlist.9 <- list(r91,r92,r93,r94,r95,r96,r97,r98,r99,r910,r911,r912)
    rlist <- list(unlist(rlist.1),unlist(rlist.2),unlist(rlist.3),unlist(rlist.4)) #,unlist(rlist.5),unlist(rlist.6),unlist(rlist.7),unlist(rlist.8),unlist(rlist.9))
## seasonal
#     rlist <- list(unlist(rlist.1[c(9:11)]),unlist(rlist.2[c(9:11)]),unlist(rlist.3[c(9:11)]),unlist(rlist.4[c(9:11)]))
#     rlist <- list(r1,r2,r12) ## summer
#     rlist <- list(r3,r4,r5)  ## autumn
#     rlist <- list(r6,r7,r8)  ## winter
#     rlist <- list(r9,r10,r11) ## spring
    w.s1 <- 0
    w.s2 <- 0
    w.s3 <- 0
    w.s4 <- 0
#     w.s5 <- 0
#     w.s6 <- 0
#     w.s7 <- 0
#     w.s8 <- 0
#     w.s9 <- 0
  for (k in 1:length(rlist.1)) {
#   for (k in c(9:11)) {
    w.s1 <- sum(rlist.1[[k]][1:n1])+w.s1
    w.s2 <- sum(rlist.2[[k]][1:n1])+w.s2
    w.s3 <- sum(rlist.3[[k]][1:n1])+w.s3
    w.s4 <- sum(rlist.4[[k]][1:n1])+w.s4
#     w.s5 <- sum(rlist.5[[k]][1:n1])+w.s5
#     w.s6 <- sum(rlist.6[[k]][1:n1])+w.s6
#     w.s7 <- sum(rlist.7[[k]][1:n1])+w.s7
#     w.s8 <- sum(rlist.8[[k]][1:n1])+w.s8
#     w.s9 <- sum(rlist.9[[k]][1:n1])+w.s9
    }
    w.s <- sum(w.s1,w.s2,w.s3,w.s4) #,w.s5,w.s6,w.s7,w.s8,w.s9)

## other statistic
# mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- 12*4*mu
# ## mean for one season
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- 3*4*mu

## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, cor.test(), true for NSW, mostly true for WA. QLD? there are some situations in WA require further investigation)
# assume only cross correlation
    ss <- n1*n2*(n1+n2+1)/12
    ss.s <- 0
    for (kk in 1:4) {
      for (kkk in 1:4) {
#         for (kkkk in 1:12) {
          ss.s <- 12*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#         }
      }
    }
## variance for one season
#     ss <- n1*n2*(n1+n2+1)/3
#     ss.s <- 0
#     for (kk in 1:4) {
#       for (kkk in 1:4) {
#           ss.s <- 3*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#       }
#     }

## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)

    return(z) }

     else {return(NA)} }

     else {return(NA)}

  }

## 30 years
## full year,
## central QLD
  qld.z.new <- unlist(lapply(1:(length(residual_qld)-57),function(x) stepTrend2(x,residual_qld,1)))
  qld.z.new <- c(qld.z.new,rep(NA,57))
# shorter series
    qld.z.new_7y <- unlist(lapply(1:(length(residual_qld_7y)-57),function(x) stepTrend2(x,residual_qld_7y,1, endyear=2009)))
  qld.z.new_7y <- c(qld.z.new_7y,rep(NA,57))

  tr_qld.step.new <- raster(qld_tif)
  tr_qld.step.new[] <- qld.z.new

  tr_qld.step.new7 <- raster(qld_tif)
  tr_qld.step.new7[] <- qld.z.new_7y

## NSW
  nswvic.z.new <- unlist(lapply(1:(length(residual_nswvic)-38),function(x) stepTrend2(x,residual_nswvic,2)))
  nswvic.z.new <- c(nswvic.z.new,rep(NA,38))

  nswvic.z.new7 <- unlist(lapply(1:(length(residual_nswvic7)-38),function(x) stepTrend2(x,residual_nswvic7,2, endyear = 2009)))
  nswvic.z.new7 <- c(nswvic.z.new7,rep(NA,38))



  tr_nswvic.step.new <- raster(nsw_tif)
  tr_nswvic.step.new[] <- nswvic.z.new
  tr_nswvic.step.new7 <- raster(nsw_tif)
  tr_nswvic.step.new7[] <- nswvic.z.new7

# ## seasonal
#   qld.z.sum <- unlist(lapply(1:(length(residual_qld)-56),function(x) stepTrend2(x,residual_qld,1)))
#   qld.z.sum <- c(qld.z.sum,rep(NA,56))
#
#   tr_qld.step.sum <- raster(qld_tif)
#   tr_qld.step.sum[] <- qld.z.sum
#
#   nswvic.z.sum <- unlist(lapply(1:(length(residual_nswvic)-37),function(x) stepTrend2(x,residual_nswvic,2)))
#   nswvic.z.sum <- c(nswvic.z.sum,rep(NA,37))
#
#   tr_nswvic.step.sum <- raster(nsw_tif)
#   tr_nswvic.step.sum[] <- nswvic.z.sum

  plotclt <- rev(brewer.pal(8,"RdYlBu"))

jpeg("../../figures/step_new.jpg", width=1240, height=960, quality=100)
#tiff("../figures/step_new_nswvic_7y.tif", width=960, height=960)
  par(mar=c(3,3,1,9), mfrow=c(2,2), xpd=T)
  plot(e222,xlab="",ylab="", cex.axis=2)#,border="white")
  image(tr_nswvic.step.new7,col=plotclt,breaks=c(-2.3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3)
  plot(aus_reg2,border="grey",add=T)
  plot(e222,add=T)
image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.7,cex=1.5,font=2),axis.args=list(cex.axis=1.5))
legend(149,-36.6,c("State","MDB"),col=c("grey","grey"),
       lwd=c(1,3),bty="n",title="Boundary",cex=1.8)

# nsw 7y
  par(mar=c(3,5,1,7))
  plot(e222,xlab="",ylab="", cex.axis=2)#,border="white")
  image(tr_nswvic.step.new,col=plotclt,breaks=c(-2.3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3)
  plot(aus_reg2,border="grey",add=T)
  #plot(e222,add=T)
# image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.5,cex=1,font=2),axis.args=list(cex.axis=0.8))

  # Qld
  par(mar=c(3,3,1,9),xpd=T)
  plot(e111,xlab="",ylab="", cex.axis=2)#,border="white")
  image(tr_qld.step.new7,col=plotclt,breaks=c(-3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3)
  plot(e111,add=T)
image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.9,cex=1.5,font=2),axis.args=list(cex.axis=1.5))

# qld year
  par(mar=c(3,5,1,7))
  plot(e111,xlab="",ylab="", cex.axis=2)#,border="white")
  image(tr_qld.step.new,col=plotclt,breaks=c(-3,-1.645,-1.282,-0.842,0,0.842,1.282,1.645,3),legend=F,add=T)
  plot(mdb_reg2,border="grey",add=T,lwd=3)
  plot(e111,add=T)
# image.plot(zlim=c(-4,4),breaks=c(-4,-3,-2,-1,0,1,2,3,4),lab.breaks=c(0.00,0.05,0.1,0.2,1,0.2,0.1,0.05,0.00),legend.only=T,horizontal=F,col=plotclt,legend.shrink=0.7,legend.width=0.9,legend.args=list(text=c(expression(paste("level of significance (",alpha,")")),"positive Z'","negative Z'"),side=c(2,3,1),line=0.5,cex=1,font=2),axis.args=list(cex.axis=0.8))
  dev.off()

#ns = 4 results
# positive
qld_origp.new <- length(subset(qld.z.new,qld.z.new>=1.645))/
  length(qld.z.new)
# 0.00034
# negative
qld_orign.new <- length(subset(qld.z.new,qld.z.new<=-1.645))/
  length(qld.z.new)
# 0
# shorter series
qld_origp.new_7y <- length(subset(qld.z.new_7y,qld.z.new_7y>=1.645))/
  length(qld.z.new_7y)
# 0.212
qld_orign.new_7y <- length(subset(qld.z.new_7y,qld.z.new_7y<=-1.645))/
  length(qld.z.new_7y)
# 0

nsw_origp.z.new <- length(subset(nswvic.z.new,nswvic.z.new>=1.645))/
  length(nswvic.z.new)
# 0
nsw_orign.z.new <- length(subset(nswvic.z.new,nswvic.z.new<=-1.645))/
  length(nswvic.z.new)
# 0
nsw_origp.z.new7 <- length(subset(nswvic.z.new7,nswvic.z.new7>=1.645))/
  length(nswvic.z.new7)
# 0.03
nsw_orign.z.new7 <- length(subset(nswvic.z.new7,nswvic.z.new7<=-1.645))/
  length(nswvic.z.new7)
# 0



```

```{r bootstrap_ns1, echo=F, eval=F}
## one cell step trend
## perform step test on the data for the bootstrapping test (spatial structure was kept)
## function to calculate the step trend statistic (Hirsch, 1985), ns = 1
stepTrend <- function(x,i, endyear=2015){
#browser()
    n1 <- 2002-1997

  if(!is.na(x[1])) {

    if(i==1) {
      n2 <- endyear-2004

      v <- x[c(229:288,313:(n2*12+313-1))]
#       v <- (x$y-x$fitted.values)[c(1:288,313:357)]
      v.s <- ts(v,start=c(1998,1),frequency=12)
    } else
      if(i==2) {
      n2 <- endyear-2002
      v <- x[c(229:(n2*12+n1*12+229-1))]
#       v <- (x$y-x$fitted.values)[c(1:288, 301:357)]
      v.s <- ts(v,start=c(1998,1),frequency=12)
    } #else
#       {n2 <- 2008-2002
#       v <- (x$y-x$fitted.values)[229:357]
# #       v <- (x$y-x$fitted.values)
#       v.s <- ts(v,start=c(1998,1),frequency=12)}

## rank by month
   for (j in 1:12) {
    assign(paste("r",j,sep=""),rank(subset(v.s,cycle(v.s)==j)))
    }

## mann-whitney rank sum statistic
    rlist <- list(r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12) ## full year
#     rlist <- list(r1,r2,r12) ## summer
#     rlist <- list(r3,r4,r5)  ## autumn
#     rlist <- list(r6,r7,r8)  ## winter
#     rlist <- list(r9,r10,r11) ## spring
    w.s <- 0
    for (k in 1:length(rlist)) {
    w.s <- sum(rlist[[k]][1:n1])+w.s
    }

## other statistic
## mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- length(rlist)*mu
## mean for one season
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- 3*mu

## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, cor.test(), true for NSW, mostly true for WA. QLD? there are some situations in WA require further investigation)
## assume only cross correlation
    ss <- n1*n2*(n1+n2+1)/length(rlist)
    ss.s <- length(rlist)*ss
## variance for one season
#     ss <- n1*n2*(n1+n2+1)/3
#     ss.s <- 3*ss

## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)

    return(z) }

     else {return(NA)}

  }

## full year
## central QLD
  Qld.z <- unlist(lapply(residual_qld,function(x) stepTrend(x,1)))
  Qld.z_7y <- unlist(lapply(residual_qld_7y,
                            function(x) stepTrend(x,1, endyear=2010)))
## NSW/VIC
## treatment 1: excluding 2003
  nswvic.z <- unlist(lapply(residual_nswvic,
                            function(x) stepTrend(x,2)))
  nswvic.z_7y <- unlist(lapply(residual_nswvic7,
                            function(x) stepTrend(x,2,
                                                  endyear = 2010)))

# # ns = 1 results note that this is p < 0.1 already
#   Qld_origp <- length(subset(Qld.z,Qld.z>=1.645))
# # 0.002
#   Qld_orign <- length(subset(Qld.z,Qld.z<=-1.645))
# # 0
#   Qld_origp_7y <- length(subset(Qld.z_7y,
#                                 Qld.z_7y>=1.645))
# # 0
#   Qld_orign_7y <- length(subset(Qld.z_7y,
#                                 Qld.z_7y<=-1.645))
# # 0.023
#
#   Nsw_origp <- length(subset(nswvic.z,
#                              nswvic.z>=1.645))
# # 0
#   Nsw_orign <- length(subset(nswvic.z,
#                              nswvic.z<=-1.645))
# # 0
#   Nsw_origp_7y <- length(subset(nswvic.z_7y,
#                                 nswvic.z_7y>=1.645))
# 0
#  Nsw_orign_7y <- length(subset(nswvic.z_7y,
#                                nswvic.z_7y<=-1.645))
# 0




# new step trend test 2: keep spatial structure, but ns = 1
NstepTrend2 <- function(x,y,ii, endyear=2015){

  n1 <- 2002-1997

  if(ii==1) {
      n2 <- endyear-2004
      v <- x[c(229:288,313:length(x))]
    } else
      if(ii==2) {
      n2 <- endyear-2002
      v <- x[c(229:length(x))]
    }


  if(!is.na(unlist(x)[1])) {

  yy<-ts(v,start=c(1998,1),frequency=12)
#browser()
  for(i in 1:12) {
  y.mth <- data.frame(mth=as.vector(window(yy,start=c(1998,i),frequency=1)),o=y[[i]])[order(y[[i]]),]

  ## rank by month
    assign(paste("r",i,sep=""),rank(y.mth$mth) )
  }


## mann-whitney rank sum statistic
    rlist <- list(r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12) ## full year

    w.s <- 0
    for (k in 1:length(rlist)) {
    w.s <- sum(rlist[[k]][1:n1])+w.s
    }

## other statistic
## mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- length(rlist)*mu


## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, true for QLD and NSW)
    ss <- n1*n2*(n1+n2+1)/length(rlist)
    ss.s <- length(rlist)*ss

## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)

    return(z)
    }

     else {return(NA)}

  }

## conduct bootstrapping 2
R <- 1000

## QLD
z2pq.values = numeric(R)
z2nq.values = numeric(R)
## sample years without replacement. note that with this method, only the order of years has changed, but months within year do not change
new.order <- list()
# mth.l <- rep(11,12)
# this relates to the total number of years:n1 + n2
#
period1 <- 2002 - 1997
period2 <- 2015 - 2004
mth.l <- rep((period1 + period2),12)

ptm <- proc.time()
for (i in 1:R) {

  for (j in 1:12) {
    new.order[[j]]<-sample(1:mth.l[j])
  }

  temp <- unlist(lapply(residual_qld,
                        function(x,y) NstepTrend2(x,y,1),new.order))
  if(i==1) {write.table(temp,file="bt_zvalues2_qld.txt",row.names=F)
            } else
              {write.table(temp,file="bt_zvalues2_qld.txt",append=T,row.names=F,col.names=F)}
  z2pq.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
  z2nq.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
}
proc.time()-ptm

write.table(z2pq.values,file="bt_out2p_qld.txt",row.names=F)
write.table(z2nq.values,file="bt_out2n_qld.txt",row.names=F)

## NSW
period1 <- 2002 - 1997
period2 <- 2015 - 2002

mth.l <- rep((period1 + period2),12)

ptm <- proc.time()
for (i in 1:R) {

  for (j in 1:12) {
    new.order[[j]]<-sample(1:mth.l[j])
  }

  temp <- unlist(lapply(residual_nswvic,
                        function(x,y) NstepTrend2(x,y,2),new.order))
  if(i==1) {write.table(temp,file="bt_zvalues2_nswvic.txt",
                        row.names=F)
            } else
            {write.table(temp,file="bt_zvalues2_nswvic.txt",
                           append=T,row.names=F,col.names=F)}
  z2pq.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
  z2nq.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
}
proc.time()-ptm


write.table(z2pq.values,file="bt_out2p_nswvic.txt",row.names=F)
write.table(z2nq.values,file="bt_out2n_nswvic.txt",row.names=F)

bt1_nswp.values <- unlist(read.table("bt_out2p_nswvic.txt",
                                     header=T,sep=""))*100
bt1_nswn.values <- unlist(read.table("bt_out2n_nswvic.txt",
                                     header=T,sep=""))*100

bt1_qldp.values <- unlist(read.table("bt_out2p_qld.txt",
                                     header=T,sep=""))*100
bt1_qldn.values <- unlist(read.table("bt_out2n_qld.txt",
                                     header=T,sep=""))*100

jpeg("../../figures/bt1_qldp.jpg")
hist(bt1_qldp.values,nclass=100,xlab="% positive Z'",main="1-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(qld_origp*100,0,pch=16,col="red",cex=1.8)
dev.off()

jpeg("../../figures/bt1_qldn.jpg")
hist(bt1_qldn.values,nclass=100,xlab="% negative Z'",main="1-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(qld_orign*100,0,pch=16,col="red",cex=1.8)
dev.off()

jpeg("../../figures/bt1_nswp.jpg")
hist(bt1_nswp.values,nclass=100,xlab="% positive Z'",main="1-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(nsw_origp*100,0,pch=16,col="red",cex=1.8)
dev.off()

jpeg("../../figures/bt1_nswn.jpg")
hist(bt1_nswn.values,nclass=100,xlab="% negative Z'",main="1-pixel step trend",cex.lab=1.4,cex.main=1.3)
points(nsw_orign*100,0,pch=16,col="red",cex=1.8)
dev.off()

```

```{r bootstrap_ns4, eval=F, echo=F}
# This is the same as chunk 8, but for ns = 4
## multiple cells
# Set up for the shorter period
NstepTrend <- function(x,y,m,i){

    n1 <- 2002-1997

    if (i==1){

      z <- 56  # no. of column, related to the dim of the region
      # Qld 57 by 51
      # NSW 38 by 33

    } else {

    z <- 37 }

if (x%%z!=0){ #& x%%z!=(z-1)) {
    y.1 <- m[[x]]
    y.2 <- m[[x+1]]
    y.3 <- m[[x+z]]
    y.4 <- m[[x+z+1]]

    if(!is.na(y.1[1])&!is.na(y.2[1])&!is.na(y.3[1])&!is.na(y.4[1])) {
    if (i == 1) {
      n2 <- 2009-2004
      v.1 <- ts(y.1[c(229:288,313:length(y.1))],
                start=c(1997,1),frequency=12)
      v.2 <- ts(y.2[c(229:288,313:length(y.2))],
                start=c(1997,1),frequency=12)
      v.3 <- ts(y.3[c(229:288,313:length(y.3))],
                start=c(1997,1),frequency=12)
      v.4 <- ts(y.4[c(229:288,313:length(y.4))],
                start=c(1997,1),frequency=12)

    } else {

      n2 <- 2010-2002

      v.1 <- ts(y.1[c(229:length(y.1))],start=c(1997,1),frequency=12)
      v.2 <- ts(y.2[c(229:length(y.2))],start=c(1997,1),frequency=12)
      v.3 <- ts(y.3[c(229:length(y.3))],start=c(1997,1),frequency=12)
      v.4 <- ts(y.4[c(229:length(y.4))],start=c(1997,1),frequency=12)
}

## rank by month
#browser()
   for (j in 1:12) {
    y1.mth <- data.frame(mth=as.vector(window(v.1,
                                              start=c(1997,i),
                                              frequency=1)),
                         o=y[[j]])[order(y[[j]]),]
    y2.mth <- data.frame(mth=as.vector(window(v.2,
                                              start=c(1997,i),
                                              frequency=1)),
                         o=y[[j]])[order(y[[j]]),]
    y3.mth <- data.frame(mth=as.vector(window(v.3,
                                              start=c(1997,i),
                                              frequency=1)),
                         o=y[[j]])[order(y[[j]]),]
    y4.mth <- data.frame(mth=as.vector(window(v.4,
                                              start=c(1997,i),
                                              frequency=1)),
                         o=y[[j]])[order(y[[j]]),]

    assign(paste("r1",j,sep=""),rank(y1.mth$mth))
    assign(paste("r2",j,sep=""),rank(y2.mth$mth))
    assign(paste("r3",j,sep=""),rank(y3.mth$mth))
    assign(paste("r4",j,sep=""),rank(y4.mth$mth))

    }

## mann-whitney rank sum statistic
    rlist.1 <- list(r11,r12,r13,r14,r15,r16,r17,r18,r19,r110,r111,r112) ## full year
    rlist.2 <- list(r21,r22,r23,r24,r25,r26,r27,r28,r29,r210,r211,r212)
    rlist.3 <- list(r31,r32,r33,r34,r35,r36,r37,r38,r39,r310,r311,r312)
    rlist.4 <- list(r41,r42,r43,r44,r45,r46,r47,r48,r49,r410,r411,r412)
    rlist <- list(unlist(rlist.1),unlist(rlist.2),
                  unlist(rlist.3),unlist(rlist.4))
## seasonal
    w.s1 <- 0
    w.s2 <- 0
    w.s3 <- 0
    w.s4 <- 0
  for (k in 1:length(rlist.1)) {
#   for (k in c(9:11)) {
    w.s1 <- sum(rlist.1[[k]][1:n1])+w.s1
    w.s2 <- sum(rlist.2[[k]][1:n1])+w.s2
    w.s3 <- sum(rlist.3[[k]][1:n1])+w.s3
    w.s4 <- sum(rlist.4[[k]][1:n1])+w.s4
    }
    w.s <- sum(w.s1,w.s2,w.s3,w.s4) #,w.s5,w.s6,w.s7,w.s8,w.s9)

## other statistic
# mean for full year
    mu <- n1*(n1+n2+1)/2
    mu.s <- 12*4*mu
# ## mean for one season
#     mu <- n1*(n1+n2+1)/2
#     mu.s <- 3*4*mu

## variance (standard variation). The autocorrelation of the residuals can be assumed to be null (checked, cor.test(), true for NSW, mostly true for WA. QLD? there are some situations in WA require further investigation)
# assume only cross correlation
    ss <- n1*n2*(n1+n2+1)/12
    ss.s <- 0
    for (kk in 1:4) {
      for (kkk in 1:4) {
#         for (kkkk in 1:12) {
          ss.s <- 12*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#         }
      }
    }
## variance for one season
#     ss <- n1*n2*(n1+n2+1)/3
#     ss.s <- 0
#     for (kk in 1:4) {
#       for (kkk in 1:4) {
#           ss.s <- 3*ss*cor(rlist[[kk]],rlist[[kkk]]) + ss.s
#       }
#     }

## step trend statistic
    z <- (w.s - mu.s)/sqrt(ss.s)

    return(z) }

     else {return(NA)} }

     else {return(NA)}

  }


R <- 1000
new.order <- list()

zpq.values = numeric(R)
znq.values = numeric(R)
period1 <- 2002 - 1997
period2 <- 2009 - 2004
mth.l <- rep((period1 + period2),12)

ptm <- proc.time()
for (i in 1:R) {

  for (j in 1:12) {
    new.order[[j]]<-sample(1:mth.l[j])
  }

  temp <- unlist(lapply(1:(length(residual_qld_7y)-57),function(x,y) NstepTrend(x,y,residual_qld_7y,1),new.order))
  if(i==1) {write.table(temp,file="bt_zvalues_qld_7y.txt",row.names=F)
            } else
              {write.table(temp,file="bt_zvalues_qld_7y.txt",append=T,row.names=F,col.names=F)}
  zpq.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
  znq.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
}
proc.time()-ptm

write.table(zpq.values,file="bt_outp_qld_7y.txt",row.names=F)
write.table(znq.values,file="bt_outn_qld_7y.txt",row.names=F)

period1 <- 2002 - 1997
period2 <- 2009 - 2002
mth.l <- rep((period1 + period2),12)

ptm <- proc.time()
for (i in 1:R) {

  for (j in 1:12) {
    new.order[[j]]<-sample(1:mth.l[j])
  }

  temp <- unlist(lapply(1:(length(residual_nswvic7)-38),function(x,y) NstepTrend(x,y,residual_nswvic7,2),new.order))
  if(i==1) {write.table(temp,file="bt_zvalues_nswvic_7y.txt",row.names=F)
            } else
              {write.table(temp,file="bt_zvalues_nswvic_7y.txt",append=T,row.names=F,col.names=F)}
  zpq.values[i] <- length(subset(temp,temp>=1.645))/length(temp)
  znq.values[i] <- length(subset(temp,temp<=-1.645))/length(temp)
}
proc.time()-ptm

write.table(zpq.values,file="bt_outp_nswvic_7y.txt",row.names=F)
write.table(znq.values,file="bt_outn_nswvic_7y.txt",row.names=F)


bt4_nswp.values <- unlist(read.table("bt_outp_nswvic_7y.txt",header=T,sep=""))*100
bt4_nswn.values <- unlist(read.table("bt_outn_nswvic_7y.txt",header=T,sep=""))*100

bt4_qldp.values <- unlist(read.table("bt_outp_qld_7y.txt",header=T,sep=""))*100
bt4_qldn.values <- unlist(read.table("bt_outn_qld_7y.txt",header=T,sep=""))*100

jpeg("../../figures/bt4_hist.jpg")
par(mfrow=c(1,2), mar = c(4,3,2,1)+0.1)
# nsw pos
hist(bt4_nswp.values,nclass=100,xlab="% positive Z'",main="NSW/VIC",cex.lab=1.4,cex.main=1.3) #xlim=c(0,20))
points(nsw_origp.z.new7*100,0,pch=16,col="red",cex=1.8)
# # nsw neg
# hist(bt4_nswn.values,nclass=100,xlab="% negative Z'",main="",cex.lab=1.4,cex.main=1.3, xlim=c(0,20))
# points(nsw_orign.z.new7*100,0,pch=16,col="red",cex=1.8)
#qld pos
hist(bt4_qldp.values,nclass=100,xlab="% positive Z'",main="Qld",cex.lab=1.4,cex.main=1.3) #xlim=c(0,20))
points(qld_origp.new_7y*100,0,pch=16,col="red",cex=1.8)
#qld neg
# hist(bt4_qldn.values,nclass=100,xlab="% negative Z'",main="",cex.lab=1.4,cex.main=1.3, xlim=c(0,20))
# points(qld_orign.new_7y*100,0,pch=16,col="red",cex=1.8)
dev.off()


```

Results
===========

## Tree cover change

The pixels, where the tree cover change based on the MOD44B data was significant ($p \leq 0.05$) in each study region, are shown in Figure \@ref(fig:tctrend) for the time series to 2009 (left panels) and the time series to 2015 (right panels). In both cases it can be seen that the area of negative cover change was greater in the series to 2009 than in the series to 2015. But even the longer series indicates a large change in the NSW/VIC region (bottom row). In the NSW/VIC region, much of the tree loss between 2002 and 2003 was concentrated in the Snowy Mountains close to the border of NSW and VIC. Tree cover loss occurred in large parts of the QLD region between 2002 and 2005, but this tree loss was spatially less concentrated. Most of the clearings appear in the centre of this region in the series to 2009. The tree cover change map (\@ref(fig:tctrend) is consistent with the annual mean EVI trend map (based on DLCD data, not shown here). However in the series to 2015 the tree cover loss seems to have dissappeared (top right Figure \@ref(fig:tctrend)) and suggests an increase in tree cover over the area. The implications of this will be discussed in more detail in the discussion.

```{r tctrend, fig.cap ="The maps show signifcant changes in tree cover identified from the MOD44B data between 2003 and 2009 (top left) and 2003 and 2015 (top right) in the NSW/VIC region and the Qld region (bottom left to 2009 and bottom right to 2015). The amount of change was calculated as the difference in tree cover before and after the specified land cover intervention and it is shown as the percentage of the ground area. Green colour indicates an increase in tree cover, while red colour indicates a decrease in tree cover.", echo=F, out.width="90%"}
include_graphics("figures/tc_figs.jpg")
```


<!-- ```{r tc_trend, fig.cap="The maps show signifcant changes in tree cover identified from the MOD44B data between 2003 and 2009 (top left) and 2003 and 2015 (top right) in the NSW/VIC region and the Qld region (bottom left to 2009 and bottom right to 2015). The amount of change was calculated as the difference in tree cover before and after the specified land cover intervention and it is shown as the percentage of the ground area. Green colour indicates an increase in tree cover, while red colour indicates a decrease in tree cover.", echo=F, out.width="90%"} -->

<!-- include_graphics("figures/tc_figs.jpg") -->
<!-- ``` -->

## Regression Model and significance of Vegetation Cover Changes

Generally the regression model only explains a limited amount of the rainfall variability. The model in Equation \@ref(eq:model2) accounts for around 15\%\footnote{Here the adjusted $R^2$ was reported. Adjusted $R^2$ is the coefficient of determination, a measurement of the amount of variability predicted by the model adjusting for the number of explanatory terms} of the rainfall variation in both regions. The residual analysis shows that the assumptions of the regression model are generally met (Figure \@ref(fig:residuals). The standardised residual plots, however, show some funnelling for the NSW/VIC regions, suggesting non constant variance. The residual patterns are consistent for all pixels within each region.

The model, however, confirms the importance of the climate drivers and the seasonality in Australian rainfall. Even at the grid level, the seasons and several of the climatic indices were significant ($p \leq 0.05$) everywhere in both regions. The explaining power of the model is mostly due to these variables. The climate drivers (at lag zero) accounted, on average, for 6.7\% of the rainfall variability in both the QLD region and the NSW/VIC region (see Figure \@ref(fig:rsq) for the distribution of $R^2$ in these two regions). These figures are within the upper bound of seasonal rainfall predictability by a SST anomaly field reported by [@Westra2010].

```{r residuals, fig.cap ="The residual analysis of a sample pixel in the QLD region (top) and NSW/VIC region (bottom).", echo=F, out.width="90%"}
include_graphics("figures/gam_check.jpg")
```

```{r rsq, fig.cap = "The performance of the regression model if rainfall is only modelled by the climate drivers. It shows the percentage of rainfall variability that can be explained by the climate drivers for the Qld and NSW/VIC region", echo=F, out.width="90%"}
include_graphics("figures/soi_explhistogram.jpg")

```


Statistically significant long term trends were only observed in part of the NSW region (results not shown). However, this result might prove or disprove the existence a long term trend in rainfall. The overall time period is fairly short [@Koutsoyiannis2007] and more pixels in NSW/VIC could indicate a significant step change if the long term trend effect is not removed by the model. As trend free data is an important requirement for the step trend test, the trend term was kept in the regression model to ensure the detection of step change was not due to a possible long term trend.

```{r LCp, fig.cap = "The spatial distribution of significance of land cover step change variable in the GAM model predicting changes in rainfall in the both regions. The top row reflects NSW/VIC, while the bottom relates to the Qld study site. The left hand plots are the data up to 2009, while the right hand plots are for the full series. The p value reported is for the land cover variable in the model.", echo=F, out.width="90%"}
include_graphics("figures/Cp_30yrs.jpg")
```

The land cover variable in the model (Equation \@ref(eq:model2)) aims to identify a step change in the rainfall before and after the observed change in land cover. The  variable was only significant ($p \leq 0.05$) for the rainfall estimates in some areas in NSW/VIC, as shown in Figure \@ref(fig:LCp). However, the number of pixels where the landcover variable was significant was much greater for the series up to 2009, compared to the series to 2015. There was no direct relationship between the areas of bushfires in Figure \@ref(fig:bushfire). No significant step change due to the land cover changes was found in rainfall in the QLD region in the series to 2015, but a small area of change was identified in the period to 2009 (left bottom panel).

Figure \@ref(fig:LCp) for NSW/VIC suggests that a significant step change in rainfall related to land cover change was found in an area larger than where the bushfires has occurred. This might be showing a large scale effect that reaches beyond the vegetation cover change effect.

More generally, the model suggests that the tree cover has a positive impact on rainfall in both regions. The fitted coefficients for the Land cover change variable were consistently positive for the "tree" part of the series. It implies that rainfall was higher when the surface was covered by trees.

## Step Trend Test

```{r steptest30, fig.cap="Spatial distribution of the step trend test Z' statistics in the two study sites. Panels on the top are for the NSW/Vic site, while panels of the bottom ar for Qld. The left panels are for the series to 2009, while the right panels are for the full data series. Warm colours (yellow, orange and red) are for positive Z' values which indicate decreasing rainfall trend due to the land surface intervention. Cold colours (light blue to blue) are for negative Z' values which indicate increasing rainfall trend. The deeper the colour, the more significant the statistic.", echo = F, out.width="90%"}
include_graphics("figures/step_new.jpg")
```

The spatial step trend test Z' scores for the Qld region (top row) and NSWVIC region (bottom row)  are shown in Figure \@ref(fig:steptest30). The figure also contains the period to 2009 (left panels) and the period to 2015 (right panels). This figure provides two types of information: the sign and the significance level. The sign indicates the direction of the step change, as listed in Table \@ref(Zscore). In each region up to 2009, there is a broad area of positive Z' values which implies a decrease in rainfall. There appears to be little relationship between the locations where changes in tree cover are observed (Figure \@ref(fig:tc_trend)) and the patterns in the Z' score. However, there is not necessarily a direct relationship as movement of air masses could mean that actual changes of rainfall are observed close by, but not necessarily exactly at areas with changes of landcover.
There is once again a difference between the left panels and the right panels, indicating that considering a longer time series (to 2015) reduces the pattern and significance of Z' scores. In the QLD region to 2009, 21\% of the pixels obtained a positive Z' score with p $<$ 0.1, and for the period to 2015 no pixels with positive Z' score at p $<$ 0.1 occurred. In the NSW/VIC region to 2009,  only 2.6\% of pixels in the alpine area having a positive Z' score with p $<$ 0.1. In general it is only a small proportion of both study regions.

```{r meandiff, fig.cap ="Boxplots of annual rainfall residuals (estimated based on Equation 2 before and after the land cover intervention during 1979 - 2015 in the study regions. On average, the after period has a significantly lower annual rainfall residual in NSW/VIC, but a signifcantly higher annual rainfall residual in the Qld study area", echo=F, out.width="90%"}

include_graphics("figures/ResidualBoxplotchange.jpg")
```

The rainfall residuals of the two periods (before-change since 1979 and after-change) were also compared (Figure \@ref(fig:meandiff)) using a simple t-test. From the boxplots it is difficult to see that there were significantly different ($p < 0.05$) mean values between the "before" and "after" periods in both regions.  For the Queensland locations, there was no significant difference if measured to 2009 and slightly less rain ($p < 0.05$) before if measured to 2015 ($~ 2 mm/month$). In contrast, for the NSW/VIC locations there was also slightly more rain ($p < 0.05$) after the change if measured to 2015 ($~ 1 mm/month$), but significantly less rain ($p < 0.05$) after the change ($~ 9 mm/month$) if measured to 2009.

```{r dif_mean, echo=F, eval=F}
## calculate mean rainfall difference in two periods up to 2010
## and up to 2015
# exclude 2010 and 2006
# First across all the data (repeat of earlier t-test)

resQld <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  filter(year(Date) < 2010 & year(Date) != 2006) %>%
  filter(State == "QLD")

  t.test(formula=residuals~Change,data=resQld)

# no difference to 2015
# data:  residuals by Change
# t = 0.47233, df = 486360, p-value = 0.6367
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.1436579  0.2348813
# sample estimates:
#  mean in group After mean in group Before
#            -1.287096            -1.332708

# Qld to 2009 more rain after  (2 mm/month)
# data:  residuals by Change
# t = 24.139, df = 348950, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  2.574463 3.029469
# sample estimates:
#  mean in group After mean in group Before
#             1.469258            -1.332708



resNSW <- resplot_df %>%
  filter(Date >= ymd("1998-01-01")) %>%
  mutate(Change = ifelse(year(Date) > 2003, "After", "Before")) %>%
  filter(year(Date) < 2010 & year(Date) != 2006) %>%
  filter(State != "QLD")

  t.test(formula=residuals~Change,data=resNSW)
# NSW to 2015 Before less rain (about 2 mm/month)
#   data:  residuals by Change
# t = 12.092, df = 217850, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  1.776336 2.463545
# sample estimates:
#  mean in group After mean in group Before
#            -2.034961            -4.154902

# NSW to 2009 : Less rain After
#  data:  residuals by Change
# t = -28.481, df = 161480, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -5.698085 -4.964340
# sample estimates:
#  mean in group After mean in group Before
#            -9.486115            -4.154902


# Only need to do this for pos Z score (decrease in rainfall)

# full period
  sel_neg.qld <- residual_qld[which(values(tr_qld.step.new)>=1.645)]
  sel_neg_df <- data_frame(Date = rep(ymd(paste(nsw_30[[1]],
                                              "01", sep="-")),
                        length(sel_neg.qld)),
                          residuals = unlist(sel_neg.qld),
                        pixel = rep(1:length(sel_neg.qld), each = 444))

  data.qld <- sel_neg_df %>%
    group_by(year = year(Date), pixel = pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
  # rearrange
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))

  # shorter period to 2010
  sel_neg.qld_7y <- residual_qld_7y[which(values(tr_qld.step.new7)>=1.645)]
  sel_neg_df_7y <- data_frame(Date = rep(ymd(paste(nsw_30[[1]][1:372],
                                              "01", sep="-")),
                        length(sel_neg.qld_7y)),
                          residuals = unlist(sel_neg.qld_7y),
                        pixel = rep(1:length(sel_neg.qld_7y), each = 372))

  data.qld_7y <- sel_neg_df_7y %>%
    group_by(year = year(Date), pixel=pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))



# NSW/VIC full period no pixels at p < 0.1
  # sel_neg.nswvic <-
  #   residual_nswvic[which(values(tr_nswvic.step.new)>=1.645)]
  # sel_neg_df <- data_frame(Date = rep(ymd(paste(nsw_30[[1]],
  #                                             "01", sep="-")),
  #                       length(sel_neg.nswvic)),
  #                         residuals = unlist(sel_neg.nswvic),
  #                       pixel = rep(1:length(sel_neg.nswvic), each = 444))
  #
  # data.nswvic <- sel_neg_df %>%
  #   group_by(year = year(Date), pixel = pixel) %>%
  #   summarise(an_residual = sum(residuals)) %>%
  # # rearrange
  #   filter(year > 1997) %>%
  #   mutate(group = ifelse(year < 2003,"1before","2after"))

# NSW/VIC shorter period to 2010
  sel_neg.nswvic_7y <-
    residual_nswvic7[which(values(tr_nswvic.step.new7)>=1.645)]
  sel_neg_df_7y <- data_frame(Date = rep(ymd(paste(nsw_30[[1]][1:372],
                                              "01", sep="-")),
                        length(sel_neg.nswvic_7y)),
                          residuals = unlist(sel_neg.nswvic_7y),
                        pixel = rep(1:length(sel_neg.nswvic_7y), each = 372))

  data.nswvic_7y <- sel_neg_df_7y %>%
    group_by(year = year(Date), pixel = pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
  # rearrange
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))



# Qld full period
## perform a 2 sample t test
  var.test(unlist(data.qld[data.qld$group=="1before","an_residual"]),
           unlist(data.qld[data.qld$group=="2after" &
                      data.qld$year!=2006 &
                      data.qld$year!=2010 ,3]),alternative="two.sided")
## equal variance p = 0.1802
  t.test(unlist(data.qld[data.qld$group=="1before","an_residual"]),
           unlist(data.qld[data.qld$group=="2after" &
                      data.qld$year!=2006 &
                      data.qld$year!=2010  ,3]),alternative="greater")
## p = 0.1702

# Qld shorter period
## perform a 2 sample t test
  var.test(unlist(data.qld_7y[data.qld_7y$group=="1before","an_residual"]),
           unlist(data.qld_7y[data.qld_7y$group=="2after" &
                      data.qld_7y$year!=2006 &
                      data.qld_7y$year!=2010 ,3]),alternative="two.sided")
## unequal variance p < 0.05
  t.test(unlist(data.qld_7y[data.qld_7y$group=="1before","an_residual"]),
           unlist(data.qld_7y[data.qld_7y$group=="2after" &
                      data.qld_7y$year!=2006 &
                      data.qld_7y$year!=2010,3]),alternative="greater")
## p < 0.05
#   sample estimates:
# mean of x mean of y
#  25.38161  11.14015

# NSW only shorter period
## perform a 2 sample t test
  var.test(unlist(data.nswvic_7y[data.nswvic_7y$group=="1before",
                                 "an_residual"]),
           unlist(data.nswvic_7y[data.nswvic_7y$group=="2after" &
                      data.nswvic_7y$year!=2006 &
                      data.nswvic_7y$year!=2010 ,3]),alternative="two.sided")
## unequal variance p = 0.0543
  t.test(unlist(data.nswvic_7y[data.nswvic_7y$group=="1before",
                               "an_residual"]),
           unlist(data.nswvic_7y[data.nswvic_7y$group=="2after" &
                      data.nswvic_7y$year!=2006 &
                      data.nswvic_7y$year!=2010,3]),alternative="greater")
## p < 0.05
# sample estimates:
# mean of x mean of y
#  49.92258 -51.18393

### REPEAT FOR THE REVERSE ###----------------------------------
  # full period
  sel_neg.qld <- residual_qld[which(values(tr_qld.step.new)<1.645)]
  sel_neg_df <- data_frame(Date = rep(ymd(paste(nsw_30[[1]],
                                              "01", sep="-")),
                        length(sel_neg.qld)),
                          residuals = unlist(sel_neg.qld),
                        pixel = rep(1:length(sel_neg.qld), each = 444))

  data.qld <- sel_neg_df %>%
    group_by(year = year(Date), pixel = pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
  # rearrange
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))

  # shorter period to 2010  ## repeat for reverse
  sel_neg.qld_7y <- residual_qld_7y[which(values(tr_qld.step.new7)<1.645)]
  sel_neg_df_7y <- data_frame(Date = rep(ymd(paste(nsw_30[[1]][1:372],
                                              "01", sep="-")),
                        length(sel_neg.qld_7y)),
                          residuals = unlist(sel_neg.qld_7y),
                        pixel = rep(1:length(sel_neg.qld_7y), each = 372))

  data.qld_7y <- sel_neg_df_7y %>%
    group_by(year = year(Date), pixel=pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))


## REPEAT FOR REVERSE NSW -----------------------
# NSW/VIC full period no pixels at p < 0.1
  # sel_neg.nswvic <-
  #   residual_nswvic[which(values(tr_nswvic.step.new)>=1.645)]
  # sel_neg_df <- data_frame(Date = rep(ymd(paste(nsw_30[[1]],
  #                                             "01", sep="-")),
  #                       length(sel_neg.nswvic)),
  #                         residuals = unlist(sel_neg.nswvic),
  #                       pixel = rep(1:length(sel_neg.nswvic), each = 444))
  #
  # data.nswvic <- sel_neg_df %>%
  #   group_by(year = year(Date), pixel = pixel) %>%
  #   summarise(an_residual = sum(residuals)) %>%
  # # rearrange
  #   filter(year > 1997) %>%
  #   mutate(group = ifelse(year < 2003,"1before","2after"))

# NSW/VIC shorter period to 2010
  sel_neg.nswvic_7y <-
    residual_nswvic7[which(values(tr_nswvic.step.new7)<1.645)]
  sel_neg_df_7y <- data_frame(Date = rep(ymd(paste(nsw_30[[1]][1:372],
                                              "01", sep="-")),
                        length(sel_neg.nswvic_7y)),
                          residuals = unlist(sel_neg.nswvic_7y),
                        pixel = rep(1:length(sel_neg.nswvic_7y), each = 372))

  data.nswvic_7y <- sel_neg_df_7y %>%
    group_by(year = year(Date), pixel = pixel) %>%
    summarise(an_residual = sum(residuals)) %>%
  # rearrange
    filter(year > 1997) %>%
    mutate(group = ifelse(year < 2003,"1before","2after"))



# Qld full period Repeat for reverse
## perform a 2 sample t test
  var.test(unlist(data.qld[data.qld$group=="1before","an_residual"]),
           unlist(data.qld[data.qld$group=="2after" &
                      data.qld$year!=2006 &
                      data.qld$year!=2010 ,3]),alternative="two.sided")
## equal variance p = 0.1802
  t.test(unlist(data.qld[data.qld$group=="1before","an_residual"]),
           unlist(data.qld[data.qld$group=="2after" &
                      data.qld$year!=2006 &
                      data.qld$year!=2010  ,3]),alternative="greater")
## p < 0.05
 #  sample estimates:
 # mean of x  mean of y
 # -8.978994 -18.078116

# Qld shorter period repeat for reverse
## perform a 2 sample t test
  var.test(unlist(data.qld_7y[data.qld_7y$group=="1before","an_residual"]),
           unlist(data.qld_7y[data.qld_7y$group=="2after" &
                      data.qld_7y$year!=2006 &
                      data.qld_7y$year!=2010 ,3]),alternative="two.sided")
## unequal variance p < 0.05
  t.test(unlist(data.qld_7y[data.qld_7y$group=="1before","an_residual"]),
           unlist(data.qld_7y[data.qld_7y$group=="2after" &
                      data.qld_7y$year!=2006 &
                      data.qld_7y$year!=2010,3]),alternative="greater")
## p = 1

# NSW only shorter period
## perform a 2 sample t test
  var.test(unlist(data.nswvic_7y[data.nswvic_7y$group=="1before",
                                 "an_residual"]),
           unlist(data.nswvic_7y[data.nswvic_7y$group=="2after" &
                      data.nswvic_7y$year!=2006 &
                      data.nswvic_7y$year!=2010 ,3]),alternative="two.sided")
## unequal variance p = 0.0543
  t.test(unlist(data.nswvic_7y[data.nswvic_7y$group=="1before",
                               "an_residual"]),
           unlist(data.nswvic_7y[data.nswvic_7y$group=="2after" &
                      data.nswvic_7y$year!=2006 &
                      data.nswvic_7y$year!=2010,3]),alternative="greater")
## p < 0.05
# sample estimates:
#  mean of x  mean of y
#   8.792574 -15.508618




```

A closer look at the rainfall data indicates that rainfall was consistently very low in 2006 for both regions and consistently high for 2010 \@ref(fig:ts-mean). The low rainfall in 2006 was due to a weak El Niño and unrecovered conditions from the previous drought, in contrast, 2010 brough record drought breaking rains across Eastern Australia related to a La Niña [@vanDijk2013]. While the regression model has removed most of the effect of ENSO, the effect of these anomolous years could still be visible in the residuals if the response of the rainfall to the ENSO effect is non-linear, and for example the memory of the past drought is persistent.
This can also explain the significant results in the previous method. To remove the possible outlier effects from 2006 and 2010, the two periods were compared excluding the 2006 and 2010 rainfall. In addition, the group of pixels showing a negative step change in rainfall ($p < 0.10$) and the group of pixels indicating no change were analysed separately for the period to 2009. An unpaired unequal variance two sample t-test was applied to test whether the after period had lower mean rainfall than the before period, excluding the 2006 and 2010 years for the full period, and excluding 2006 for the period to 2009.

For the Queensland locations using the regression model residuals and excluding 2006 and 2010, there was no difference between the period before and after the landuse change for the full data series. However for the period to 2009, there is slightly more rain ($p < 0.05, ~ 2mm/month$) before than after the change. For the NSW/VIC locations for the same analyses, there is slightly more rain ($p < 0.05$) after the change if measured to 2015 ($~ 2 mm/month$), and for the period to 2009 there is still significantly less rain ($p < 0.05, ~ 5 mm/month$).
Focussing on the pixels with a negative step change (positive significant Z' score) and the monthly rainfall totals, only the period to 2009 is of interest, as the full period had too few significant pixels (\@ref(fig:steptest30)). For both regions and excluding 2006, the Qld area had significantly more rain before than after at $p < 0.05$. For the NSW/VIC area, there was similarly significantly more rain before than after the change ($p < 0.05 and 100mm/month$).
For pixels where the Z' score was not significantly positive ($p > 0.1$ and Z' score negative), the Qld area showed no  significant difference in monthly rainfall totals before and after. For the NSW/VIC area there was still significantly less rain after the change ($p < 0.05$) but difference in monthly rainfall totals was smaller than for positive and signifcant Z' scores: 24 mm/month less.

The choice of $ns$ has some impact on the test results [@Hirsch1985]. The cases of $ns = 1$ and $ns = 9$ were also tested. The results for $ns = 1$ showed a lower number of significant pixels(at p $<$ 0.10) compared to the $ns = 4$ test, with only 66 pixels in the Queensland area in the period to 2010 and a slightly higher 6 pixels in the period to 2015. No pixels were significant at p $<$ 0.1 in the NSW/VIC area. The results from the $ns = 9$ test was not different from the $ns = 4$ test. The power of the test does not change much after $ns = 4$, as shown by @Hirsch1985.

As part of the analysis, the "field significance" of the Z' score test was considered to better interpret the step change at regional scales from multiple local tests [@Wilks2006, @Westra2013]. Here, the bootstrapping resampling method from @Westra2013 was used to evaluate the field significance for the period up to 2009 (as the period to 2015 essentially showed no significant positive Z' scores). This means the spatial structure of the pixels was maintained, but the order of the years and months was changed by random resampling. For each resampling the test statistics identifies the percentage of the pixels with significant positive step change for the step trend test. The test statistics on 1000 resampled replicates were used to develop the distribution of these percentage values under the local null hypothesis that there was no step change. The results showed that none of the resampled series indicated any significant step trend for both regions, suggesting that the actual values found are for a unique series of years.

Discussion
=============

```{r summarytable, echo=F, message=F}
library(kableExtra)

table <- read_csv("TestSummaryTable2.csv")
kable(table,caption="Summary table of all tests on the two regions and for the two time periods", format = "latex", booktabs =TRUE) %>%
  kable_styling(latex_options = "scale_down")#%>%
  #kableExtra::landscape()
```

Overall the summary table of the results indicates that the effects of land clearing or bushfire on rainfall are not easily detected, even with a range of different statistical tests. In addition several of the tests appear to indicate contradictory results, in particular in the comparison between the two regions and between the two time periods.

Generally, empirical studies on LCC-precipitation interaction are conducted within an area with known land surface intervention [e.g. @Otterman1990,@Durieux2003,@Negri2004,@Sato2007]. However, these locations are rare and difficult to isolate from real landscape change. Modelling studies are abundant, but are generally not linked to observed data. In this study we therefore tested the effect of land cover change across a broad region, rather than only for locations where changes were known to occur or have occured. The advantage of the suggested approach is that it does not require a long time series of land cover data as this is usually unavailable. Furthermore, it does not assume a specific relationship between vegetation cover change and rainfall but allows the data to show this relationship, by applying the analysis to a broader area outside the boundary of the vegetation cover change. This approach is expected to provide a way to reduce the risk of a false positive paradox, by comparing results between areas with and without vegetation cover change.

While there is some indication that the observed landuse changes (Figure \@ref(fig:tctrend)) cause a decrease in the rainfall, our analysis has not been able to give an unequivocal answer. There are several possible complicating fatcors in the data that could explain the differences between the two regions and the two time periods.

## Rainfall variability

The first and most significant effect on the results remains the variability in the rainfall. The regression model used here is a simple model. We only consider the important effects of a historical trend, seasonality and climate drivers. The purpose of using the regression model is to remove the year to year and month to month variability in rainfall and therefore strengthen the land cover signal in the residuals. However, the model shows that trend, seasonality, ENSO and IOD together explain no more than 30\% of the rainfall variability, and only around 7\% on average is due to the climate drivers (Figure \@ref(fig:rsq) . And while this is consistent with the literature e.g. @Westra2010, a large amount of variation is left in the model residuals. Rainfall is generally considered a stochastic process [e.g. @Fowler2005,@Cowpertwait2009,@Burton2010] and clearly some of the variability is either a different response to a combination of climate factors (as interactions were not tested in the model), or a strongly non-stationary response to the climate drivers. The remaining variability in the residuals increases the difficulty to detect a change in rainfall. This is clearly demonstrated in the difference in land cover variable significance and the Z' score between the series to 2009 and the series to 2015. While 2009 was at the end of the drought, the series to 2015 includes the record breaking year 2010 (Figure \@ref(fig:ts-mean)).

The severe bushfires in 2003 were also triggered by the extreme drought conditions during the millenium drought [@vanDijk2013]. Although the drought on rainfall has been accounted for in part by the model, a further delayed or cumulative impact of drought could be feeding into the local land-atmosphere interaction. As a result, the rainfall feedback to the vegetation cover change could be weak under the dry conditions, and this could have affected the result.

## Vegetation dynamics

The second possible effect is the dynamic nature of the vegetation clearing and recovery. Although land clearing has occurred at a high rate and broad scale in Queensland [@SLATS2017], the clearing does not have a clear start and end point. QLD has a long history of land clearing. According to the series of SLATS reports on land cover changes in QLD released by the Queensland government, land clearing continued in and around the study region between 1988 - 2008. Major broad scale and high rate clearings occurred in 1999 - 2000 and 2002 - 2004 (Figure \@ref(fig:slat)). And even though there was a decrease in land clearing post 2005, it is difficult to define a clear cut change in this region. The more continuous ongoing land clearing could have reduced the significance of a step change.

```{r slat, fig.cap="Woody vegetation clearing rate in QLD for the two major bioregions in the study area. The data were obtained from SLATS (2017), and clearly indicate a sharp decrease in the clearing rate after 2005.", echo=F, out.width="90%"}
include_graphics("figures/slats.jpg")
```

The two approaches used in this study indicate quite different results on the level of change in the NSW/VIC region. The regression model showed that a large area in the NSW/VIC region has experienced a significant land cover effect ($p < 0.05$) on the rainfall after 2003. The effect in the step trend test (Z' scores) is much mroe subdued, even though it was able to detect significant changes ($p < 0.1$) within the area in the period to 2009, but almost no effect in the period to 2015. In contrast, the results are almost reversed in the Qld area. While some of this could be due to the difficulty in removing year on year rainfall variability, some of this might also be due to vegetation regrowth in both locations.

The specific vegetation class in the Queensland area is well-known for rapid regrowth and "thickening" in favourable conditions [@Gowen2016], and this could explain the change in vegetation cover between 2009 and 2015 in the Qld area (Figure \@ref(fig:tctrend)). In particular the favourable rainfall years of 2010 and 2011 would have boosted regrowth, increasing evapotranspiration and therefore decreasing the effect of the rainfall change.

The different causes of vegetation cover change in these two regions could lead to different post-change characteristics. The magnitude of EVI decreasing trends in the QLD region are less than in NSW region, as reported in the DLCD data. This is due to the lower tree density in the QLD region than in the NSW/VIC region before land surface interventions. The significant bushfires (Figure \@ref(fig:fig2bushfire)) would have drastically reduced the vegetation cover and recovery was very slow in some areas within the NSW/VIC area. The persistent drought in the 2000s [@Howden2012,@vanDijk2013] delayed the regrowth of trees. On the other hand, replacing tree cover with pasture and crops in the Qld area might have a relatively subtle impact on the EVI.

## Misalignment rainfall effects and vegetation clearing

Particularly in the NSW/VIC area, there is no direct overlap between the pixels with significant vegetation change (Figure \@ref(fig:tctrend)) and the pixels with significant land cover variables or positive Z'scores (Figure \@ref(fig:LCp) and Figure \@ref(fig:steptest30)). While this seems possibly surprising at first, a plausible explanation could be the general movement of moisture and climate systems over the landscape, resulting in a possible shift of where the moisture is evaporated and where rainfall occurs. Specifically for this reason, this study selected rather large spatial boxes to capture the overall response rather than the pixel by pixel comparison/

## Gridded monthly rainfall data

The rainfall data used in this study is a gridded data set. This data set is robust and consistent over a long time series (from 1900 to current) and has a broad national wide coverage which can provide more information spatially. However, high cross correlation between pixels, due to the interpolation method generating this data set, can also introduce spatial noise. In the step trend test the cross correlation was accounted for. Some other methods are also available which can be used to perform a comparative trial. For example, [@Narisma2007] applied a spatial Gaussian filter on a similar data set and used wavelet analysis to detect step change in rainfall. High quality station data is another option to test whether the observed spatial pattern in the step trend test results was not due to the gridded data itself. Resampling methods, such as bootstrapping and permutation [@Wilks1997,@Kundzewicz2004,@Westra2013], can also be used to further assess the strength of significance of results and incorporate spatial and temporal patterns in the analysis. While the gridded data set is most useful in regions with sparse rain gauge networks, it can actually reduces information where the rain gauge density is high [@Jones2009]. In the NSW/VIC area, the coverage of rainfall stations is more intensive but they are mainly located in the valleys. The interpolated data might not be the best represention of the local rainfall.

<!-- To discuss:   -->

<!-- * Post-fire revegetation and restoration activities in ACT could have reduced the significance of the difference in tree cover before and after the bushfires. It is an indication that deforestation might cause a step change in rainfall but reforestation could take a long time to show effects. Regrowth in Qld and increase in clearing again (Figure \@ref(fig:slat)).    -->
<!-- * Rainfall variation and anomalous years 2006 and 2010.   -->
<!-- * misalingment rainfall change and clearing  -->
<!-- * gridded rainfal    -->
<!-- * general approach   -->

## General approach

Parametric tests are generally more powerful than nonparametric test in detecting a trend, when the data is normally distributed [@Onoz2003,@Kundzewicz2004]. As a non-parametric test, the step trend test has the advantages of distribution free and having no restriction on missing data [@Hirsch1985]. This is particularly useful in rainfall analysis since rainfall data is usually skewed. On the other hand, the disadvantages of non-parametric tests, such as being limited to hypothesis testing and weaker in power, also hold for the step trend test [@Whitley2002].

Overall, the current study provides a clear approach build on several lines of evidence to provide some evidence to reject the null hypothesis (no step change in rainfall occurs as a result of tree cover loss). Limited by the available data, the time frame under study was chosen to include a long lasting drought period [@Holper2011, @vanDijk2013]. The strong impact of this prolonged drought might have suppressed the land-atmosphere interaction and confused the cause and effect relation between rainfall and vegetation cover change. This could be one of the reasons that the LCC effects on the local climate found in other studies [e.g. @Gorgen2006,@McAlpine2007] are not found to be significant here.
Possible future work could focus on a non-drought period, or when a longer series of land cover data is available. Wile the power of the test can be improved with the longer length of the after-intervention period [@Hirsch1985], the dynamic nature of vegetation regrowth in this case study prevents this effect.
A better approach might be to build a global study that investigates multiple locations where drastic landcover changes have taken place, which would also remove some of the climate variability effects due to the larger sample size.

Conclusions
===========

In this study, we present an approach to identify iffound some observationl data based evidence, although not strong, that vegetation cover change has changed local rainfall. The semi-parametric method and non-parametric method did totally agree on detecting a significant step change in rainfall in the hot dry QLD region where land clearing has occurred. On the other hand, the bushfires in the humid, temperate mountain range in the NSW/VIC region has experienced reduced rainfall. But the dry spell also plays an important role in the results.

Drought has had a pronounced impact on the land surface condition during the study period, leading to significant reduction in vegetation and extreme events such as bushfires. The associated lack of rainfall and high temperatures may mask the step change in the vegetation. Hence, the signal of LCC feedback on rainfall is probably weaker under such regional dry conditions, as the impact of LCC on rainfall is mainly through changes in moisture convergence [@Gorgen2006,@Pitman2007].

acknowledgments
===============
CL was supported by an Australian Postgraduate Award for this work.

\newpage
appendix
==============

## Summary of Data

<!--  \begin{sidewaystable} -->
<!--  \caption{Summary of data.} -->
<!--   \label{tab:ch3Data} -->
<!--  \begin{tabular}{lllll} -->
<!--   \hline -->
<!--   \textbf{Data} & \textbf{Source} & \multicolumn{2}{c}{\textbf{Resolution}} & \textbf{Analysis period} \\\cline{3-4} -->
<!--   & & Temporal & Spatial & \\\hline -->
<!--   Percent tree cover & MOD44B & Annual &	250m & 2000-2010\\ -->
<!--   Trend of vegetation cover change  &	DLCD (2009)	& Onetime & 250m	& Trend of Apr 2000 - Apr 2008\\ -->
<!--   Rainfall &	AWAP gridded rainfall data &	Monthly &	0.05\textdegree$\times$0.05\textdegree & Jan 1979- Dec 2008\\ -->
<!--   SOI	& BoM	& Monthly &	N/A &	Jan 1979- Dec 2008\\ -->
<!--   NINO 3, 3.4, 4 &	IRI/LDEO data library	& Monthly	& N/A	& Jan 1979- Dec 2008\\ -->
<!--   PDO	& NOAA & Monthly	& N/A	& Jan 1979- Dec 2008\\ -->
<!--   IOD	& POAMA-2 dataset	& Monthly	& N/A	& Jan 1979- Dec 2008\\ -->
<!--   \hline -->
<!--   \end{tabular} -->
<!-- \end{sidewaystable} -->

\newpage

References {#references .unnumbered}
==========
